function e(e,t,n,r,s,o){return{tag:e,key:t,attrs:n,children:r,text:s,dom:o,domSize:void 0,state:void 0,events:void 0,instance:void 0}}e.normalize=function(t){return Array.isArray(t)?e("[",void 0,void 0,e.normalizeChildren(t),void 0,void 0):null==t||"boolean"==typeof t?null:"object"==typeof t?t:e("#",void 0,void 0,String(t),void 0,void 0)},e.normalizeChildren=function(t){var n=[];if(t.length){for(var r=null!=t[0]&&null!=t[0].key,s=1;s<t.length;s++)if((null!=t[s]&&null!=t[s].key)!==r)throw new TypeError("Vnodes must either always have keys or never have keys!");for(s=0;s<t.length;s++)n[s]=e.normalize(t[s])}return n};var t=e,n=function(){var e,n=arguments[this],r=this+1;if(null==n?n={}:("object"!=typeof n||null!=n.tag||Array.isArray(n))&&(n={},r=this),arguments.length===r+1)e=arguments[r],Array.isArray(e)||(e=[e]);else for(e=[];r<arguments.length;)e.push(arguments[r++]);return t("",n.key,n,e)},r=/(?:(^|#|\.)([^#\.\[\]]+))|(\[(.+?)(?:\s*=\s*("|'|)((?:\\["'\]]|.)*?)\5)?\])/g,s={},o={}.hasOwnProperty;function i(e){for(var t in e)if(o.call(e,t))return!1;return!0}function a(e){for(var t,n="div",o=[],i={};t=r.exec(e);){var a=t[1],l=t[2];if(""===a&&""!==l)n=l;else if("#"===a)i.id=l;else if("."===a)o.push(l);else if("["===t[3][0]){var c=t[6];c&&(c=c.replace(/\\(["'])/g,"$1").replace(/\\\\/g,"\\")),"class"===t[4]?o.push(c):i[t[4]]=""===c?c:c||!0}}return o.length>0&&(i.className=o.join(" ")),s[e]={tag:n,attrs:i}}function l(e,n){var r=n.attrs,s=t.normalizeChildren(n.children),a=o.call(r,"class"),l=a?r.class:r.className;if(n.tag=e.tag,n.attrs=null,n.children=void 0,!i(e.attrs)&&!i(r)){var c={};for(var u in r)o.call(r,u)&&(c[u]=r[u]);r=c}for(var u in e.attrs)o.call(e.attrs,u)&&"className"!==u&&!o.call(r,u)&&(r[u]=e.attrs[u]);for(var u in null==l&&null==e.attrs.className||(r.className=null!=l?null!=e.attrs.className?String(e.attrs.className)+" "+String(l):l:null!=e.attrs.className?e.attrs.className:null),a&&(r.class=null),r)if(o.call(r,u)&&"key"!==u){n.attrs=r;break}return Array.isArray(s)&&1===s.length&&null!=s[0]&&"#"===s[0].tag?n.text=s[0].children:n.children=s,n}var c=function(e){if(null==e||"string"!=typeof e&&"function"!=typeof e&&"function"!=typeof e.view)throw Error("The selector must be either a string or a component.");var r=n.apply(1,arguments);return"string"==typeof e&&(r.children=t.normalizeChildren(r.children),"["!==e)?l(s[e]||a(e),r):(r.tag=e,r)};c.trust=function(e){return null==e&&(e=""),t("<",void 0,void 0,e,void 0,void 0)},c.fragment=function(){var e=n.apply(0,arguments);return e.tag="[",e.children=t.normalizeChildren(e.children),e};var u=c,f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function d(e){var t={exports:{}};return e(t,t.exports),t.exports}var h=function(e){if(!(this instanceof h))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var t=this,n=[],r=[],s=l(n,!0),o=l(r,!1),i=t._instance={resolvers:n,rejectors:r},a="function"==typeof setImmediate?setImmediate:setTimeout;function l(e,s){return function l(u){var f;try{if(!s||null==u||"object"!=typeof u&&"function"!=typeof u||"function"!=typeof(f=u.then))a((function(){s||0!==e.length||console.error("Possible unhandled promise rejection:",u);for(var t=0;t<e.length;t++)e[t](u);n.length=0,r.length=0,i.state=s,i.retry=function(){l(u)}}));else{if(u===t)throw new TypeError("Promise can't be resolved w/ itself");c(f.bind(u))}}catch(e){o(e)}}}function c(e){var t=0;function n(e){return function(n){t++>0||e(n)}}var r=n(o);try{e(n(s),r)}catch(e){r(e)}}c(e)};h.prototype.then=function(e,t){var n,r,s=this._instance;function o(e,t,o,i){t.push((function(t){if("function"!=typeof e)o(t);else try{n(e(t))}catch(e){r&&r(e)}})),"function"==typeof s.retry&&i===s.state&&s.retry()}var i=new h((function(e,t){n=e,r=t}));return o(e,s.resolvers,n,!0),o(t,s.rejectors,r,!1),i},h.prototype.catch=function(e){return this.then(null,e)},h.prototype.finally=function(e){return this.then((function(t){return h.resolve(e()).then((function(){return t}))}),(function(t){return h.resolve(e()).then((function(){return h.reject(t)}))}))},h.resolve=function(e){return e instanceof h?e:new h((function(t){t(e)}))},h.reject=function(e){return new h((function(t,n){n(e)}))},h.all=function(e){return new h((function(t,n){var r=e.length,s=0,o=[];if(0===e.length)t([]);else for(var i=0;i<e.length;i++)!function(i){function a(e){s++,o[i]=e,s===r&&t(o)}null==e[i]||"object"!=typeof e[i]&&"function"!=typeof e[i]||"function"!=typeof e[i].then?a(e[i]):e[i].then(a,n)}(i)}))},h.race=function(e){return new h((function(t,n){for(var r=0;r<e.length;r++)e[r].then(t,n)}))};var p=h,m=d((function(e){"undefined"!=typeof window?(void 0===window.Promise?window.Promise=p:window.Promise.prototype.finally||(window.Promise.prototype.finally=p.prototype.finally),e.exports=window.Promise):void 0!==f?(void 0===f.Promise?f.Promise=p:f.Promise.prototype.finally||(f.Promise.prototype.finally=p.prototype.finally),e.exports=f.Promise):e.exports=p})),g=function(e){var n,r=e&&e.document,s={svg:"http://www.w3.org/2000/svg",math:"http://www.w3.org/1998/Math/MathML"};function o(e){return e.attrs&&e.attrs.xmlns||s[e.tag]}function i(e,t){if(e.state!==t)throw new Error("`vnode.state` must not be modified")}function a(e){var t=e.state;try{return this.apply(t,arguments)}finally{i(e,t)}}function l(){try{return r.activeElement}catch(e){return null}}function c(e,t,n,r,s,o,i){for(var a=n;a<r;a++){var l=t[a];null!=l&&u(e,l,s,i,o)}}function u(e,t,n,s,o){var i=t.tag;if("string"==typeof i)switch(t.state={},null!=t.attrs&&F(t.attrs,t,n),i){case"#":!function(e,t,n){t.dom=r.createTextNode(t.children),O(e,t.dom,n)}(e,t,o);break;case"<":d(e,t,s,o);break;case"[":!function(e,t,n,s,o){var i=r.createDocumentFragment();if(null!=t.children){var a=t.children;c(i,a,0,a.length,n,null,s)}t.dom=i.firstChild,t.domSize=i.childNodes.length,O(e,i,o)}(e,t,n,s,o);break;default:h(e,t,n,s,o)}else!function(e,t,n,r,s){p(t,n),null!=t.instance?(u(e,t.instance,n,r,s),t.dom=t.instance.dom,t.domSize=null!=t.dom?t.instance.domSize:0):t.domSize=0}(e,t,n,s,o)}var f={caption:"table",thead:"table",tbody:"table",tfoot:"table",tr:"tbody",th:"tr",td:"tr",colgroup:"table",col:"colgroup"};function d(e,t,n,s){var o=t.children.match(/^\s*?<(\w+)/im)||[],i=r.createElement(f[o[1]]||"div");"http://www.w3.org/2000/svg"===n?(i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg">'+t.children+"</svg>",i=i.firstChild):i.innerHTML=t.children,t.dom=i.firstChild,t.domSize=i.childNodes.length,t.instance=[];for(var a,l=r.createDocumentFragment();a=i.firstChild;)t.instance.push(a),l.appendChild(a);O(e,l,s)}function h(e,n,s,i,a){var l=n.tag,u=n.attrs,f=u&&u.is,d=(i=o(n)||i)?f?r.createElementNS(i,l,{is:f}):r.createElementNS(i,l):f?r.createElement(l,{is:f}):r.createElement(l);if(n.dom=d,null!=u&&function(e,t,n){for(var r in t)$(e,r,null,t[r],n)}(n,u,i),O(e,d,a),!k(n)&&(null!=n.text&&(""!==n.text?d.textContent=n.text:n.children=[t("#",void 0,void 0,n.text,void 0,void 0)]),null!=n.children)){var h=n.children;c(d,h,0,h.length,s,null,i),"select"===n.tag&&null!=u&&function(e,t){if("value"in t)if(null===t.value)-1!==e.dom.selectedIndex&&(e.dom.value=null);else{var n=""+t.value;e.dom.value===n&&-1!==e.dom.selectedIndex||(e.dom.value=n)}"selectedIndex"in t&&$(e,"selectedIndex",null,t.selectedIndex,void 0)}(n,u)}}function p(e,n){var r;if("function"==typeof e.tag.view){if(e.state=Object.create(e.tag),null!=(r=e.state.view).$$reentrantLock$$)return;r.$$reentrantLock$$=!0}else{if(e.state=void 0,null!=(r=e.tag).$$reentrantLock$$)return;r.$$reentrantLock$$=!0,e.state=null!=e.tag.prototype&&"function"==typeof e.tag.prototype.view?new e.tag(e):e.tag(e)}if(F(e.state,e,n),null!=e.attrs&&F(e.attrs,e,n),e.instance=t.normalize(a.call(e.state.view,e)),e.instance===e)throw Error("A view cannot return the vnode it received as argument");r.$$reentrantLock$$=null}function m(e,t,n,r,s,o){if(t!==n&&(null!=t||null!=n))if(null==t||0===t.length)c(e,n,0,n.length,r,s,o);else if(null==n||0===n.length)C(e,t,0,t.length);else{var i=null!=t[0]&&null!=t[0].key,a=null!=n[0]&&null!=n[0].key,l=0,f=0;if(!i)for(;f<t.length&&null==t[f];)f++;if(!a)for(;l<n.length&&null==n[l];)l++;if(null===a&&null==i)return;if(i!==a)C(e,t,f,t.length),c(e,n,l,n.length,r,s,o);else if(a){for(var d,h,p,m,v,y=t.length-1,x=n.length-1;y>=f&&x>=l&&(p=t[y],m=n[x],p.key===m.key);)p!==m&&g(e,p,m,r,s,o),null!=m.dom&&(s=m.dom),y--,x--;for(;y>=f&&x>=l&&(d=t[f],h=n[l],d.key===h.key);)f++,l++,d!==h&&g(e,d,h,r,A(t,f,s),o);for(;y>=f&&x>=l&&l!==x&&d.key===m.key&&p.key===h.key;)S(e,p,v=A(t,f,s)),p!==h&&g(e,p,h,r,v,o),++l<=--x&&S(e,d,s),d!==m&&g(e,d,m,r,s,o),null!=m.dom&&(s=m.dom),f++,p=t[--y],m=n[x],d=t[f],h=n[l];for(;y>=f&&x>=l&&p.key===m.key;)p!==m&&g(e,p,m,r,s,o),null!=m.dom&&(s=m.dom),x--,p=t[--y],m=n[x];if(l>x)C(e,t,f,y+1);else if(f>y)c(e,n,l,x+1,r,s,o);else{var O,k,N=s,D=x-l+1,P=new Array(D),$=0,j=0,z=2147483647,I=0;for(j=0;j<D;j++)P[j]=-1;for(j=x;j>=l;j--){null==O&&(O=w(t,f,y+1));var _=O[(m=n[j]).key];null!=_&&(z=_<z?_:-1,P[j-l]=_,p=t[_],t[_]=null,p!==m&&g(e,p,m,r,s,o),null!=m.dom&&(s=m.dom),I++)}if(s=N,I!==y-f+1&&C(e,t,f,y+1),0===I)c(e,n,l,x+1,r,s,o);else if(-1===z)for($=(k=function(e){var t=[0],n=0,r=0,s=0,o=b.length=e.length;for(s=0;s<o;s++)b[s]=e[s];for(s=0;s<o;++s)if(-1!==e[s]){var i=t[t.length-1];if(e[i]<e[s])b[s]=i,t.push(s);else{for(n=0,r=t.length-1;n<r;){var a=(n>>>1)+(r>>>1)+(n&r&1);e[t[a]]<e[s]?n=a+1:r=a}e[s]<e[t[n]]&&(n>0&&(b[s]=t[n-1]),t[n]=s)}}n=t.length,r=t[n-1];for(;n-- >0;)t[n]=r,r=b[r];return b.length=0,t}(P)).length-1,j=x;j>=l;j--)h=n[j],-1===P[j-l]?u(e,h,r,o,s):k[$]===j-l?$--:S(e,h,s),null!=h.dom&&(s=n[j].dom);else for(j=x;j>=l;j--)h=n[j],-1===P[j-l]&&u(e,h,r,o,s),null!=h.dom&&(s=n[j].dom)}}else{var L=t.length<n.length?t.length:n.length;for(l=l<f?l:f;l<L;l++)(d=t[l])===(h=n[l])||null==d&&null==h||(null==d?u(e,h,r,o,A(t,l+1,s)):null==h?E(e,d):g(e,d,h,r,A(t,l+1,s),o));t.length>L&&C(e,t,l,t.length),n.length>L&&c(e,n,l,n.length,r,s,o)}}}function g(e,t,n,r,s,o){var i=t.tag;if(i===n.tag){if(n.state=t.state,n.events=t.events,function(e,t){do{var n;if(null!=e.attrs&&"function"==typeof e.attrs.onbeforeupdate)if(void 0!==(n=a.call(e.attrs.onbeforeupdate,e,t))&&!n)break;if("string"!=typeof e.tag&&"function"==typeof e.state.onbeforeupdate)if(void 0!==(n=a.call(e.state.onbeforeupdate,e,t))&&!n)break;return!1}while(0);return e.dom=t.dom,e.domSize=t.domSize,e.instance=t.instance,e.attrs=t.attrs,e.children=t.children,e.text=t.text,!0}(n,t))return;if("string"==typeof i)switch(null!=n.attrs&&W(n.attrs,n,r),i){case"#":!function(e,t){e.children.toString()!==t.children.toString()&&(e.dom.nodeValue=t.children);t.dom=e.dom}(t,n);break;case"<":!function(e,t,n,r,s){t.children!==n.children?(N(e,t),d(e,n,r,s)):(n.dom=t.dom,n.domSize=t.domSize,n.instance=t.instance)}(e,t,n,o,s);break;case"[":!function(e,t,n,r,s,o){m(e,t.children,n.children,r,s,o);var i=0,a=n.children;if(n.dom=null,null!=a){for(var l=0;l<a.length;l++){var c=a[l];null!=c&&null!=c.dom&&(null==n.dom&&(n.dom=c.dom),i+=c.domSize||1)}1!==i&&(n.domSize=i)}}(e,t,n,r,s,o);break;default:v(t,n,r,o)}else y(e,t,n,r,s,o)}else E(e,t),u(e,n,r,o,s)}function v(e,n,r,s){var i=n.dom=e.dom;s=o(n)||s,"textarea"===n.tag&&(null==n.attrs&&(n.attrs={}),null!=n.text&&(n.attrs.value=n.text,n.text=void 0)),function(e,t,n,r){if(null!=n)for(var s in n)$(e,s,t&&t[s],n[s],r);var o;if(null!=t)for(var s in t)null==(o=t[s])||null!=n&&null!=n[s]||j(e,s,o,r)}(n,e.attrs,n.attrs,s),k(n)||(null!=e.text&&null!=n.text&&""!==n.text?e.text.toString()!==n.text.toString()&&(e.dom.firstChild.nodeValue=n.text):(null!=e.text&&(e.children=[t("#",void 0,void 0,e.text,void 0,e.dom.firstChild)]),null!=n.text&&(n.children=[t("#",void 0,void 0,n.text,void 0,void 0)]),m(i,e.children,n.children,r,null,s)))}function y(e,n,r,s,o,i){if(r.instance=t.normalize(a.call(r.state.view,r)),r.instance===r)throw Error("A view cannot return the vnode it received as argument");W(r.state,r,s),null!=r.attrs&&W(r.attrs,r,s),null!=r.instance?(null==n.instance?u(e,r.instance,s,i,o):g(e,n.instance,r.instance,s,o,i),r.dom=r.instance.dom,r.domSize=r.instance.domSize):null!=n.instance?(E(e,n.instance),r.dom=void 0,r.domSize=0):(r.dom=n.dom,r.domSize=n.domSize)}function w(e,t,n){for(var r=Object.create(null);t<n;t++){var s=e[t];if(null!=s){var o=s.key;null!=o&&(r[o]=t)}}return r}var b=[];function A(e,t,n){for(;t<e.length;t++)if(null!=e[t]&&null!=e[t].dom)return e[t].dom;return n}function S(e,t,n){var s=r.createDocumentFragment();x(e,s,t),O(e,s,n)}function x(e,t,n){for(;null!=n.dom&&n.dom.parentNode===e;){if("string"!=typeof n.tag){if(null!=(n=n.instance))continue}else if("<"===n.tag)for(var r=0;r<n.instance.length;r++)t.appendChild(n.instance[r]);else if("["!==n.tag)t.appendChild(n.dom);else if(1===n.children.length){if(null!=(n=n.children[0]))continue}else for(r=0;r<n.children.length;r++){var s=n.children[r];null!=s&&x(e,t,s)}break}}function O(e,t,n){null!=n?e.insertBefore(t,n):e.appendChild(t)}function k(e){if(null==e.attrs||null==e.attrs.contenteditable&&null==e.attrs.contentEditable)return!1;var t=e.children;if(null!=t&&1===t.length&&"<"===t[0].tag){var n=t[0].children;e.dom.innerHTML!==n&&(e.dom.innerHTML=n)}else if(null!=e.text||null!=t&&0!==t.length)throw new Error("Child node of a contenteditable must be trusted");return!0}function C(e,t,n,r){for(var s=n;s<r;s++){var o=t[s];null!=o&&E(e,o)}}function E(e,t){var n,r,s,o=0,l=t.state;"string"!=typeof t.tag&&"function"==typeof t.state.onbeforeremove&&(null!=(s=a.call(t.state.onbeforeremove,t))&&"function"==typeof s.then&&(o=1,n=s));t.attrs&&"function"==typeof t.attrs.onbeforeremove&&(null!=(s=a.call(t.attrs.onbeforeremove,t))&&"function"==typeof s.then&&(o|=2,r=s));if(i(t,l),o){if(null!=n){var c=function(){1&o&&((o&=2)||u())};n.then(c,c)}if(null!=r){c=function(){2&o&&((o&=1)||u())};r.then(c,c)}}else P(t),D(e,t);function u(){i(t,l),P(t),D(e,t)}}function N(e,t){for(var n=0;n<t.instance.length;n++)e.removeChild(t.instance[n])}function D(e,t){for(;null!=t.dom&&t.dom.parentNode===e;){if("string"!=typeof t.tag){if(null!=(t=t.instance))continue}else if("<"===t.tag)N(e,t);else{if("["!==t.tag&&(e.removeChild(t.dom),!Array.isArray(t.children)))break;if(1===t.children.length){if(null!=(t=t.children[0]))continue}else for(var n=0;n<t.children.length;n++){var r=t.children[n];null!=r&&D(e,r)}}break}}function P(e){if("string"!=typeof e.tag&&"function"==typeof e.state.onremove&&a.call(e.state.onremove,e),e.attrs&&"function"==typeof e.attrs.onremove&&a.call(e.attrs.onremove,e),"string"!=typeof e.tag)null!=e.instance&&P(e.instance);else{var t=e.children;if(Array.isArray(t))for(var n=0;n<t.length;n++){var r=t[n];null!=r&&P(r)}}}function $(e,t,n,s,o){if("key"!==t&&"is"!==t&&null!=s&&!z(t)&&(n!==s||function(e,t){return"value"===t||"checked"===t||"selectedIndex"===t||"selected"===t&&e.dom===l()||"option"===e.tag&&e.dom.parentNode===r.activeElement}(e,t)||"object"==typeof s)){if("o"===t[0]&&"n"===t[1])return U(e,t,s);if("xlink:"===t.slice(0,6))e.dom.setAttributeNS("http://www.w3.org/1999/xlink",t.slice(6),s);else if("style"===t)R(e.dom,n,s);else if(I(e,t,o)){if("value"===t){if(("input"===e.tag||"textarea"===e.tag)&&e.dom.value===""+s&&e.dom===l())return;if("select"===e.tag&&null!==n&&e.dom.value===""+s)return;if("option"===e.tag&&null!==n&&e.dom.value===""+s)return}"input"===e.tag&&"type"===t?e.dom.setAttribute(t,s):e.dom[t]=s}else"boolean"==typeof s?s?e.dom.setAttribute(t,""):e.dom.removeAttribute(t):e.dom.setAttribute("className"===t?"class":t,s)}}function j(e,t,n,r){if("key"!==t&&"is"!==t&&null!=n&&!z(t))if("o"!==t[0]||"n"!==t[1]||z(t))if("style"===t)R(e.dom,n,null);else if(!I(e,t,r)||"className"===t||"value"===t&&("option"===e.tag||"select"===e.tag&&-1===e.dom.selectedIndex&&e.dom===l())||"input"===e.tag&&"type"===t){var s=t.indexOf(":");-1!==s&&(t=t.slice(s+1)),!1!==n&&e.dom.removeAttribute("className"===t?"class":t)}else e.dom[t]=null;else U(e,t,void 0)}function z(e){return"oninit"===e||"oncreate"===e||"onupdate"===e||"onremove"===e||"onbeforeremove"===e||"onbeforeupdate"===e}function I(e,t,n){return void 0===n&&(e.tag.indexOf("-")>-1||null!=e.attrs&&e.attrs.is||"href"!==t&&"list"!==t&&"form"!==t&&"width"!==t&&"height"!==t)&&t in e.dom}var _=/[A-Z]/g;function L(e){return"-"+e.toLowerCase()}function M(e){return"-"===e[0]&&"-"===e[1]?e:"cssFloat"===e?"float":e.replace(_,L)}function R(e,t,n){if(t===n);else if(null==n)e.style.cssText="";else if("object"!=typeof n)e.style.cssText=n;else if(null==t||"object"!=typeof t)for(var r in e.style.cssText="",n){null!=(s=n[r])&&e.style.setProperty(M(r),String(s))}else{for(var r in n){var s;null!=(s=n[r])&&(s=String(s))!==String(t[r])&&e.style.setProperty(M(r),s)}for(var r in t)null!=t[r]&&null==n[r]&&e.style.removeProperty(M(r))}}function T(){this._=n}function U(e,t,n){if(null!=e.events){if(e.events[t]===n)return;null==n||"function"!=typeof n&&"object"!=typeof n?(null!=e.events[t]&&e.dom.removeEventListener(t.slice(2),e.events,!1),e.events[t]=void 0):(null==e.events[t]&&e.dom.addEventListener(t.slice(2),e.events,!1),e.events[t]=n)}else null==n||"function"!=typeof n&&"object"!=typeof n||(e.events=new T,e.dom.addEventListener(t.slice(2),e.events,!1),e.events[t]=n)}function F(e,t,n){"function"==typeof e.oninit&&a.call(e.oninit,t),"function"==typeof e.oncreate&&n.push(a.bind(e.oncreate,t))}function W(e,t,n){"function"==typeof e.onupdate&&n.push(a.bind(e.onupdate,t))}return T.prototype=Object.create(null),T.prototype.handleEvent=function(e){var t,n=this["on"+e.type];"function"==typeof n?t=n.call(e.currentTarget,e):"function"==typeof n.handleEvent&&n.handleEvent(e),this._&&!1!==e.redraw&&(0,this._)(),!1===t&&(e.preventDefault(),e.stopPropagation())},function(e,r,s){if(!e)throw new TypeError("Ensure the DOM element being passed to m.route/m.mount/m.render is not undefined.");var o=[],i=l(),a=e.namespaceURI;null==e.vnodes&&(e.textContent=""),r=t.normalizeChildren(Array.isArray(r)?r:[r]);var c=n;try{n="function"==typeof s?s:void 0,m(e,e.vnodes,r,o,null,"http://www.w3.org/1999/xhtml"===a?void 0:a)}finally{n=c}e.vnodes=r,null!=i&&l()!==i&&"function"==typeof i.focus&&i.focus();for(var u=0;u<o.length;u++)o[u]()}}(window),v=function(e,n,r){var s=[],o=!1,i=!1;function a(){if(o)throw new Error("Nested m.redraw.sync() call");o=!0;for(var n=0;n<s.length;n+=2)try{e(s[n],t(s[n+1]),l)}catch(e){r.error(e)}o=!1}function l(){i||(i=!0,n((function(){i=!1,a()})))}return l.sync=a,{mount:function(n,r){if(null!=r&&null==r.view&&"function"!=typeof r)throw new TypeError("m.mount(element, component) expects a component, not a vnode");var o=s.indexOf(n);o>=0&&(s.splice(o,2),e(n,[],l)),null!=r&&(s.push(n,r),e(n,t(r),l))},redraw:l}}(g,requestAnimationFrame,console),y=function(e){if("[object Object]"!==Object.prototype.toString.call(e))return"";var t=[];for(var n in e)r(n,e[n]);return t.join("&");function r(e,n){if(Array.isArray(n))for(var s=0;s<n.length;s++)r(e+"["+s+"]",n[s]);else if("[object Object]"===Object.prototype.toString.call(n))for(var s in n)r(e+"["+s+"]",n[s]);else t.push(encodeURIComponent(e)+(null!=n&&""!==n?"="+encodeURIComponent(n):""))}},w=Object.assign||function(e,t){t&&Object.keys(t).forEach((function(n){e[n]=t[n]}))},b=function(e,t){if(/:([^\/\.-]+)(\.{3})?:/.test(e))throw new SyntaxError("Los nombres de los parametros del template deben estar separados");if(null==t)return e;var n=e.indexOf("?"),r=e.indexOf("#"),s=r<0?e.length:r,o=n<0?s:n,i=e.slice(0,o),a={};w(a,t);var l=i.replace(/:([^\/\.-]+)(\.{3})?/g,(function(e,n,r){return delete a[n],null==t[n]?e:r?t[n]:encodeURIComponent(String(t[n]))})),c=l.indexOf("?"),u=l.indexOf("#"),f=u<0?l.length:u,d=c<0?f:c,h=l.slice(0,d);n>=0&&(h+=e.slice(n,s)),c>=0&&(h+=(n<0?"?":"&")+l.slice(c,f));var p=y(a);return p&&(h+=(n<0&&c<0?"?":"&")+p),r>=0&&(h+=e.slice(r)),u>=0&&(h+=(r<0?"":"&")+l.slice(u)),h},A=function(e,t,n){var r=0;function s(e){return new t(e)}function o(e){return function(r,o){"string"!=typeof r?(o=r,r=r.url):null==o&&(o={});var i=new t((function(t,n){e(b(r,o.params),o,(function(e){if("function"==typeof o.type)if(Array.isArray(e))for(var n=0;n<e.length;n++)e[n]=new o.type(e[n]);else e=new o.type(e);t(e)}),n)}));if(!0===o.background)return i;var a=0;function l(){0==--a&&"function"==typeof n&&n()}return function e(t){var n=t.then;return t.constructor=s,t.then=function(){a++;var r=n.apply(t,arguments);return r.then(l,(function(e){if(l(),0===a)throw e})),e(r)},t}(i)}}function i(e,t){for(var n in e.headers)if({}.hasOwnProperty.call(e.headers,n)&&t.test(n))return!0;return!1}return s.prototype=t.prototype,s.__proto__=t,{request:o((function(t,n,r,s){var o,a=null!=n.method?n.method.toUpperCase():"GET",l=n.body,c=!(null!=n.serialize&&n.serialize!==JSON.serialize||l instanceof e.FormData),u=n.responseType||("function"==typeof n.extract?"":"json"),f=new e.XMLHttpRequest,d=!1,h=f,p=f.abort;for(var m in f.abort=function(){d=!0,p.call(this)},f.open(a,t,!1!==n.async,"string"==typeof n.user?n.user:void 0,"string"==typeof n.password?n.password:void 0),c&&null!=l&&!i(n,/^content-type$/i)&&f.setRequestHeader("Content-Type","application/json; charset=utf-8"),"function"==typeof n.deserialize||i(n,/^accept$/i)||f.setRequestHeader("Accept","application/json, text/*"),n.withCredentials&&(f.withCredentials=n.withCredentials),n.timeout&&(f.timeout=n.timeout),f.responseType=u,n.headers)({}).hasOwnProperty.call(n.headers,m)&&f.setRequestHeader(m,n.headers[m]);f.onreadystatechange=function(e){if(!d&&4===e.target.readyState)try{var o,i=e.target.status>=200&&e.target.status<300||304===e.target.status||/^file:\/\//i.test(t),a=e.target.response;if("json"===u?e.target.responseType||"function"==typeof n.extract||(a=JSON.parse(e.target.responseText)):u&&"text"!==u||null==a&&(a=e.target.responseText),"function"==typeof n.extract?(a=n.extract(e.target,n),i=!0):"function"==typeof n.deserialize&&(a=n.deserialize(a)),i)r(a);else{try{o=e.target.responseText}catch(e){o=a}var l=new Error(o);l.code=e.target.status,l.response=a,s(l)}}catch(e){s(e)}},"function"==typeof n.config&&(f=n.config(f,n,t)||f)!==h&&(o=f.abort,f.abort=function(){d=!0,o.call(this)}),null==l?f.send():"function"==typeof n.serialize?f.send(n.serialize(l)):l instanceof e.FormData?f.send(l):f.send(JSON.stringify(l))})),jsonp:o((function(t,n,s,o){var i=n.callbackName||"_mithril_"+Math.round(1e16*Math.random())+"_"+r++,a=e.document.createElement("script");e[i]=function(t){delete e[i],a.parentNode.removeChild(a),s(t)},a.onerror=function(){delete e[i],a.parentNode.removeChild(a),o(new Error("JSONP request failed"))},a.src=t+(t.indexOf("?")<0?"?":"&")+encodeURIComponent(n.callbackKey||"callback")+"="+encodeURIComponent(i),e.document.documentElement.appendChild(a)}))}}(window,m,v.redraw),S=function(e){if(""===e||null==e)return{};"?"===e.charAt(0)&&(e=e.slice(1));for(var t=e.split("&"),n={},r={},s=0;s<t.length;s++){var o=t[s].split("="),i=decodeURIComponent(o[0]),a=2===o.length?decodeURIComponent(o[1]):"";"true"===a?a=!0:"false"===a&&(a=!1);var l=i.split(/\]\[?|\[/),c=r;i.indexOf("[")>-1&&l.pop();for(var u=0;u<l.length;u++){var f=l[u],d=l[u+1],h=""==d||!isNaN(parseInt(d,10));if(""===f)null==n[i=l.slice(0,u).join()]&&(n[i]=Array.isArray(c)?c.length:0),f=n[i]++;else if("__proto__"===f)break;if(u===l.length-1)c[f]=a;else{var p=Object.getOwnPropertyDescriptor(c,f);null!=p&&(p=p.value),null==p&&(c[f]=p=h?[]:{}),c=p}}}return r},x=function(e){var t=e.indexOf("?"),n=e.indexOf("#"),r=n<0?e.length:n,s=t<0?r:t,o=e.slice(0,s).replace(/\/{2,}/g,"/");return o?("/"!==o[0]&&(o="/"+o),o.length>1&&"/"===o[o.length-1]&&(o=o.slice(0,-1))):o="/",{path:o,params:t<0?{}:S(e.slice(t+1,r))}},O=function(e){var t=x(e),n=Object.keys(t.params),r=[],s=new RegExp("^"+t.path.replace(/:([^\/.-]+)(\.{3}|\.(?!\.)|-)?|[\\^$*+.()|\[\]{}]/g,(function(e,t,n){return null==t?"\\"+e:(r.push({k:t,r:"..."===n}),"..."===n?"(.*)":"."===n?"([^/]+)\\.":"([^/]+)"+(n||""))}))+"$");return function(e){for(var o=0;o<n.length;o++)if(t.params[n[o]]!==e.params[n[o]])return!1;if(!r.length)return s.test(e.path);var i=s.exec(e.path);if(null==i)return!1;for(o=0;o<r.length;o++)e.params[r[o].k]=r[o].r?i[o+1]:decodeURIComponent(i[o+1]);return!0}},k={},C=function(e,n){var r;function s(t,n,s){if(t=b(t,n),null!=r){r();var o=s?s.state:null,i=s?s.title:null;s&&s.replace?e.history.replaceState(o,i,d.prefix+t):e.history.pushState(o,i,d.prefix+t)}else e.location.href=d.prefix+t}var o,i,a,l,u=k,f=d.SKIP={};function d(c,h,p){if(null==c)throw new Error("Ensure the DOM element that was passed to `m.route` is not undefined");var g,v=0,y=Object.keys(p).map((function(e){if("/"!==e[0])throw new SyntaxError("Las rutas deben empezar por `/`");if(/:([^\/\.-]+)(\.{3})?:/.test(e))throw new SyntaxError("Los nombres de los parametros de ruta deben estar separador por `/`, `.`, o `-`");return{route:e,component:p[e],check:O(e)}})),b="function"==typeof setImmediate?setImmediate:setTimeout,A=m.resolve(),S=!1;if(r=null,null!=h){var C=x(h);if(!y.some((function(e){return e.check(C)})))throw new ReferenceError("Default route doesn't match any known routes")}function E(){S=!1;var t=e.location.hash;"#"!==d.prefix[0]&&(t=e.location.search+t,"?"!==d.prefix[0]&&"/"!==(t=e.location.pathname+t)[0]&&(t="/"+t));var r=t.concat().replace(/(?:%[a-f89][a-f0-9])+/gim,decodeURIComponent).slice(d.prefix.length),c=x(r);function p(){if(r===h)throw new Error("Could not resolve default route "+h);s(h,null,{replace:!0})}w(c.params,e.history.state),function e(t){for(;t<y.length;t++)if(y[t].check(c)){var s=y[t].component,d=y[t].route,h=s,m=l=function(d){if(m===l){if(d===f)return e(t+1);o=null==d||"function"!=typeof d.view&&"function"!=typeof d?"div":d,i=c.params,a=r,l=null,u=s.render?s:null,2===v?n.redraw():(v=2,n.redraw.sync())}};return void(s.view||"function"==typeof s?(s={},m(h)):s.onmatch?A.then((function(){return s.onmatch(c.params,r,d)})).then(m,p):m("div"))}p()}(0)}return r=function(){S||(S=!0,b(E))},"function"==typeof e.history.pushState?(g=function(){e.removeEventListener("popstate",r,!1)},e.addEventListener("popstate",r,!1)):"#"===d.prefix[0]&&(r=null,g=function(){e.removeEventListener("hashchange",E,!1)},e.addEventListener("hashchange",E,!1)),n.mount(c,{onbeforeupdate:function(){return!(!(v=v?2:1)||k===u)},oncreate:E,onremove:g,view:function(){if(v&&k!==u){var e=[t(o,i.key,i)];return u&&(e=u.render(e[0])),e}}})}return d.set=function(e,t,n){null!=l&&((n=n||{}).replace=!0),l=null,s(e,t,n)},d.get=function(){return a},d.prefix="#!",d.Link={view:function(e){var t,n,r=e.attrs.options,s={};w(s,e.attrs),s.selector=s.options=s.key=s.oninit=s.oncreate=s.onbeforeupdate=s.onupdate=s.onbeforeremove=s.onremove=null;var o=c(e.attrs.selector||"a",s,e.children);return(o.attrs.disabled=Boolean(o.attrs.disabled))?(o.attrs.href=null,o.attrs["aria-disabled"]="true",o.attrs.onclick=null):(t=o.attrs.onclick,n=o.attrs.href,o.attrs.href=d.prefix+n,o.attrs.onclick=function(e){var s;"function"==typeof t?s=t.call(e.currentTarget,e):null==t||"object"!=typeof t||"function"==typeof t.handleEvent&&t.handleEvent(e),!1===s||e.defaultPrevented||0!==e.button&&0!==e.which&&1!==e.which||e.currentTarget.target&&"_self"!==e.currentTarget.target||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||(e.preventDefault(),e.redraw=!1,d.set(n,null,r))}),o}},d.param=function(e){return i&&null!=e?i[e]:i},d}(window,v),E=function(){return u.apply(this,arguments)};E.m=u,E.trust=u.trust,E.fragment=u.fragment,E.mount=v.mount,E.route=C,E.render=g,E.redraw=v.redraw,E.request=A.request,E.jsonp=A.jsonp,E.parseQueryString=S,E.buildQueryString=y,E.parsePathname=x,E.buildPathname=b,E.vnode=t,E.PromisePolyfill=p;var N=E;const D=()=>({view:e=>{const t={[e.attrs.page]:"active"},n=[];window.authorizer.hasAccess("devices",1)&&n.push(N("li",{class:t.overview},N("a",{href:"#!/overview"},"Resumen"))),window.authorizer.hasAccess("devices",2)&&n.push(N("li",{class:t.devices},N("a",{href:"#!/devices"},"Dispositivos"))),window.authorizer.hasAccess("faults",2)&&n.push(N("li",{class:t.faults},N("a",{href:"#!/faults"},"Fallos de provision")));const r=["presets","provisions","virtualParameters","files"];for(const e of r)if(window.authorizer.hasAccess(e,2)){n.push(N("li",{class:t.admin},N("a",{href:"#!/admin"},"Administracion")));break}return N("nav",N("ul",n))}});function P(e){if(!(this instanceof P))return new P(e);this._=e}var $=P.prototype;function j(e,t){for(var n=0;n<e;n++)t(n)}function z(e,t,n){return function(e,t){j(t.length,(function(n){e(t[n],n,t)}))}((function(n,r,s){t=e(t,n,r,s)}),n),t}function I(e,t){return z((function(t,n,r,s){return t.concat([e(n,r,s)])}),[],t)}function _(e){var t=z((function(e,t,n,r){return e.concat(n===r.length-1?Buffer.from([t,0]).readUInt16BE(0):r.readUInt16BE(n))}),[],e);return Buffer.from(I((function(e){return(e<<1&65535)>>8}),t))}function L(e){return e[0]>>7}function M(){return"undefined"!=typeof Buffer}function R(){if(!M())throw new Error("Buffer global does not exist; please use webpack if you need to parse Buffers in the browser.")}function T(e){R();var t=z((function(e,t){return e+t}),0,e);if(t%8!=0)throw new Error("The bits ["+e.join(", ")+"] add up to "+t+" which is not an even number of bytes; the total should be divisible by 8");var n,r=t/8,s=(n=function(e){return e>48},z((function(e,t){return e||(n(t)?t:e)}),null,e));if(s)throw new Error(s+" bit range requested exceeds 48 bit (6 byte) Number max.");return new P((function(t,n){var s=r+n;return s>t.length?G(n,r.toString()+" bytes"):Y(s,z((function(e,t){var n=function(e,t){var n={v:0,buf:t};return j(e,(function(){n={v:n.v<<1|L(n.buf),buf:_(n.buf)}})),n}(t,e.buf);return{coll:e.coll.concat(n.v),buf:n.buf}}),{coll:[],buf:t.slice(n,s)},e).coll)}))}function U(e,t){return new P((function(n,r){return R(),r+t>n.length?G(r,t+" bytes for "+e):Y(r+t,n.slice(r,r+t))}))}function F(e,t){if("number"!=typeof(n=t)||Math.floor(n)!==n||t<0||t>6)throw new Error(e+" requires integer length in range [0, 6].");var n}function W(e){return F("uintBE",e),U("uintBE("+e+")",e).map((function(t){return t.readUIntBE(0,e)}))}function B(e){return F("uintLE",e),U("uintLE("+e+")",e).map((function(t){return t.readUIntLE(0,e)}))}function q(e){return F("intBE",e),U("intBE("+e+")",e).map((function(t){return t.readIntBE(0,e)}))}function J(e){return F("intLE",e),U("intLE("+e+")",e).map((function(t){return t.readIntLE(0,e)}))}function V(e){return Array.prototype.slice.call(e)}function K(e){return e instanceof P}function H(e){return"[object Array]"==={}.toString.call(e)}function Q(e){return M()&&Buffer.isBuffer(e)}function Y(e,t){return{status:!0,index:e,value:t,furthest:-1,expected:[]}}function G(e,t){return H(t)||(t=[t]),{status:!1,index:-1,value:null,furthest:e,expected:t}}function Z(e,t){if(!t)return e;if(e.furthest>t.furthest)return e;var n=e.furthest===t.furthest?function(e,t){if(function(){if(void 0!==P._supportsSet)return P._supportsSet;var e="undefined"!=typeof Set;return P._supportsSet=e,e}()&&Array.from){for(var n=new Set(e),r=0;r<t.length;r++)n.add(t[r]);var s=Array.from(n);return s.sort(),s}for(var o={},i=0;i<e.length;i++)o[e[i]]=!0;for(var a=0;a<t.length;a++)o[t[a]]=!0;var l=[];for(var c in o)({}).hasOwnProperty.call(o,c)&&l.push(c);return l.sort(),l}(e.expected,t.expected):t.expected;return{status:e.status,index:e.index,value:e.value,furthest:t.furthest,expected:n}}var X={};function ee(e,t){if(Q(e))return{offset:t,line:-1,column:-1};if(X.input===e&&X.i===t)return X.value;var n=e.slice(0,t).split("\n"),r={offset:t,line:n.length,column:n[n.length-1].length+1};return X.input=e,X.i=t,X.value=r,r}function te(e){if(!K(e))throw new Error("not a parser: "+e)}function ne(e,t){return"string"==typeof e?e.charAt(t):e[t]}function re(e){if("number"!=typeof e)throw new Error("not a number: "+e)}function se(e){if(!(e instanceof RegExp))throw new Error("not a regexp: "+e);for(var t=de(e),n=0;n<t.length;n++){var r=t.charAt(n);if("i"!==r&&"m"!==r&&"u"!==r&&"s"!==r)throw new Error('unsupported regexp flag "'+r+'": '+e)}}function oe(e){if("function"!=typeof e)throw new Error("not a function: "+e)}function ie(e){if("string"!=typeof e)throw new Error("not a string: "+e)}function ae(e,t){return new Array(t+1).join(e)}function le(e,t,n){var r=t-e.length;return r<=0?e:ae(n,r)+e}function ce(e,t,n,r){return{from:e-t>0?e-t:0,to:e+n>r?r:e+n}}function ue(e,t){var n,r,s,o,i,a=t.index,l=a.offset,c=1;if(l===e.length)return"Got the end of the input";if(Q(e)){var u=l-l%8,f=l-u,d=ce(u,40,40,e.length),h=I((function(e){return I((function(e){return le(e.toString(16),2,"0")}),e)}),function(e,t){var n=e.length,r=[],s=0;if(n<=t)return[e.slice()];for(var o=0;o<n;o++)r[s]||r.push([]),r[s].push(e[o]),(o+1)%t==0&&s++;return r}(e.slice(d.from,d.to).toJSON().data,8));o=function(e){return 0===e.from&&1===e.to?{from:e.from,to:e.to}:{from:e.from/8,to:Math.floor(e.to/8)}}(d),r=u/8,n=3*f,f>=4&&(n+=1),c=2,s=I((function(e){return e.length<=4?e.join(" "):e.slice(0,4).join(" ")+"  "+e.slice(4).join(" ")}),h),(i=(8*(o.to>0?o.to-1:o.to)).toString(16).length)<2&&(i=2)}else{var p=e.split(/\r\n|[\n\r\u2028\u2029]/);n=a.column-1,r=a.line-1,o=ce(r,2,3,p.length),s=p.slice(o.from,o.to),i=o.to.toString().length}var m=r-o.from;return Q(e)&&(i=(8*(o.to>0?o.to-1:o.to)).toString(16).length)<2&&(i=2),z((function(t,r,s){var a,l=s===m,u=l?"> ":"  ";return a=Q(e)?le((8*(o.from+s)).toString(16),i,"0"):le((o.from+s+1).toString(),i," "),[].concat(t,[u+a+" | "+r],l?["  "+ae(" ",i)+" | "+le("",n," ")+ae("^",c)]:[])}),[],s).join("\n")}function fe(e,t){return["\n","-- PARSING FAILED "+ae("-",50),"\n\n",ue(e,t),"\n\n",(n=t.expected,1===n.length?"Expected:\n\n"+n[0]:"Expected one of the following: \n\n"+n.join(", ")),"\n"].join("");var n}function de(e){return void 0!==e.flags?e.flags:[e.global?"g":"",e.ignoreCase?"i":"",e.multiline?"m":"",e.unicode?"u":"",e.sticky?"y":""].join("")}function he(e){return RegExp("^(?:"+e.source+")",de(e))}function pe(){for(var e=[].slice.call(arguments),t=e.length,n=0;n<t;n+=1)te(e[n]);return P((function(n,r){for(var s,o=new Array(t),i=0;i<t;i+=1){if(!(s=Z(e[i]._(n,r),s)).status)return s;o[i]=s.value,r=s.index}return Z(Y(r,o),s)}))}function me(){var e=[].slice.call(arguments);if(0===e.length)throw new Error("seqMap needs at least one argument");var t=e.pop();return oe(t),pe.apply(null,e).map((function(e){return t.apply(null,e)}))}function ge(){var e=[].slice.call(arguments),t=e.length;if(0===t)return Se("zero alternates");for(var n=0;n<t;n+=1)te(e[n]);return P((function(t,n){for(var r,s=0;s<e.length;s+=1)if((r=Z(e[s]._(t,n),r)).status)return r;return r}))}function ve(e,t){return ye(e,t).or(Ae([]))}function ye(e,t){return te(e),te(t),me(e,t.then(e).many(),(function(e,t){return[e].concat(t)}))}function we(e){ie(e);var t="'"+e+"'";return P((function(n,r){var s=r+e.length,o=n.slice(r,s);return o===e?Y(s,o):G(r,t)}))}function be(e,t){se(e),arguments.length>=2?re(t):t=0;var n=he(e),r=""+e;return P((function(e,s){var o=n.exec(e.slice(s));if(o){if(0<=t&&t<=o.length){var i=o[0],a=o[t];return Y(s+i.length,a)}return G(s,"valid match group (0 to "+o.length+") in "+r)}return G(s,r)}))}function Ae(e){return P((function(t,n){return Y(n,e)}))}function Se(e){return P((function(t,n){return G(n,e)}))}function xe(e){if(K(e))return P((function(t,n){var r=e._(t,n);return r.index=n,r.value="",r}));if("string"==typeof e)return xe(we(e));if(e instanceof RegExp)return xe(be(e));throw new Error("not a string, regexp, or parser: "+e)}function Oe(e){return te(e),P((function(t,n){var r=e._(t,n),s=t.slice(n,r.index);return r.status?G(n,'not "'+s+'"'):Y(n,null)}))}function ke(e){return oe(e),P((function(t,n){var r=ne(t,n);return n<t.length&&e(r)?Y(n+1,r):G(n,"a character/byte matching "+e)}))}function Ce(e,t){arguments.length<2&&(t=e,e=void 0);var n=P((function(e,r){return n._=t()._,n._(e,r)}));return e?n.desc(e):n}function Ee(){return Se("fantasy-land/empty")}$.parse=function(e){if("string"!=typeof e&&!Q(e))throw new Error(".parse must be called with a string or Buffer as its argument");var t=this.skip($e)._(e,0);return t.status?{status:!0,value:t.value}:{status:!1,index:ee(e,t.furthest),expected:t.expected}},$.tryParse=function(e){var t=this.parse(e);if(t.status)return t.value;var n=fe(e,t),r=new Error(n);throw r.type="ParsimmonError",r.result=t,r},$.assert=function(e,t){return this.chain((function(n){return e(n)?Ae(n):Se(t)}))},$.or=function(e){return ge(this,e)},$.trim=function(e){return this.wrap(e,e)},$.wrap=function(e,t){return me(e,this,t,(function(e,t){return t}))},$.thru=function(e){return e(this)},$.then=function(e){return te(e),pe(this,e).map((function(e){return e[1]}))},$.many=function(){var e=this;return P((function(t,n){for(var r=[],s=void 0;;){if(!(s=Z(e._(t,n),s)).status)return Z(Y(n,r),s);if(n===s.index)throw new Error("infinite loop detected in .many() parser --- calling .many() on a parser which can accept zero characters is usually the cause");n=s.index,r.push(s.value)}}))},$.tieWith=function(e){return ie(e),this.map((function(t){if(function(e){if(!H(e))throw new Error("not an array: "+e)}(t),t.length){ie(t[0]);for(var n=t[0],r=1;r<t.length;r++)ie(t[r]),n+=e+t[r];return n}return""}))},$.tie=function(){return this.tieWith("")},$.times=function(e,t){var n=this;return arguments.length<2&&(t=e),re(e),re(t),P((function(r,s){for(var o=[],i=void 0,a=void 0,l=0;l<e;l+=1){if(a=Z(i=n._(r,s),a),!i.status)return a;s=i.index,o.push(i.value)}for(;l<t&&(a=Z(i=n._(r,s),a),i.status);l+=1)s=i.index,o.push(i.value);return Z(Y(s,o),a)}))},$.result=function(e){return this.map((function(){return e}))},$.atMost=function(e){return this.times(0,e)},$.atLeast=function(e){return me(this.times(e),this.many(),(function(e,t){return e.concat(t)}))},$.map=function(e){oe(e);var t=this;return P((function(n,r){var s=t._(n,r);return s.status?Z(Y(s.index,e(s.value)),s):s}))},$.contramap=function(e){oe(e);var t=this;return P((function(n,r){var s=t.parse(e(n.slice(r)));return s.status?Y(r+n.length,s.value):s}))},$.promap=function(e,t){return oe(e),oe(t),this.contramap(e).map(t)},$.skip=function(e){return pe(this,e).map((function(e){return e[0]}))},$.mark=function(){return me(Ne,this,Ne,(function(e,t,n){return{start:e,value:t,end:n}}))},$.node=function(e){return me(Ne,this,Ne,(function(t,n,r){return{name:e,value:n,start:t,end:r}}))},$.sepBy=function(e){return ve(this,e)},$.sepBy1=function(e){return ye(this,e)},$.lookahead=function(e){return this.skip(xe(e))},$.notFollowedBy=function(e){return this.skip(Oe(e))},$.desc=function(e){H(e)||(e=[e]);var t=this;return P((function(n,r){var s=t._(n,r);return s.status||(s.expected=e),s}))},$.fallback=function(e){return this.or(Ae(e))},$.ap=function(e){return me(e,this,(function(e,t){return e(t)}))},$.chain=function(e){var t=this;return P((function(n,r){var s=t._(n,r);return s.status?Z(e(s.value)._(n,s.index),s):s}))},$.concat=$.or,$.empty=Ee,$.of=Ae,$["fantasy-land/ap"]=$.ap,$["fantasy-land/chain"]=$.chain,$["fantasy-land/concat"]=$.concat,$["fantasy-land/empty"]=$.empty,$["fantasy-land/of"]=$.of,$["fantasy-land/map"]=$.map;var Ne=P((function(e,t){return Y(t,ee(e,t))})),De=P((function(e,t){return t>=e.length?G(t,"any character/byte"):Y(t+1,ne(e,t))})),Pe=P((function(e,t){return Y(e.length,e.slice(t))})),$e=P((function(e,t){return t<e.length?G(t,"EOF"):Y(t,null)})),je=be(/[0-9]/).desc("a digit"),ze=be(/[0-9]*/).desc("optional digits"),Ie=be(/[a-z]/i).desc("a letter"),_e=be(/[a-z]*/i).desc("optional letters"),Le=be(/\s*/).desc("optional whitespace"),Me=be(/\s+/).desc("whitespace"),Re=we("\r"),Te=we("\n"),Ue=we("\r\n"),Fe=ge(Ue,Te,Re).desc("newline"),We=ge(Fe,$e);P.all=Pe,P.alt=ge,P.any=De,P.cr=Re,P.createLanguage=function(e){var t={};for(var n in e)({}).hasOwnProperty.call(e,n)&&function(n){t[n]=Ce((function(){return e[n](t)}))}(n);return t},P.crlf=Ue,P.custom=function(e){return P(e(Y,G))},P.digit=je,P.digits=ze,P.empty=Ee,P.end=We,P.eof=$e,P.fail=Se,P.formatError=fe,P.index=Ne,P.isParser=K,P.lazy=Ce,P.letter=Ie,P.letters=_e,P.lf=Te,P.lookahead=xe,P.makeFailure=G,P.makeSuccess=Y,P.newline=Fe,P.noneOf=function(e){return ke((function(t){return e.indexOf(t)<0})).desc("none of '"+e+"'")},P.notFollowedBy=Oe,P.of=Ae,P.oneOf=function(e){for(var t=e.split(""),n=0;n<t.length;n++)t[n]="'"+t[n]+"'";return ke((function(t){return e.indexOf(t)>=0})).desc(t)},P.optWhitespace=Le,P.Parser=P,P.range=function(e,t){return ke((function(n){return e<=n&&n<=t})).desc(e+"-"+t)},P.regex=be,P.regexp=be,P.sepBy=ve,P.sepBy1=ye,P.seq=pe,P.seqMap=me,P.seqObj=function(){for(var e={},t=0,n=V(arguments),r=n.length,s=0;s<r;s+=1){var o=n[s];if(!K(o)){if(H(o)){var i=2===o.length&&"string"==typeof o[0]&&K(o[1]);if(i){var a=o[0];if(Object.prototype.hasOwnProperty.call(e,a))throw new Error("seqObj: duplicate key "+a);e[a]=!0,t++;continue}}throw new Error("seqObj arguments must be parsers or [string, parser] array pairs.")}}if(0===t)throw new Error("seqObj expects at least one named parser, found zero");return P((function(e,t){for(var s,o={},i=0;i<r;i+=1){var a,l;if(H(n[i])?(a=n[i][0],l=n[i][1]):(a=null,l=n[i]),!(s=Z(l._(e,t),s)).status)return s;a&&(o[a]=s.value),t=s.index}return Z(Y(t,o),s)}))},P.string=we,P.succeed=Ae,P.takeWhile=function(e){return oe(e),P((function(t,n){for(var r=n;r<t.length&&e(ne(t,r));)r++;return Y(r,t.slice(n,r))}))},P.test=ke,P.whitespace=Me,P["fantasy-land/empty"]=Ee,P["fantasy-land/of"]=Ae,P.Binary={bitSeq:T,bitSeqObj:function(e){R();var t={},n=0,r=I((function(e){if(H(e)){var r=e;if(2!==r.length)throw new Error("["+r.join(", ")+"] should be length 2, got length "+r.length);if(ie(r[0]),re(r[1]),Object.prototype.hasOwnProperty.call(t,r[0]))throw new Error("duplicate key in bitSeqObj: "+r[0]);return t[r[0]]=!0,n++,r}return re(e),[null,e]}),e);if(n<1)throw new Error("bitSeqObj expects at least one named pair, got ["+e.join(", ")+"]");var s=I((function(e){return e[0]}),r);return T(I((function(e){return e[1]}),r)).map((function(e){return z((function(e,t){return null!==t[0]&&(e[t[0]]=t[1]),e}),{},I((function(t,n){return[t,e[n]]}),s))}))},byte:function(e){if(R(),re(e),e>255)throw new Error("Value specified to byte constructor ("+e+"=0x"+e.toString(16)+") is larger in value than a single byte.");var t=(e>15?"0x":"0x0")+e.toString(16);return P((function(n,r){var s=ne(n,r);return s===e?Y(r+1,s):G(r,t)}))},buffer:function(e){return U("buffer",e).map((function(e){return Buffer.from(e)}))},encodedString:function(e,t){return U("string",t).map((function(t){return t.toString(e)}))},uintBE:W,uint8BE:W(1),uint16BE:W(2),uint32BE:W(4),uintLE:B,uint8LE:B(1),uint16LE:B(2),uint32LE:B(4),intBE:q,int8BE:q(1),int16BE:q(2),int32BE:q(4),intLE:J,int8LE:J(1),int16LE:J(2),int32LE:J(4),floatBE:U("floatBE",4).map((function(e){return e.readFloatBE(0)})),floatLE:U("floatLE",4).map((function(e){return e.readFloatLE(0)})),doubleBE:U("doubleBE",8).map((function(e){return e.readDoubleBE(0)})),doubleLE:U("doubleLE",8).map((function(e){return e.readDoubleLE(0)}))};var Be=P;function qe(e){const t={b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};return e.replace(/\\(u[0-9a-fA-F]{4}|[^u])/,((e,n)=>{const r=n.charAt(0),s=n.slice(1);return"u"===r?String.fromCharCode(parseInt(s,16)):t.hasOwnProperty(r)?t[r]:r}))}function Je(e,t){if(!Array.isArray(e))return t(e);let n;for(let r=1;r<e.length;++r){const s=Je(e[r],t);s!==e[r]&&(n=n||e.slice(),n[r]=s)}return t(n||e)}function Ve(e,t){return Be.seqMap(t,Be.seq(e,t).many(),((e,t)=>t.reduce(((e,t)=>{const[n,r]=t;return Array.isArray(e)&&n===e[0]?e.concat([r]):Array.isArray(r)&&n===r[0]?[n,e].concat(r.slice(1)):[n,e,r]}),e)))}const Ke=Be.createLanguage({ComparisonOperator:function(){return Be.alt(Be.string(">="),Be.string("<>"),Be.string("<="),Be.string("="),Be.string(">"),Be.string("<")).skip(Be.optWhitespace)},LikeOperator:function(){return Be.alt(Be.regexp(/like/i).result("LIKE").desc("LIKE"),Be.regexp(/not\s+like/i).result("NOT LIKE").desc("NOT LIKE")).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace)},IsNullOperator:function(){return Be.alt(Be.regexp(/is\s+null/i).result("IS NULL").desc("IS NULL"),Be.regexp(/is\s+not\s+null/i).result("IS NOT NULL").desc("IS NOT NULL")).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace)},NotOperator:function(){return Be.regexp(/not/i).result("NOT").notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("NOT")},AndOperator:function(){return Be.regexp(/and/i).result("AND").notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("AND")},OrOperator:function(){return Be.regexp(/or/i).result("OR").notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("OR")},Parameter:function(e){return Be.alt(Be.regexp(/[a-zA-Z0-9_.*-]+/),e.Expression.wrap(Be.string("{").skip(Be.optWhitespace),Be.string("}"))).atLeast(1).map((e=>["PARAM",e.length>1?["||"].concat(e):e[0]])).skip(Be.optWhitespace).desc("parameter")},StringValueSql:function(){return Be.regexp(/'([^']*)'/,1).atLeast(1).skip(Be.optWhitespace).map((e=>e.join("'"))).desc("string")},StringValueJs:function(){return Be.regexp(/"((?:\\.|.)*?)"/,1).skip(Be.optWhitespace).map(qe).desc("string")},NumberValue:function(){return Be.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).map(Number).desc("number")},BooleanValue:function(){return Be.alt(Be.regexp(/true/i).result(!0).desc("TRUE"),Be.regexp(/false/i).result(!1).desc("FALSE")).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace)},NullValue:function(){return Be.regexp(/null/i).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).result(null).desc("NULL")},FuncValue:function(e){return Be.seqMap(Be.regexp(/([a-zA-Z0-9_]+)/,1).skip(Be.optWhitespace).desc("function"),e.ExpressionList.wrap(Be.string("(").skip(Be.optWhitespace),Be.string(")").skip(Be.optWhitespace)),((e,t)=>["FUNC",e.toUpperCase()].concat(t)))},WhenPair:function(e){return Be.seq(Be.regexp(/when/i).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("WHEN").then(e.Expression),Be.regexp(/then/i).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("THEN").then(e.Expression))},CaseStatement:function(e){return Be.seqMap(Be.regexp(/case/i).result("CASE").notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("CASE"),e.WhenPair.many(),Be.regexp(/else/i).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/)).skip(Be.optWhitespace).desc("ELSE").then(e.Expression).map((e=>[[!0,e]])).fallback(null).skip(Be.regex(/end/i).notFollowedBy(Be.regexp(/[a-zA-Z0-9_]/))).skip(Be.optWhitespace),((...e)=>e.flat(2)))},Value:function(e){return Be.alt(e.NullValue,e.BooleanValue,e.NumberValue,e.StringValueSql,e.StringValueJs,e.FuncValue,e.CaseStatement)},ValueExpression:function(e){return Ve(Be.string("||").skip(Be.optWhitespace),Ve(Be.alt(Be.string("+"),Be.string("-")).skip(Be.optWhitespace),Ve(Be.alt(Be.string("*"),Be.string("/")).skip(Be.optWhitespace),Be.alt(e.Value,e.Parameter,e.Expression.wrap(Be.string("(").skip(Be.optWhitespace),Be.string(")").skip(Be.optWhitespace))))))},Comparison:function(e){return Be.alt(Be.seqMap(e.ValueExpression,e.IsNullOperator,((e,t)=>[t,e])),Be.seqMap(e.ValueExpression,e.ComparisonOperator,e.ValueExpression,((e,t,n)=>[t,e,n])),Be.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression.skip(Be.regexp(/escape/i).result("ESCAPE").skip(Be.whitespace).desc("ESCAPE")),e.ValueExpression,((e,t,n,r)=>[t,e,n,r])),Be.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression,((e,t,n)=>[t,e,n])))},ExpressionList:function(e){return e.Expression.sepBy(Be.string(",").skip(Be.optWhitespace))},Expression:function(e){return Ve(e.OrOperator,Ve(e.AndOperator,(t=e.NotOperator,n=e.Comparison.or(e.ValueExpression),Be.seq(t,n).or(n)))).trim(Be.optWhitespace);var t,n}});function He(e){return e?Ke.Expression.tryParse(e):null}function Qe(e,t=0){if(!Array.isArray(e))return JSON.stringify(e);const n={OR:10,AND:11,NOT:12,"=":20,"<>":20,">":20,">=":20,"<":20,"<=":20,LIKE:20,"NOT LIKE":20,"IS NULL":20,"IS NOT NULL":20,"||":30,"+":31,"-":31,"*":32,"/":32},r=e[0].toUpperCase();function s(e){return n[r]<=t?`(${e})`:e}if("FUNC"===r)return s(`${e[1]}(${e.slice(2).map((e=>Qe(e))).join(", ")})`);if("PARAM"===r)return"string"==typeof e[1]?s(e[1]):Array.isArray(e[1])&&"||"===e[1][0]?s(e[1].slice(1).map((e=>"string"==typeof e?e:`{${Qe(e)}}`)).join("")):s(`{${Qe(e[1])}}`);if("IS NULL"===r||"IS NOT NULL"===r)return s(`${Qe(e[1],n[r])} ${r}`);if("LIKE"===r||"NOT LIKE"===r)return e[3]?s(`${Qe(e[1],n[r])} ${r} ${Qe(e[2],n[r])} ESCAPE ${Qe(e[3],n[r])}`):s(`${Qe(e[1],n[r])} ${r} ${Qe(e[2],n[r])}`);if("CASE"===r){const t=["CASE"];for(let n=1;n<e.length-1;n+=2){if(!Array.isArray(e[n])&&e[n]){null!=e[n+1]&&t.push("ELSE",Qe(e[n+1]));break}t.push("WHEN",Qe(e[n]),"THEN",Qe(e[n+1]))}return t.push("END"),t.join(" ")}if(r in n){const t=e.slice(1).map(((t,r)=>Qe(t,n[e[0]]+Math.min(r-1,0))));return s("NOT"===r?`${r} ${t[0]}`:t.join(` ${r} `))}throw new Error(`Unrecognized operator ${e[0]}`)}const Ye=Array.isArray,Ge=new WeakMap,Ze={};function Xe(e,t){let n=!0;for(;n;){n=!1;for(let r=2;r<e.length;++r){const s=t(e[r-1],e[r],r-2);s!==Ze&&(n=!0,(e=e.slice()).splice(r-1,2,s))}}return 2===e.length?e[1]:e}function et(e,t="",n=""){const r={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."};let s=function(e,t){const n=e.split("");for(let e=0;e<n.length;++e){const r=n[e];if(r===t)n[e]=n[e+1]||"",n[e+1]="";else if("_"===r)n[e]="\\_";else if("%"===r)for(n[e]="\\%";"%"===n[e+1];)n[++e]=""}return n.filter((e=>e))}(e,t);if(!s.length)return new RegExp("^$",n);s=s.map((e=>r[e]||e)),s[0]=".*"===s[0]?"":"^"+s[0];const o=s.length-1;return s[o]=[".*",""].includes(s[o])?"":s[o]+"$",new RegExp(s.join(""),n)}function tt(e,t){return"boolean"==typeof e&&(e=+e),"boolean"==typeof t&&(t=+t),typeof e!=typeof t?"string"==typeof e?1:-1:e>t?1:e<t?-1:0}function nt(e){switch(typeof e){case"number":return e;case"boolean":return+e;case"string":return parseFloat(e)||0}}function rt(e){switch(typeof e){case"string":return e;case"number":return e.toString();case"boolean":return(+e).toString()}}function st(e){if(!Array.isArray(e))return e;if("CASE"===e[0]){for(let t=1;t<e.length;t+=2){if(Array.isArray(e[t]))return e;if(e[t])return e[t+1]}return null}if("FUNC"===e[0]){if("COALESCE"===e[1]){const t=[];for(let n=2;n<e.length;++n){const r=e[n];if(null!=r&&(t.push(r),!Array.isArray(r)))break}return t.length?1===t.length?t[0]:["FUNC","COALESCE",...t]:null}if("UPPER"===e[1]){if(null==e[2])return null;if(!Ye(e[2]))return rt(e[2]).toUpperCase()}else if("LOWER"===e[1]){if(null==e[2])return null;if(!Ye(e[2]))return rt(e[2]).toLowerCase()}else if("ROUND"===e[1]){const t=e[2],n=e.length>3?e[3]:0;if(null==t||null==n)return null;if(!Ye(t)&&!Ye(n)){const e=10**n,r=t*e*(1+Number.EPSILON);return Math.round(r)/e}}}else if("PARAM"===e[0]){if(null==e[1])return null}else{if("AND"===e[0]){for(let t=1;t<e.length;++t)if(!Array.isArray(e[t])&&null!=e[t]&&!e[t])return!1;const t=[];for(let n=1;n<e.length;++n){const r=e[n];if(null==r)return null;Array.isArray(r)&&("AND"===r[0]?t.push(...r.slice(1)):t.push(r))}return!t.length||(1===t.length&&t.push(!0),["AND",...t])}if("OR"===e[0]){const t=[];for(let n=1;n<e.length;++n){const r=e[n];if(Array.isArray(r))"OR"===r[0]?t.push(...r.slice(1)):t.push(r);else if(r)return!0}return t.length?(1===t.length&&t.push(!1),["OR",...t]):!!e.some((e=>null==e))&&null}if("NOT"===e[0]){if(null==e[1])return null;if(!Ye(e[1]))return!e[1];if("NOT"===e[1][0])return e[1][1]}else{if("IS NULL"===e[0])return Ye(e[1])?e:null==e[1]||null;if("IS NOT NULL"===e[0])return Ye(e[1])?e:null!=e[1]||null;if("LIKE"===e[0]){if(Ye(e[1])||Ye(e[2])||Ye(e[3]))return e;if(null==e[1]||null==e[2]||e.length>=4&&null==e[3])return null;let t=Ge.get(e);return t||(t=et(e[2],e[3]),Ge.set(e,t)),t.test(e[1])}if("NOT LIKE"===e[0]){if(Ye(e[1])||Ye(e[2])||Ye(e[3]))return e;if(null==e[1]||null==e[2]||e.length>=4&&null==e[3])return null;let t=Ge.get(e);return t||(t=et(e[2],e[3]),Ge.set(e,t)),!t.test(e[1])}if("="===e[0])return null==e[1]||null==e[2]?null:Ye(e[1])||Ye(e[2])?e:0===tt(e[1],e[2]);if("<>"===e[0])return null==e[1]||null==e[2]?null:Ye(e[1])||Ye(e[2])?e:0!==tt(e[1],e[2]);if(">"===e[0])return null==e[1]||null==e[2]?null:Ye(e[1])||Ye(e[2])?e:tt(e[1],e[2])>0;if(">="===e[0])return null==e[1]||null==e[2]?null:Ye(e[1])||Ye(e[2])?e:tt(e[1],e[2])>=0;if("<"===e[0])return null==e[1]||null==e[2]?null:Ye(e[1])||Ye(e[2])?e:tt(e[1],e[2])<0;if("<="===e[0])return null==e[1]||null==e[2]?null:Ye(e[1])||Ye(e[2])?e:tt(e[1],e[2])<=0;if("*"===e[0])return Xe(e,((e,t)=>null==e||null==t?null:Ye(e)||Ye(t)?Ze:nt(e)*nt(t)));if("/"===e[0])return Xe(e,((e,t,n)=>null==e||null==t?null:Ye(e)||Ye(t)?Ze:0===n?nt(e)/nt(t):nt(e)*nt(t)));if("+"===e[0])return Xe(e,((e,t)=>null==e||null==t?null:Ye(e)||Ye(t)?Ze:nt(e)+nt(t)));if("-"===e[0])return Xe(e,((e,t,n)=>null==e||null==t?null:Ye(e)||Ye(t)?Ze:0===n?nt(e)-nt(t):nt(e)+nt(t)));if("||"===e[0])return Xe(e,((e,t)=>null==e||null==t?null:Ye(e)||Ye(t)?Ze:rt(e)+rt(t)))}}return e}function ot(e,t,n,r){return Je(e,(e=>{if(r&&(e=r(e)),!Ye(e))return e;if("FUNC"===e[0]&&"NOW"===e[1]){if(n)return n}else if("PARAM"===e[0]){if(null==e[1])return null;if(t&&!Ye(e[1])){let n;return n="function"==typeof t?t(e[1]):t[e[1]],null==n?null:("object"==typeof n&&(n=n.value?n.value[0]:null),n)}}return st(e)}))}function it(e,t){if(null!=e&&!e)return!1;if(null!=t&&!t)return!1;if(!Array.isArray(e)&&!Array.isArray(t))return null!=e&&null!=t||null;if(!Array.isArray(t)&&"AND"===e[0])return e;if(!Array.isArray(e)&&"AND"===t[0])return t;const n=["AND"];return Array.isArray(e)&&"AND"===e[0]?n.push(...e.slice(1)):n.push(e),Array.isArray(t)&&"AND"===t[0]?n.push(...t.slice(1)):n.push(t),n}function at(e,t){if(!Array.isArray(e)&&e)return!0;if(!Array.isArray(t)&&t)return!0;if(!Array.isArray(e)&&!Array.isArray(t))return(null==e||null==t)&&null;if(!Array.isArray(t)&&"OR"===e[0])return e;if(!Array.isArray(e)&&"OR"===t[0])return t;const n=["OR"];return Array.isArray(e)&&"OR"===e[0]?n.push(...e.slice(1)):n.push(e),Array.isArray(t)&&"OR"===t[0]?n.push(...t.slice(1)):n.push(t),n}let lt=new Map,ct=new Map;const ut=new WeakMap;function ft(e){if(null===e)return"null";if(void 0===e)return"undefined";const t=typeof e;if("number"===t||"boolean"===t||"string"===t)return`${t}:${e}`;if("function"!==t&&"object"!==t)throw new Error(`Cannot memoize ${t} arguments`);let n=ut.get(e);if(!n){n=`${t}:${Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER).toString(36)}`,ut.set(e,n)}return n}function dt(e){const t=ft(e);return(...n)=>{const r=JSON.stringify(n.map(ft))+t;if(lt.has(r))return lt.get(r);let s;return ct.has(r)?lt.set(r,s=ct.get(r)):(lt.set(r,s=e(...n)),s instanceof Promise&&s.catch((()=>{lt.delete(r),ct.delete(r)}))),s}}const ht=setInterval((()=>{ct=lt,lt=new Map}),12e4);ht.unref&&ht.unref();const pt=new Set;function mt(e,t,n){const r={type:e,message:t,timestamp:Date.now(),actions:n};return pt.add(r),N.redraw(),n||setTimeout((()=>{gt(r)}),4e3),r}function gt(e){pt.delete(e),N.redraw()}const vt=window.clientConfig,yt=window.configSnapshot,wt=window.genieacsVersion;function bt(e,t){return e+t}function At(e,t){return e*t}function St(e,t){return e/t}function xt(e,t){return e%t}function Ot(e){return Number(e)}function kt(e,t){return e!==t}function Ct(e,t){return e<t}const Et=BigInt;function Nt(e,t){return e&t}function Dt(e,t){return e|t}function Pt(e,t){return e^t}function $t(e){return~e}function jt(e,t){return e<<t}function zt(e,t){return e>>t}function It(e){return Number(e)}function _t(e,t){return e===t}function Lt(e,t){return e!==t}function Mt(e,t){return e>=t}function Rt(e,t){return BigInt.asIntN(e,t)}const Tt=BigInt,Ut=Tt(0),Ft=Tt(1),Wt=$t(Ut),Bt=Tt(32),qt=[];for(let e=0;e<=512;++e){const t=jt(Ft,Tt(e));qt.push(t)}const Jt=qt.filter(((e,t)=>t%2==0)).reduce(((e,t)=>Dt(e,t)));function Vt(e){const t=[];let n=0;for(;Lt(e,Ut);){let r=It(Rt(32,e));e=zt(e,Bt);let s=Math.clz32(r);for(;s<32;){const e=31-s;t.push(n+e),r^=1<<e,s=Math.clz32(r)}n+=32}return t}function Kt(e){const t=1431655765,n=[];let r=0;for(;Lt(e,Ut);){let s=It(Rt(32,e));s=s&t|s>>1&t,e=zt(e,Bt);let o=Math.clz32(s);for(;o<32;){const e=31-o;n.push(r+e),s^=1<<e,o=Math.clz32(s)}r+=32}return n}function Ht(e,t){const n=new Map;for(const r of t){const t=r-r%2;if(n.has(t))continue;const s=new Set;for(const t of e)(t.set.has(r)||t.set.has(r+1))&&s.add(t);s.size&&n.set(t,s)}if(n.size<=1)return[e];for(const t of e){let r=-1;for(const[s,o]of n)if(o.has(t))if(-1!==r){if(n.set(r,new Set([...n.get(r),...o])),n.delete(s),1===n.size)return[e]}else r=s}return[...n.values()].map((e=>[...e]))}function Qt(e){return Dt(jt(Nt(e,Jt),Ft),Nt(zt(e,Ft),Jt))}function Yt(e,t=512){let n=0;for(;n<t&&Lt(e,Ut);++n)e=Nt(e,e-Ft);return n}class Gt{constructor(e,t,n){this._bigint=e,this._set=t,this._hash=n}get bigint(){return this._bigint}get set(){return this._set}get hash(){return this._hash}raise(e){if(!this._set.has(e))return this;const t=Pt(this._bigint,qt[e]),n=new Set(this._set);n.delete(e);const r=this._hash^1<<e;return new Gt(t,n,r)}covers(e){return this.set.size<=e.set.size&&_t(Nt(this.bigint,e.bigint),this.bigint)}static parse(e){const t=e.split("");let n=Ut,r=0;const s=new Set;for(const[e,o]of t.entries()){if("-"===o)continue;const t=2*e;if("0"===o)n=Dt(n,qt[t]),s.add(t),r^=1<<t;else if("1"===o)n=Dt(n,qt[t+1]),s.add(t+1),r^=2<<t;else{if("/"!==o)throw new Error("Invalid cube string");n=Dt(n,qt[t]),s.add(t),n=Dt(n,qt[t+1]),s.add(t+1),r^=3<<t}}return new Gt(n,s,r)}toString(){let e=this.bigint.toString(2);e.length%2&&(e="0"+e);return e.match(/.{2}/g).reverse().map((e=>"00"===e?"-":"01"===e?"0":"10"===e?"1":"/")).join("")}static from(e){let t=Ut,n=0;const r=new Set;for(const s of e)r.add(s),n^=1<<s,t=Dt(t,qt[s]);return new Gt(t,r,n)}static fromBigInt(e){let t=0;const n=new Set;let r=0,s=e;for(;Lt(s,Ut);){let e=It(Rt(32,s));t^=e,s=zt(s,Bt);let o=Math.clz32(e);for(;o<32;){const t=31-o;n.add(r+t),e^=1<<t,o=Math.clz32(e)}r+=32}return new Gt(e,n,t)}}class Zt{constructor(e,t,n){this._cubes=e,this._count=t,this._bigint=n}static from(e){const t=[];let n=Ut;const r=[];for(const s of e){n=Dt(n,s.bigint),t.push(s);for(const e of s.set){for(;r.length<=e+1-e%2;)r.push(0);++r[e]}}return new Zt(t,r,n)}get bigint(){return this._bigint}get cubes(){return this._cubes}count(e){return this._count[e]}filter(e){const t=this._count.slice();let n=this._bigint;const r=this._cubes.filter((r=>{if(e(r))return!0;for(const e of r.set)--t[e]||(n=Pt(n,qt[e]));return!1}));return new Zt(r,t,n)}pop(){const e=this._cubes.pop();if(e){for(const t of e.set)--this._count[t]||(this._bigint=Pt(this._bigint,qt[t]));return e}}push(e){const t=this._cubes.push(e);for(const t of e.set)++this._count[t];return this._bigint=Dt(this._bigint,e.bigint),t}unshift(e){const t=this._cubes.unshift(e);for(const t of e.set)++this._count[t];return this._bigint=Dt(this._bigint,e.bigint),t}}function Xt(e,t=Ut,n=Nt(e.bigint,$t(Dt(t,Qt(t))))){let r=!1,s=!1;do{if(r=!1,e=e.filter((e=>{if(Lt(Nt(t,e.bigint),Ut))return!1;const o=Nt(e.bigint,n),i=Yt(o,2);return 1===i?(r=!0,t=Dt(t,o),n=_t(Nt(Jt,o),Ut)?Pt(n,zt(o,Ft)):Pt(n,jt(o,Ft)),!1):(0===i&&(s=!0),!0)})),s)return!0}while(r);if(e.cubes.length<=1)return!1;let o=-1,i=0,a=0,l=0;const c=Kt(n=Nt(e.bigint,n)),u=new Set;for(const r of c){const s=e.count(r),c=e.count(r+1),f=s+c;if(s&&c){if(f>=i){const e=Math.min(s,c);(f>i||e>a)&&(o=r,i=f,a=e)}}else{if(f===e.cubes.length)return!1;u.add(r),t=Dt(t,qt[s?r:r+1]),n=Pt(n,qt[s?r+1:r])}l=Math.max(l,f)}if(-1===o)return!1;if(3*l<e.cubes.length&&c.length-u.size>8){const r=Ht(e.cubes,c.filter((e=>!u.has(e))));if(r.length>1){for(const e of r)if(!Xt(Zt.from(e),t,n))return!1;return!0}}return!!Xt(e,Dt(t,qt[o]),Pt(n,qt[o+1]))&&Xt(e,Dt(t,qt[o+1]),Pt(n,qt[o]))}function en(e,t=Ut,n=e.bigint){let r=!1,s=!1;do{if(r=!1,e=e.filter((e=>{if(Lt(Nt(t,e.bigint),Ut))return!1;const o=Nt(e.bigint,n),i=Yt(o,2);return 1===i?(r=!0,t=Dt(t,o),n=_t(Nt(Jt,o),Ut)?Pt(n,zt(o,Ft)):Pt(n,jt(o,Ft)),!1):(0===i&&(s=!0),!0)})),s)return[]}while(r);if(!e.cubes.length)return[Gt.fromBigInt(Qt(t))];n=Nt(e.bigint,n);const o=[];if(1===e.cubes.length){const e=Qt(t);for(const t of Vt(n))o.push(Gt.fromBigInt(Dt(e,qt[1^t])));return o}let i=-1,a=0,l=0,c=0;const u=Kt(n),f=new Set;for(const r of u){const s=e.count(r),u=e.count(r+1),d=s+u;if(s&&u){if(d>=a){const e=Math.min(s,u);(d>a||e>l)&&(i=r,a=d,l=e)}}else d===e.cubes.length&&(f.add(r),o.push(Gt.fromBigInt(Qt(Dt(t,qt[s?r:r+1])))),n=Pt(n,qt[s?r:r+1]));c=Math.max(c,d)}if(3*c<e.cubes.length&&u.length-f.size>8){const r=Ht(e.cubes,u.filter((e=>!f.has(e))));if(r.length>1){let e=en(Zt.from(r.pop()),t,n);for(const s of r){if(!e.length)return o;const r=en(Zt.from(s),t,n),i=[];for(const t of e)for(const e of r)i.push(Gt.fromBigInt(Dt(t.bigint,e.bigint)));e=i}return[...o,...e]}}if(-1===i)return tn(e,o,t,n),o;const d=en(e,Dt(t,qt[i]),Pt(n,qt[i+1]));let h=en(e,Dt(t,qt[i+1]),Pt(n,qt[i]));const p=3<<i,m=Dt(qt[i],qt[i+1]),g=new Set;e:for(const[e,t]of d.entries()){const n=t.hash^p;for(const r of h)if(r.hash===n&&_t(Pt(t.bigint,r.bigint),m)){d[e]=Gt.fromBigInt(Nt(t.bigint,r.bigint)),g.add(r);continue e}}return g.size&&(h=h.filter((e=>!g.has(e)))),[...o,...d,...h]}function tn(e,t,n,r){let s=!1,o=!1,i=512,a=Ut;do{if(i=512,a=Ut,s=!1,e=e.filter((e=>{if(Lt(Nt(n,e.bigint),Ut))return!1;const t=Nt(e.bigint,r),l=Yt(t,i);return 1===l?(s=!0,n=Dt(n,t),!1):(l<i&&(a=t,i=l),0===l&&(o=!0),!0)})),o)return}while(s);if(!e.cubes.length)return void t.push(Gt.fromBigInt(Qt(n)));const l=Vt(a);if(1===e.cubes.length){const e=Qt(n);for(const n of l)t.push(Gt.fromBigInt(Dt(e,qt[1^n])));return}let c=-1,u=0;for(const t of l){const n=e.count(t);n>u&&(c=t,u=n)}tn(e,t,Dt(n,qt[c]),r),tn(e,t,n,Pt(r,qt[c]))}function nn(e,t){return Xt(e,Qt(t.bigint))}function rn(e,t,n,r){const s=Qt(e.bigint);let o=n.map((e=>new Set(Vt(Nt(s,e.bigint)))));o=o.filter((e=>e.size));let i=t.map((e=>new Set(Vt(Nt(s,e.bigint)))));i=i.filter((e=>e.size));const a=new Set;for(const t of e.set)a.add(1^t);const l=[];for(let e=Math.max(...a);e>=0;--e)l.push(0);for(const e of i)for(const t of e)++l[t];for(;i.length&&o.length;){const t=new Set;for(const e of o)1===e.size&&t.add(...e);if(t.size){for(const e of t)a.delete(e),o=o.filter((t=>!t.has(e))),i=i.filter((t=>!t.has(e)));const n=new Set(a);for(const e of o)for(const t of e)n.delete(t);for(const t of n)a.delete(t),e=e.raise(1^t),i=i.filter((e=>!(e.delete(t)&&!e.size)));if(!o.length||!i.length)break}const n=new Set;for(const e of i)1===e.size&&n.add(...e);if(n.size){let t=0,s=-1;for(const o of n)l[o]>t&&r(1^o,e.set)&&(t=l[o],s=o);if(s>=0){a.delete(s),e=e.raise(1^s),i=i.filter((e=>!(e.delete(s)&&!e.size)));for(const e of o)e.delete(s);continue}}let s=0,c=-1;for(const t of a)l[t]>s&&r(1^t,e.set)&&(s=l[t],c=t);if(c<0){a.clear();break}a.delete(c),e=e.raise(1^c);for(const e of i)e.delete(c);for(const e of o)e.delete(c)}if(o.length){const e=an(o);for(const t of e)a.delete(t)}for(const t of a)r(1^t,e.set)&&(e=e.raise(1^t));return e}function sn(e,t,n,r){const s=Qt(e.bigint);let o=t.map((e=>new Set(Vt(Nt(s,e.bigint)))));o=o.filter((e=>e.size));const i=[...e.set].map((e=>1^e)),a=[];for(let e=Math.max(...i);e>=0;--e)a.push(0);for(const e of o)for(const t of e)++a[t];for(;i.length;){const t=new Set;for(const e of o)1===e.size&&t.add(...e);i.sort(((e,n)=>+t.has(e)-+t.has(n)||a[e]-a[n]));const s=[];for(;i.length;){const t=i.pop();if(!r(1^t,e.set)){s.unshift(t);continue}const a=e.raise(1^t);if(!nn(n,a)){o=o.filter((e=>!e.has(t))),i.push(...s);break}e=a;for(const e of o)e.delete(t);o=o.filter((e=>e.size)),i.push(...s.splice(0))}}return e}function on(e,t,n,r,s){if(!e.length)return e;(e=e.slice()).sort(((e,t)=>e.set.size-t.set.size));const o=e[0];do{let o=e[0];r.has(o)||(o=n?rn(o,e,n,s):sn(o,e,Zt.from([...e,...t]),s)),(e=e.filter((e=>!o.covers(e)))).push(o)}while(e[0].set.size>=o.set.size&&Lt(e[0].bigint,o.bigint));return e}function an(e){let t=new Set;const n=function(e){const t=new Map,n=e.length;for(let e=0;e<n;++e)t.set(e,new Set);for(let r=0;r<n;++r){const s=e[r],o=t.get(r);for(let i=r+1;i<n;++i){const n=e[i];let a=!1;for(const e of s)if(n.has(e)){a=!0;break}if(!a){const e=t.get(i);o.add(i),e.add(r)}}}const r=Array.from(e.keys());r.sort(((e,n)=>t.get(n).size-t.get(e).size));let s=[],o=0,i=0;return function e(r,a,l){if(i>n)return;if(!a.length&&!l.length){if(++i,r.length>=s.length){const e=r.reduce(((e,n)=>e+t.get(n).size),0);(e>o||r.length>s.length)&&(s=r,o=e,i=0)}return}const c=new Set,u=t.get(a[0]);for(const n of a){if(u.has(n))continue;const o=t.get(n),i=a.filter((e=>o.has(e)&&!c.has(e))),f=l.filter((e=>o.has(e)));if(e([...r,n],i,f),s.length>r.length+a.length)return;l.push(n),c.add(n)}}([],r,[]),s.map((t=>e[t]))}(e);let r=e;for(const s of n){const n=new Map;for(const t of e)for(const e of t)if(s.has(e)){let r=n.get(e);r||n.set(e,r=new Set),r.add(t)}const[o,i]=Array.from(n).reduce(((e,t)=>t[1].size>e[1].size?t:e));r=r.filter((e=>!i.has(e))),t.add(o)}return t=function(e,t){let n=e.map((e=>new Set([...e].filter((e=>t.has(e))))));const r=new Set;for(;;){for(const e of n)if(1===e.size){const[t]=e;r.add(t)}if(n=n.filter((e=>{for(const t of e)if(r.has(t))return!1;return e.size>1})),!n.length)break;const e=new Map;for(const t of n){for(const n of t)e.has(n)||e.set(n,new Set);if(2===t.size){const[n,r]=t,s=e.get(n),o=e.get(r);s.add(r),o.add(n)}}const t=Array.from(e).reduce(((e,t)=>t[1].size<e[1].size?t:e))[0];for(const e of n)e.delete(t)}return r}(e,t),r.length&&(t=new Set([...t,...an(r)])),t}function ln(e,t,n,r){let s=!1,o=!1;const i=[];do{if(s=!1,e=e.filter((e=>{if(Lt(Nt(n,e.bigint),Ut))return!1;const a=Nt(e.bigint,r),l=Yt(a,2);if(1===l&&!t.has(e))return s=!0,n=Dt(n,a),r=_t(Nt(Jt,a),Ut)?Pt(r,zt(a,Ft)):Pt(r,jt(a,Ft)),!1;if(0===l){const n=t.get(e);if(null!=n)return i.push(n),!1;o=!0}return!0})),o)return[]}while(s);if(e.cubes.length<=1)return[new Set(i)];let a=-1,l=0,c=0,u=0;const f=Kt(r=Nt(e.bigint,r)),d=new Set;for(const t of f){const s=e.count(t),o=e.count(t+1),i=s+o;if(s&&o){if(i>=l){const e=Math.min(s,o);(i>l||e>c)&&(a=t,l=i,c=e)}}else d.add(t),n=Dt(n,qt[s?t:t+1]),r=Pt(r,qt[s?t+1:t]);u=Math.max(u,i)}if(-1===a)return[new Set(i)];if(3*u<e.cubes.length&&f.length-d.size>8){const s=Ht(e.cubes,f.filter((e=>!d.has(e))));if(s.length>1){let e=[new Set(i)];for(const o of s){const s=e;e=ln(Zt.from(o),t,n,r);const i=[];for(const t of e)for(const e of s)i.push(new Set([...t,...e]));e=i}return e}}let h=ln(e,t,Dt(n,qt[a]),Pt(r,qt[a+1])),p=ln(e,t,Dt(n,qt[a+1]),Pt(r,qt[a]));const m=new Set,g=new Set;for(const e of h)for(const t of p)if(e.size<=t.size){let n=!0;for(const r of e)if(!t.has(r)){n=!1;break}n&&g.delete(t)}else{let n=!0;for(const r of t)if(!e.has(r)){n=!1;break}n&&m.delete(e)}return m.size&&(h=h.filter((e=>!m.has(e)))),g.size&&(p=p.filter((e=>!g.has(e)))),[...h,...p].map((e=>new Set([...i,...e])))}function cn(e,t,n){const r=an(function(e,t,n){const r=new Map,s=new WeakMap;for(const[t,n]of e.entries())s.set(n,t);const o=Zt.from([...e,...t,...n]);for(const t of e){const e=Qt(t.bigint),n=ln(o,s,e,Nt(o.bigint,$t(Dt(t.bigint,e))));for(const e of n){let t=0;for(const n of e)t^=1<<n;const n=r.get(t);if(!n){r.set(t,[e]);continue}let s=!1;e:for(const t of n)if(t.size===e.size){for(const n of t)if(!e.has(n))continue e;s=!0;break}s||n.push(e)}}return[...r.values()].flat()}(e,t,n));return e.filter(((e,t)=>r.has(t)))}function un(e,t){const[n,r]=function(e,t){const n=Zt.from([...t,...e]),r=[],s=[];for(let t=0;t<e.length;++t){const e=n.pop();nn(n,e)?s.push(e):r.push(e),n.unshift(e)}return[r,s]}(e,t),s=cn(function(e,t,n){const r=Zt.from([...n,...t]);return e.filter((e=>!nn(r,e)))}(r,n,t),n,t);return[...n,...s]}function fn(e,t,n){let r=!1,s=!1;do{if(r=!1,e=e.filter((e=>{if(Lt(Nt(t,e.bigint),Ut))return!1;const o=Nt(e.bigint,n),i=Yt(o,2);return 1===i?(r=!0,t=Dt(t,o),n=_t(Nt(Jt,o),Ut)?Pt(n,zt(o,Ft)):Pt(n,jt(o,Ft)),!1):(0===i&&(s=!0),!0)})),s)return Wt}while(r);if(e.cubes.length<=1)return t;let o=-1,i=0,a=0,l=0;const c=Kt(n=Nt(e.bigint,n)),u=new Set;for(const t of c){const n=e.count(t),r=e.count(t+1),s=n+r;if(n&&r){if(s>=i){const e=Math.min(n,r);(s>i||e>a)&&(o=t,i=s,a=e)}}else u.add(t),e=n?e.filter((e=>!e.set.has(t))):e.filter((e=>!e.set.has(t+1)));l=Math.max(l,s)}if(-1===o)return t;if(3*l<e.cubes.length&&c.length-u.size>8){const r=Ht(e.cubes,c.filter((e=>!u.has(e))));let s=Wt;if(r.length>1){for(const e of r)s=Nt(s,fn(Zt.from(e),t,n));return s}}return Nt(fn(e,Dt(t,qt[o]),Pt(n,qt[o+1])),fn(e,Dt(t,qt[o+1]),Pt(n,qt[o])))}function dn(e,t,n){!function(e){if(e.length<=1)return;const t=e.reduce(((e,t)=>t.set.size<=e.set.size?t:e));e.sort(((e,n)=>{const r=Yt(Nt(e.bigint,t.bigint)),s=e.set.size-r+(t.set.size-r),o=Yt(Nt(n.bigint,t.bigint));return s-(n.set.size-o+(t.set.size-o))}))}(e=e.slice());for(let r=e.length;r>0;--r){const r=e.shift(),s=Qt(r.bigint),o=Dt(r.bigint,s),i=[...e,...t].filter((e=>_t(Nt(s,e.bigint),Ut))),a=fn(Zt.from(i),s,$t(o));Mt(a,Ut)&&(_t(a,s)?(e.push(r),n.add(r)):e.push(Gt.fromBigInt(Qt(a))))}return e}function hn(e,t,n,r){const s=function(e,t){const n=[];for(let r=e.length;r>0;--r){const r=e.shift(),s=Qt(r.bigint),o=Dt(r.bigint,s),i=[...e,...t].filter((e=>_t(Nt(s,e.bigint),Ut))),a=fn(Zt.from(i),s,$t(o));Lt(a,s)&&Mt(a,Ut)&&n.push(Gt.fromBigInt(Qt(a))),e.push(r)}return n}(e,t),o=[],i=r?null:Zt.from([...e,...t]);for(let e=s.length;e>0;--e){const e=s.shift(),t=r?rn(e,s,r,n):sn(e,s,i,n);for(const e of s)t.covers(e)&&o.push(t);s.push(e)}return o.length?un([...e,...o],t):e}function pn(e){return e.reduce(((e,t)=>e+t.set.size),0)}function mn(e,t,n,r=(()=>!0)){if(!e.length)return e;const s=new WeakSet,o=function(e,t){const n=[...t,...e],r=[];for(let t=0;t<e.length;++t){const e=n.pop(),t=Qt(e.bigint),s=[];for(const e of n){const n=Nt(t,e.bigint),r=Yt(n,2);0===r?s.push(e):1===r&&s.push(Gt.fromBigInt(Pt(e.bigint,n)))}Xt(Zt.from(s),t)||r.push(e),n.unshift(e)}return r}(e=un(e=on(e,t,n,s,r),t),t);o.length&&(e=e.filter((e=>!o.includes(e))),t=[...t,...o]);let i=pn(e);for(;;){let o=dn(e,t,s);o=on(o,t,n,s,r),o=un(o,t);let a=pn(o);if(a>=i&&(o=hn(e,t,r,n),a=pn(o),a>=i))break;i=a,e=o}return[...o,...e]}function gn(e){return e.map((e=>Gt.from(e)))}function vn(e){return e.map((e=>[...e.set]))}function yn(e){return vn(en(Zt.from(gn(e))))}function wn(e,t=[],n={}){const r=gn(e),s=gn(t);return vn(mn(r,s,n.computeOffSet?en(Zt.from([...r,...s])):void 0,n.canRaise))}const bn=Et(0),An=Et(1),Sn=Et(2),xn=Et(-1);class On{constructor(e){this.map=new Map,e?(this.map.set(e,1),this.sortedKeys=[e]):this.sortedKeys=[]}reciprocal(){const e=new On;e.sortedKeys=this.sortedKeys,e.map=new Map;for(const[t,n]of this.map)e.map.set(t,0-n);return e}static multiply(e,t){const n=new On;n.sortedKeys=e.sortedKeys.slice(),n.map=new Map(e.map);for(const[e,r]of t.map){const t=n.map.get(e);if(t){const s=r+t;s?n.map.set(e,s):(n.map.delete(e),n.sortedKeys=n.sortedKeys.filter((t=>t!==e)))}else n.map.set(e,r),n.sortedKeys.push(e)}return n.sortedKeys.sort(((e,t)=>e.length!==t.length?t.length-e.length:e>t?1:e<t?-1:0)),n}static compare(e,t){if(e.sortedKeys.length!==t.sortedKeys.length)return t.sortedKeys.length-e.sortedKeys.length;for(let n=0;n<e.sortedKeys.length;++n){const r=e.sortedKeys[n],s=e.map.get(r),o=t.sortedKeys[n],i=t.map.get(o);if(s!==i)return i-s;if(r.length>o.length)return-1;if(r.length<o.length)return 1;if(r>o)return 1;if(r<o)return-1}return 0}}function kn(e,t){for(;kt(t,bn);){const n=t;t=xt(e,t),e=n}return e}class Cn{constructor(e){this.terms=e}static simplifyTerms(e){const t=e.slice().sort(((e,t)=>On.compare(e.indeterminates,t.indeterminates)));for(let e=1;e<t.length;++e){const n=t[e-1],r=t[e];if(0===On.compare(n.indeterminates,r.indeterminates)){const s=bt(At(n.coefficientNumerator,r.coefficientDenominator),At(r.coefficientNumerator,n.coefficientDenominator)),o=At(n.coefficientDenominator,r.coefficientDenominator),i=kn(s,o);t[e]={indeterminates:r.indeterminates,coefficientNumerator:St(s,i),coefficientDenominator:St(o,i)},t[e-1]={indeterminates:n.indeterminates,coefficientNumerator:bn,coefficientDenominator:n.coefficientDenominator}}}return t.filter((e=>kt(e.coefficientNumerator,bn)))}static fromIndeterminate(e){const t=new On(JSON.stringify(e));return new Cn([{indeterminates:t,coefficientNumerator:An,coefficientDenominator:An}])}static fromConstant(e){const[t,n]=Math.abs(e).toString(2).split(".",2);let r=Et("0b"+t);e<0&&(r=At(r,xn));let s=An;var o,i;n&&(o=Sn,i=Et(n.length),s=o**i,r=bt(At(r,s),Et("0b"+n)));const a=[{indeterminates:new On,coefficientNumerator:r,coefficientDenominator:s}];return new Cn(a)}negation(){const e=this.terms.map((e=>({indeterminates:e.indeterminates,coefficientNumerator:At(e.coefficientNumerator,xn),coefficientDenominator:e.coefficientDenominator})));return new Cn(e)}reciprocal(){const e=this.terms.map((e=>({indeterminates:e.indeterminates.reciprocal(),coefficientNumerator:e.coefficientDenominator,coefficientDenominator:e.coefficientNumerator})));return new Cn(e)}constant(){const e=this.terms.filter((e=>!e.indeterminates.sortedKeys.length));return new Cn(e)}add(e){return new Cn(Cn.simplifyTerms(this.terms.concat(e.terms)))}subtract(e){return this.add(e.negation())}multiply(e){const t=[];for(const n of this.terms)for(const r of e.terms){const e=At(n.coefficientNumerator,r.coefficientNumerator),s=At(n.coefficientDenominator,r.coefficientDenominator),o=kn(e,s);t.push({indeterminates:On.multiply(n.indeterminates,r.indeterminates),coefficientNumerator:St(e,o),coefficientDenominator:St(s,o)})}return new Cn(Cn.simplifyTerms(t))}divide(e){return this.multiply(e.reciprocal())}toString(){const e=[];for(const t of this.terms){const n=Ot(t.coefficientNumerator)/Ot(t.coefficientDenominator),r=[];if(t.indeterminates.sortedKeys.length){for(const e of t.indeterminates.sortedKeys){const n=t.indeterminates.map.get(e);for(let t=Math.abs(n);t>0;--t)n>0?r.push(e):r.push(`["/",1,${e}]`)}1!==n&&r.push(n.toString()),r.length>1?e.push(`["*",${r.join(",")}]`):e.push(r[0])}else e.push(n.toString())}return e.length?1===e.length?e[0]:`["+",${e.join(",")}]`:"0"}}class En{}class Nn extends En{true(){return[[]]}false(){return[]}null(){return[]}}class Dn extends En{true(){return[]}false(){return[[]]}null(){return[]}}class Pn extends En{true(){return[]}false(){return[]}null(){return[[]]}}class $n extends En{constructor(e){if(super(),this.negate=!1,Array.isArray(e)){const t=e[0];"<>"===t?((e=e.slice())[0]="=",this.negate=!0):">="===t?((e=e.slice())[0]="<",this.negate=!0):"<="===t?((e=e.slice())[0]=">",this.negate=!0):"NOT LIKE"===t&&((e=e.slice())[0]="LIKE",this.negate=!0)}this.expStr=JSON.stringify(e)}true(e){let t=e.get(this.expStr);return null==t&&e.set(this.expStr,t=e.size),[[t<<2^(this.negate?1:3)]]}false(e){let t=e.get(this.expStr);return null==t&&e.set(this.expStr,t=e.size),[[t<<2^(this.negate?3:1)]]}null(e){let t=e.get(this.expStr);return null==t&&e.set(this.expStr,t=e.size),[[t<<2,t<<2^2]]}}class jn extends En{constructor(e){super(),this.exprSynth=e}true(e){return this.exprSynth.false(e)}false(e){return this.exprSynth.true(e)}null(e){return this.exprSynth.null(e)}}class zn extends En{constructor(e){super(),this.exprSynth=e}true(e){return this.exprSynth.null(e)}false(e){return[...this.exprSynth.true(e),...this.exprSynth.false(e)]}null(){return[]}}class In extends En{constructor(...e){super(),this.exprSynths=e.filter((e=>!(e instanceof Dn)));const t=[];this.exprSynths=this.exprSynths.filter((e=>!(e instanceof In)||(t.push(...e.exprSynths),!1))),this.exprSynths.push(...t)}true(e){return 0===this.exprSynths.length?[]:1===this.exprSynths.length?this.exprSynths[0].true(e):this.exprSynths.some((e=>e instanceof Nn))?[[]]:this.exprSynths.map((t=>t.true(e))).flat()}false(e){return 0===this.exprSynths.length?[[]]:1===this.exprSynths.length?this.exprSynths[0].false(e):this.exprSynths.some((e=>e instanceof Nn||e instanceof Pn))?[]:yn(this.exprSynths.map((t=>yn(t.false(e)))).flat())}null(e){if(0===this.exprSynths.length)return[];if(1===this.exprSynths.length)return this.exprSynths[0].null(e);const t=this.exprSynths.map((t=>t.null(e))).flat(),n=this.exprSynths.map((t=>t.true(e))).flat();return yn([...yn(t),...n])}}class _n extends En{constructor(...e){super(),this.exprSynths=e.filter((e=>!(e instanceof Nn)));const t=[];this.exprSynths=this.exprSynths.filter((e=>!(e instanceof _n)||(t.push(...e.exprSynths),!1))),this.exprSynths.push(...t)}true(e){return 0===this.exprSynths.length?[[]]:1===this.exprSynths.length?this.exprSynths[0].true(e):this.exprSynths.some((e=>e instanceof Dn||e instanceof Pn))?[]:yn(this.exprSynths.map((t=>yn(t.true(e)))).flat())}false(e){return 0===this.exprSynths.length?[]:1===this.exprSynths.length?this.exprSynths[0].false(e):this.exprSynths.some((e=>e instanceof Dn))?[[]]:this.exprSynths.map((t=>t.false(e))).flat()}null(e){if(0===this.exprSynths.length)return[];if(1===this.exprSynths.length)return this.exprSynths[0].null(e);const t=this.exprSynths.map((t=>t.null(e))).flat(),n=this.exprSynths.map((t=>t.false(e))).flat();return yn([...yn(t),...n])}}class Ln extends En{constructor(e){super(),this.exprSynths=e}true(e){const t=[],n=[];for(let r=0;r<this.exprSynths.length;r+=2){const s=this.exprSynths[r].true(e),o=this.exprSynths[r+1].true(e);t.push(...yn([...n,...yn(s),...yn(o)])),r<this.exprSynths.length-2&&n.push(...yn([...this.exprSynths[r].false(e),...this.exprSynths[r].null(e)]))}return t}false(e){const t=[],n=[];for(let r=0;r<this.exprSynths.length;r+=2){const s=this.exprSynths[r].true(e),o=this.exprSynths[r+1].false(e);t.push(...yn([...n,...yn(s),...yn(o)])),r<this.exprSynths.length-2&&n.push(...yn([...this.exprSynths[r].false(e),...this.exprSynths[r].null(e)]))}return t}null(e){const t=[],n=[];for(let r=0;r<this.exprSynths.length;r+=2){const s=this.exprSynths[r].true(e),o=this.exprSynths[r+1].null(e);t.push(...yn([...n,...yn(s),...yn(o)])),n.push(...yn([...this.exprSynths[r].false(e),...this.exprSynths[r].null(e)]))}return t.push(...yn([...n])),t}}const Mn=Cn.fromConstant(0),Rn=Cn.fromConstant(1),Tn={"=":"=","<>":"<>",">":"<",">=":"<=","<":">","<=":">="};function Un(e){if(!Array.isArray(e))return e;const t=e[0];if("FUNC"===t&&"COALESCE"===e[1]){const t=["CASE"];for(let n=2;n<e.length;++n)t.push(Un(["IS NOT NULL",e[n]]),e[n]);return Un(t)}if("CASE"===t){const t=[];for(let n=1;n<e.length;n+=2){let r=e[n];if(r instanceof Cn&&(r=JSON.parse(r.toString())),!Array.isArray(r)&&!r)continue;const s=e[n+1];if(Array.isArray(s)&&"CASE"===s[0]){for(let e=1;e<s.length;e+=2)t.push([it(r,s[e]),s[e+1]]);if(t.push([r,null]),!Array.isArray(r)&&r)break}else t.push([r,s])}for(;null==t[t.length-1][1];)t.pop();return["CASE",...t.flat()]}const n=new Map;for(const[t,r]of e.entries()){if(!Array.isArray(r))continue;if("CASE"!==r[0])continue;const e=[];for(let t=1;t<r.length;t+=2)e.push([r[t],r[t+1]]);n.set(t,e)}if(n.size){let t=[[!0,e]];for(const[e,r]of n){const n=[];for(const[s,o]of r)n.push(...t.map((t=>{const n=t[1].slice();return n[e]=o,[it(s,t[0]),n]})));t=n}for(const e of t)e[1]=Un(e[1]);if(!0===t[0][0])return t[0][1];for(;null==t[t.length-1][1];)t.pop();return["CASE",...t.flat()]}function r(e){return null==e?null:e instanceof Cn?e:"number"==typeof e?Cn.fromConstant(e):"string"==typeof e?Cn.fromConstant(parseFloat(e)||0):"boolean"==typeof e?Cn.fromConstant(+e):Cn.fromIndeterminate(e)}if("+"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.add(t)),Mn)}if("*"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.multiply(t)),Rn)}if("-"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.subtract(t)))}if("/"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.divide(t)))}if(["=","<>",">",">=","<","<="].includes(t)){if(null==e[1]||null==e[2])return null;let n,r;if(e[1]instanceof Cn?n=e[1]:"number"==typeof e[1]&&(n=Cn.fromConstant(e[1])),e[2]instanceof Cn?r=e[2]:"number"==typeof e[2]&&(r=Cn.fromConstant(e[2])),n||r)if(n||(n=Cn.fromIndeterminate(e[1])),r||(r=Cn.fromIndeterminate(e[2])),n=n.subtract(r),r=n.constant().negation(),n=n.add(r),n.terms.length){let s=1;const o=n.terms[0].coefficientNumerator,i=n.terms[0].coefficientDenominator;(Ct(o,bn)||Ct(i,bn))&&(s*=-1);const a=new Cn([{indeterminates:new On,coefficientNumerator:i,coefficientDenominator:o}]);n=n.multiply(a),r=r.multiply(a);const l=n.terms[0].indeterminates.sortedKeys;let c=n.terms[0].indeterminates.map.get(l[0])<0?-1:0;for(const e of n.terms)for(const t of e.indeterminates.map.values())c+=t;c<0&&(s*=-1,n=n.reciprocal(),r=r.reciprocal()),e=s<0?[Tn[t],n,r]:[t,n,r]}else{if(e=[t,JSON.parse(n.toString()),JSON.parse(r.toString())],"="===t)return e[1]===e[2];if("<>"===t)return e[1]!==e[2];if(">"===t)return e[1]>e[2];if(">="===t)return e[1]>=e[2];if("<"===t)return e[1]<e[2];if("<="===t)return e[1]<=e[2]}}return e=st(e=e.map((e=>e instanceof Cn?JSON.parse(e.toString()):e)))}function Fn(e){return(e=Je(e,Un))instanceof Cn?e=JSON.parse(e.toString()):Array.isArray(e)&&"CASE"===e[0]&&(e=e.map((e=>e instanceof Cn?JSON.parse(e.toString()):e))),e}function Wn(e){return e instanceof En?e:Array.isArray(e)?"CASE"===e[0]?new Ln(e.slice(1).map((e=>Wn(e)))):new $n(e):null==e?new Pn:e?new Nn:new Dn}function Bn(e,t){if(!e.length)return!1;const n=[];for(const r of e){if(!r.length)return!0;const e=[];for(const n of r){let r=t.get(n>>>2);if(!(1&n)!=!(2&n)&&(r=["NOT",r]),Array.isArray(r)&&"NOT"===r[0]&&Array.isArray(r[1])){const e=r[1];r="IS NULL"===e[0]?["IS NOT NULL",...e.slice(1)]:"LIKE"===e[0]?["NOT LIKE",...e.slice(1)]:"="===e[0]?["<>",...e.slice(1)]:"<>"===e[0]?["=",...e.slice(1)]:">"===e[0]?["<=",...e.slice(1)]:">="===e[0]?["<",...e.slice(1)]:"<"===e[0]?[">=",...e.slice(1)]:"<="===e[0]?[">",...e.slice(1)]:"NOT"===e[0]?e[1]:["NOT",e]}e.push(r)}e.length>1?n.push(["AND"].concat(e)):n.push(e[0])}return n.length>1?["OR"].concat(n):n[0]}function qn(e){const t=new Map;for(const[n,r]of e){const e=r[0];if(["=",">","<"].includes(e)&&!Array.isArray(r[2])){const s=JSON.stringify(r[1]);let o=t.get(s);o||t.set(s,o=[]),o.push({op:e,rhs:r[2],var:n})}else if("LIKE"!==e||Array.isArray(r[2])||Array.isArray(r[3])){const e=JSON.stringify(r);let s=t.get(e);s||t.set(e,s=[]),s.push({op:"",rhs:null,var:n})}else{const e=JSON.stringify(r[1]);let s=t.get(e);s||t.set(e,s=[]),s.push({op:"",rhs:null,var:n})}}const n=[],r=new Map;for(const[s,o]of t){const t=e.size;e.set(t,["IS NULL",JSON.parse(s)]),'["PARAM","DeviceID.ID"]'!==s&&'["PARAM","_id"]'!==s||n.push([t<<2^3]);const i=new Map;for(const e of o){if(!e.op)continue;const t=JSON.stringify(e.rhs),n=i.get(t);n?n.set(e.op,e.var):i.set(t,new Map([[e.op,e.var]]))}for(const[t,r]of i)if(r.size>1){if(!r.has("=")){const n=e.size;e.set(n,["=",JSON.parse(s),JSON.parse(t)]),o.push({op:"=",rhs:JSON.parse(t),var:n}),r.set("=",n)}if(!r.has(">")){const n=e.size;e.set(n,[">",JSON.parse(s),JSON.parse(t)]),o.push({op:">",rhs:JSON.parse(t),var:n}),r.set(">",n)}if(!r.has("<")){const n=e.size;e.set(n,["<",JSON.parse(s),JSON.parse(t)]),o.push({op:"<",rhs:JSON.parse(t),var:n}),r.set("<",n)}n.push([r.get("=")<<2^1,r.get(">")<<2^1,r.get("<")<<2^1])}for(let e=0;e<o.length;++e){const s=o[e];if(r.set(s.var,t),n.push([t<<2^3,s.var<<2^1]),n.push([t<<2^3,s.var<<2^3]),n.push([s.var<<2^0,s.var<<2^2,t<<2^2]),s.op)for(let t=e+1;t<o.length;++t){const e=o[t];if(!e.op)continue;let r=0;if(Array.isArray(s.rhs)||Array.isArray(e.rhs)){if(JSON.stringify(s.rhs)!==JSON.stringify(e.rhs))continue}else"string"==typeof s.rhs?"string"==typeof e.rhs?s.rhs>e.rhs?r=1:s.rhs<e.rhs&&(r=-1):r=1:r="string"==typeof e.rhs?-1:+s.rhs-+e.rhs;if(s.op===e.op)0===r?n.push([s.var<<2^1,e.var<<2^1]):"="===s.op?n.push([s.var<<2^3,e.var<<2^3]):">"===s.op&&r>0||"<"===s.op&&r<0?n.push([s.var<<2^3,e.var<<2^1]):("<"===s.op&&r>0||">"===s.op&&r<0)&&n.push([s.var<<2^1,e.var<<2^3]);else if("="===s.op||"="===e.op){let t=s,o=e,i=r;"="!==s.op&&(o=s,t=e,i=-r),">"!==o.op&&"<"!==o.op||(0===i?n.push([t.var<<2^3,o.var<<2^3]):i>0&&">"===o.op||i<0&&"<"===o.op?n.push([t.var<<2^3,o.var<<2^1]):n.push([t.var<<2^3,o.var<<2^3]))}else[">","<"].includes(s.op)&&[">","<"].includes(e.op)&&(">"===s.op&&r<0||"<"===s.op&&r>0?n.push([s.var<<2^1,e.var<<2^1]):n.push([s.var<<2^3,e.var<<2^3]))}}}return{dcSet:n,isNull:r}}function Jn(e,t){const n=[];e:for(const r of e){const e=new Map;for(const t of r)e.set(t>>2,(e.get(t>>2)||0)|1<<(3&t));const s=[],o=[];for(const[n,r]of e){if(10===r)continue e;const e=t.get(n)<<2,i=n<<2;5===r?s.push(3^e):1===r?o.push([3^e,3^i]):4===r?o.push([3^e,1^i]):8&r?s.push(3^i):2&r&&s.push(1^i)}let i=[s];for(;o.length;){const e=[],t=o.pop();for(const n of t)e.push(...i.map((e=>[...e,n])));i=e}n.push(...i)}return n}function Vn(e){const t=new Map;let n=e.true(t);const r=new Map(Array.from(t).map((([e,t])=>[t,JSON.parse(e)]))),{dcSet:s,isNull:o}=qn(r);n=Jn(n,o);return n=wn(n,s,{canRaise:Hn(o)}),Bn(n,r)}function Kn(e){if(!Array.isArray(e))return e;if("CASE"===e[0]){e=e.slice();for(let t=1;t<e.length;t+=2)e[t]=Wn(e[t]);return e}const t=e[0];if("IS NULL"===t)return new zn(Wn(e[1]));if("IS NOT NULL"===t)return new jn(new zn(Wn(e[1])));if("NOT"===t)return new jn(Wn(e[1]));if("OR"===t)return new In(...e.slice(1).map((e=>Wn(e))));if("AND"===t)return new _n(...e.slice(1).map((e=>Wn(e))));for(let t=1;t<e.length;++t)if(e[t]instanceof En)e[t]=Vn(e[t]);else if(Array.isArray(e[t])&&"CASE"===e[t][0])for(let n=2;n<e[t].length;n+=2)e[t][n]instanceof En&&(e[t][n]=Vn(e[t][n]));return e}function Hn(e){return(t,n)=>{const r=t>>2,s=e.get(r);if(null!=s)return!(1&t)||(!!n.has(s<<2^2)||(!!n.has(s<<2^3)||!n.has(3^t)));for(const[t,s]of e)if(s===r&&!n.has(t<<2^1)&&!n.has(t<<2^3)){if(n.has(t<<2^0))return!1;if(n.has(t<<2^2))return!1}return!0}}function Qn(e,t){if(!(t=Fn(t)))return[e,!1];if(t=Je(t,Kn),!e)return Array.isArray(t)&&"CASE"===t[0]&&(t=Wn(t)),t instanceof En&&(t=Vn(t)),[t,t];const n=Wn(t),r=Wn(e=Je(e=Fn(e),Kn)),s=new Map,o=n.true(s),i=r.true(s),a=r.null(s),l=r.false(s),c=new Map(Array.from(s).map((([e,t])=>[t,JSON.parse(e)]))),{dcSet:u,isNull:f}=qn(c),d=Jn([...i,...o],f),h=Jn(yn([...yn([...a,...l]),...yn(o)]),f),p=Hn(f),m=wn(d,u,{canRaise:p}),g=wn(h,u,{canRaise:p});return[Bn(m,c),Bn(g,c)]}function Yn(e,t){if(!(t=Fn(t)))return!0;if(e=Fn(e),!Array.isArray(e))return!!e;const n=Wn(e=Je(e,Kn)),r=Wn(t=Je(t,Kn)),s=new Map,o=n.true(s),i=r.true(s),a=new Map(Array.from(s).map((([e,t])=>[t,JSON.parse(e)]))),{dcSet:l}=qn(a);return c=[...yn(i),...l,...o],Xt(Zt.from(gn(c)));var c}const Gn=dt(Qe),Zn=dt(ot);let Xn,er,tr,nr=0;const rr={filter:new WeakMap,bookmark:new WeakMap,limit:new WeakMap,sort:new WeakMap,fulfilled:new WeakMap,fulfilling:new WeakSet,accessed:new WeakMap,value:new WeakMap},sr={};for(const e of["devices","faults","files","presets","provisions","virtualParameters","files","config","users","permissions"])sr[e]={objects:new Map,count:new Map,fetch:new Map,combinedFilter:null};class or{get fulfilled(){return rr.accessed.set(this,Date.now()),rr.fulfilled.get(this)||0}get fulfilling(){return rr.accessed.set(this,Date.now()),!(rr.fulfilled.get(this)>=nr)}get value(){return rr.accessed.set(this,Date.now()),rr.value.get(this)}}async function ir(e){const t=e.extract,n=e.deserialize;return e.extract=(e,r)=>{if("function"==typeof t)return t(e,r);if(304!==e.status&&2!==Math.floor(e.status/100)){if(403===e.status)throw new Error("No est autorizado");const t=new Error;throw t.message=0===e.status?"El servidor esta inalcanzable":`Codigo de estado de respuesta no esperado ${e.status}`,t.code=e.status,t.response=e.responseText,t}let s;if("function"==typeof n)s=n(e.responseText);else if((e.getResponseHeader("content-type")||"").startsWith("application/json"))try{s=e.responseText?JSON.parse(e.responseText):null}catch(t){throw new Error("Invalid JSON: "+e.responseText.slice(0,80))}else s=e.responseText;return s},N.request(e)}function ar(e){if(!Array.isArray(e))return e;return Zn(e,null,nr)}function lr(e,t){const n=Gn(t);let r=sr[e].count.get(n);return r||(r=new or,sr[e].count.set(n,r),rr.filter.set(r,t),r)}function cr(e,t,n){return it(e,Object.entries(t).sort(((e,t)=>Math.abs(t[1])-Math.abs(e[1]))).reverse().reduce(((e,t)=>{const[r,s]=t;if(s<=0){if(null==n[r])return at(["IS NOT NULL",["PARAM",r]],it(["IS NULL",["PARAM",r]],e));let t=null;return t=at(t,[">",["PARAM",r],n[r]]),at(t,it(["=",["PARAM",r],n[r]],e))}{let t=["IS NULL",["PARAM",r]];return null==n[r]?it(t,e):(t=at(t,["<",["PARAM",r],n[r]]),at(t,it(["=",["PARAM",r],n[r]],e)))}}),!0))}function ur(e,t,n,r){let s=[];for(const n of sr[e].objects.values())ot(t,n,nr)&&s.push(n);return s=s.sort(function(e){const t=Object.entries(e).sort(((e,t)=>Math.abs(t[1])-Math.abs(e[1])));return(e,n)=>{for(const[r,s]of t){let t=e[r],o=n[r];if(null!=t&&"object"==typeof t&&(t=t.value?t.value[0]:null),null!=o&&"object"==typeof o&&(o=o.value?o.value[0]:null),t>o)return s;if(t<o)return-1*s;if(t!==o){const e={null:1,number:2,string:3},n=e[null==t?"null":typeof t]||4,r=e[null==o?"null":typeof o]||4;return Math.max(-1,Math.min(1,n-r))*s}}return 0}}(n)),r&&(s=s.slice(0,r)),s}function fr(e,t,n={}){const r=Gn(t),s=Object.assign({},n.sort);for(const[e,t]of Object.entries(s))s[e]+=Math.sign(t);const o=n.limit||0;"devices"===e?s["DeviceID.ID"]=s["DeviceID.ID"]||1:s._id=s._id||1;const i=`${r}:${o}:${JSON.stringify(s)}`;let a=sr[e].fetch.get(i);return a||(a=new or,sr[e].fetch.set(i,a),rr.filter.set(a,t),rr.limit.set(a,o),rr.sort.set(a,s),function(e,t){const n=rr.limit.get(t);let r=rr.filter.get(t);r=ar(r);const s=rr.bookmark.get(t),o=rr.sort.get(t);!s&&n||(s&&(r=cr(r,o,s)),Yn(sr[e].combinedFilter,r)&&rr.fulfilled.set(t,nr)),rr.value.set(t,ur(e,r,o,n))}(e,a),a)}function dr(e){if(e>nr){nr=e;for(const e of Object.values(sr))e.combinedFilter=null}}function hr(e,t){for(const n of t)n.status="pending",n.device=e;return ir({method:"POST",url:`api/devices/${encodeURIComponent(e)}/tasks`,body:t,extract:e=>{if(403===e.status)throw new Error("No est autorizado");if(!e.status)throw new Error("El servidor esta inalcanzable");if(200!==e.status)throw new Error(e.response);const n=e.getResponseHeader("Connection-Request"),r=JSON.parse(e.response);for(const[e,n]of r.entries())t[e]._id=n._id,t[e].status=n.status,t[e].fault=n.fault;return n}})}function pr(e,t){return ir({method:"POST",url:`api/devices/${encodeURIComponent(e)}/tags`,body:t})}function mr(e,t){return ir({method:"DELETE",url:`api/${e}/${encodeURIComponent(t)}`})}function gr(e,t,n){for(const e in n)void 0===n[e]&&(n[e]=null);return ir({method:"PUT",url:`api/${e}/${encodeURIComponent(t)}`,body:n})}function vr(e,t){const n=["=",["PARAM","devices"===e?"DeviceID.ID":"_id"],t];return ir({method:"HEAD",url:`api/${e}/?`+N.buildQueryString({filter:Gn(n)}),extract:e=>{if(403===e.status)throw new Error("No est autorizado");if(!e.status)throw new Error("El servidor esta inalcanzable");if(200!==e.status)throw new Error(`Codigo de estado de respuesta no esperado ${e.status}`);return+e.getResponseHeader("x-total-count")},background:!0})}function yr(e,t){return Array.isArray(e)?Zn(e,t,nr):e}function wr(e,t,n){const r={newPassword:t};return n&&(r.authPassword=n),ir({method:"PUT",url:`api/users/${e}/password`,background:!0,body:r})}function br(e){return N(`svg.icon.icon-${e}`,{key:`icon-${e}`},N("use",{href:`icons.svg#icon-${e}`}))}setInterval((function(){N.request({url:"status",method:"GET",background:!0,extract:e=>{if(200!==e.status)Xn||(Xn=mt("warning","El servidor esta inalcanzable",{}));else{Xn&&(gt(Xn),Xn=null);const t=e.getResponseHeader("x-config-snapshot")!==yt,n=e.getResponseHeader("genieacs-version")!==wt;!er!=!t&&(er?(gt(er),er=null):er=mt("warning","La configuracion ha sido modificada, por favor recargue la pagina",{Recargar:()=>{window.location.reload()}})),!tr!=!n&&(tr?(gt(tr),tr=null):tr=mt("warning","El servidor ha sido actualizado, por favor recargue la pagina",{Recargar:()=>{window.location.reload()}}))}}}).catch((e=>{mt("error",e.message)}))}),3e3);const Ar=new Set,Sr=new Set;function xr(e){let t=Ar.size;for(const n of e)Ar.has(n)||++t;return t<=100}function Or(...e){if(xr(e))for(const t of e)t.status="queued",Ar.add(t);else mt("error","Demasiadas tareas en la cola")}function kr(e){Ar.delete(e)}function Cr(){return Ar}function Er(){Ar.clear()}function Nr(){return Sr}function Dr(e){Ar.size+e.devices.length>100?mt("error","Demasiadas tareas en la cola"):Sr.add(e)}function Pr(e,t){const n={};if(!xr(e))return Promise.reject(new Error("Demasiadas tareas en la cola"));for(const t of e)n[t.device]=n[t.device]||[],n[t.device].push(t),t.status="queued",Ar.add(t);return new Promise((e=>{let r=1;for(const[s,o]of Object.entries(n))++r,hr(s,o).then((n=>{for(const e of o)"pending"===e.status?e.status="stale":"done"===e.status&&Ar.delete(e);t(s,null,n,o),0==--r&&e()})).catch((n=>{for(const e of o)e.status="stale";t(s,n,null,o),0==--r&&e()}));0==--r&&e()}))}const $r=new WeakSet;function jr(e){return N("span.parameter",{title:e},`${e}`)}function zr(e,t,n){function r(e){"Enter"===e.key?t():"Escape"===e.key?n():e.redraw=!1}let s;if("xsd:boolean"===e.parameterValues[0][2])s=N("select",{value:e.parameterValues[0][1].toString(),onchange:t=>{t.redraw=!1,e.parameterValues[0][1]=s.dom.value},onkeydown:r,oncreate:e=>{e.dom.focus()}},[N("option",{value:"true"},"true"),N("option",{value:"false"},"false")]);else{const t=e.parameterValues[0][2];let n=e.parameterValues[0][1];"xsd:dateTime"===t&&"number"==typeof n&&(n=new Date(n).toJSON()||n),s=N("input",{type:["xsd:int","xsd:unsignedInt"].includes(t)?"number":"text",value:n,oninput:t=>{t.redraw=!1,e.parameterValues[0][1]=s.dom.value},onkeydown:r,oncreate:e=>{e.dom.focus(),e.dom.select(),e.dom.parentNode.parentNode.scrollTop=0}})}return[N("span","Editando ",jr(e.parameterValues[0][0])),s]}function Ir(e){e.fileName&&e.fileType?$r.delete(e):$r.add(e);const t=fr("files",!0);let n="",r="";for(const t of e.devices){const e=t.split("-");""===n?n=e[0]:n!==e[0]&&(n=null),3===e.length&&(""===r?r=e[1]:r!==e[1]&&(r=null))}n&&(n=decodeURIComponent(n)),r&&(r=decodeURIComponent(r));const s=[...new Set(["","1 Firmware Upgrade Image","2 Web Content","3 Vendor Configuration File","4 Tone File","5 Ringer File",...t.value.map((e=>e["metadata.fileType"])).filter((e=>e))])].map((t=>N("option",{disabled:!t,value:t,selected:(e.fileType||"")===t},t))),o=[""].concat(t.value.filter((e=>!(e["metadata.oui"]&&e["metadata.oui"]!==n||e["metadata.productClass"]&&e["metadata.productClass"]!==r))).map((e=>e._id))).map((t=>N("option",{disabled:!t,value:t,selected:(e.fileName||"")===t},t)));return["Archivo ",N("select",{onchange:n=>{const r=n.target.value;e.fileName=r,e.fileType="";for(const n of t.value)n._id===r&&(e.fileType=n["metadata.fileType"])},disabled:t.fulfilling,style:"width: 350px"},o)," Tipo de archivo ",N("select",{onchange:t=>{e.fileType=t.target.value}},s)]}const _r=()=>({view:e=>{const t=Cr(),n=Nr();let r,s;const o=function(e){const t=[];for(const n of e){let e;if(n.actions){const t=Object.entries(n.actions).map((([e,t])=>N("button.primary",{onclick:t},e)));t.length&&(e=N("div",{style:"float: right"},t))}t.push(N("div.notification",{class:n.type,style:"position: absolute;opacity: 0",oncreate:e=>{e.dom.style.opacity="1"},onbeforeremove:e=>(e.dom.style.opacity="0",new Promise((e=>{setTimeout((()=>{e()}),500)}))),key:n.timestamp},N("div",e,n.message)))}return t}(pt),i=function(e){const t=[];for(const n of e){const r=()=>{e.delete(n);for(const e of n.devices){const t=Object.assign({device:e},n);delete t.devices,Or(t)}},s=()=>{e.delete(n)};let o;"setParameterValues"===n.name?o=zr(n,r,s):"download"===n.name&&(o=Ir(n));const i=N("button.primary",{title:"Queue task",onclick:r,disabled:$r.has(n)},"Enviar a la cola"),a=N("button",{title:"Cancel edit",onclick:s},"Cancelar");t.push(N(".staging",o,N("div.actions",i,a)))}return t}(n),a=function(e){const t=[],n={};for(const t of e)n[t.device]=n[t.device]||[],n[t.device].push(t);for(const[e,s]of Object.entries(n)){t.push(N("strong",e));for(const e of s){const n=[];"fault"!==e.status&&"stale"!==e.status||n.push(N("button",{title:"Retry this task",onclick:()=>{Or(e)}},br("retry"))),n.push(N("button",{title:"Remove this task",onclick:()=>{kr(e)}},br("remove"))),"setParameterValues"===e.name?t.push(N(`div.${e.status}`,N("span","Establecer ",jr(e.parameterValues[0][0])," a '",(r=e.parameterValues[0][1],N("span.value",{title:r},`${r}`)),"'"),N(".actions",n))):"refreshObject"===e.name?t.push(N(`div.${e.status}`,N("span","Refresh ",jr(e.parameterName)),N(".actions",n))):"reboot"===e.name?t.push(N(`div.${e.status}`,"Reboot",N(".actions",n))):"factoryReset"===e.name?t.push(N(`div.${e.status}`,"Factory reset",N(".actions",n))):"addObject"===e.name?t.push(N(`div.${e.status}`,N("span","Add ",jr(e.objectName)),N(".actions",n))):"deleteObject"===e.name?t.push(N(`div.${e.status}`,N("span","Delete ",jr(e.objectName)),N(".actions",n))):"getParameterValues"===e.name?t.push(N(`div.${e.status}`,`Refrescar ${e.parameterNames.length} parametros`,N(".actions",n))):"download"===e.name?t.push(N(`div.${e.status}`,`Push file: ${e.fileName} (${e.fileType})`,N(".actions",n))):t.push(N(`div.${e.status}`,e.name,N(".actions",n)))}}var r;return t}(t);function l(){let e=10;for(const t of o)t.dom.style.top=`${e}`,e+=t.dom.offsetHeight+10}function c(){let t=s.dom.offsetTop+s.dom.offsetHeight;if(i.length)for(const e of i)t=Math.max(t,e.dom.offsetTop+e.dom.offsetHeight);else if(e.state.mouseIn)for(const e of r.children)t=Math.max(t,e.dom.offsetTop+e.dom.offsetHeight);r.dom.style.height=t}if(i.length+a.length){const n={queued:0,pending:0,fault:0,stale:0};for(const e of t)n[e.status]+=1;const o=N(".actions",N("button.primary",{title:"Commit queued tasks",disabled:!n.queued,onclick:()=>{Pr(Array.from(Cr()).filter((e=>"queued"===e.status)),((e,t,n,r)=>{if(t)mt("error",`${e}: ${t.message}`);else if("OK"===n){for(const t of r){if("stale"===t.status)return void mt("error",`${e}: No hay contacto desde el dispositivo`);if("fault"===t.status)return void mt("error",`${e}: Tarea(s) fallida`)}mt("success",`${e}: Tarea(s) enviada`)}else mt("error",`${e}: ${n}`)})).then((()=>{dr(Date.now())})).catch((e=>{mt("error",e.message)}))}},"Confirmar"),N("button",{title:"Clear tasks",onclick:Er,disabled:!a.length},"Limpiar"));s=N(".status",N("span.queued",{class:n.queued?"active":""},`En cola: ${n.queued}`),N("span.pending",{class:n.pending?"active":""},`Pendientes: ${n.pending}`),N("span.fault",{class:n.fault?"active":""},`Con fallo: ${n.fault}`),N("span.stale",{class:n.stale?"active":""},`Duradero: ${n.stale}`),o),r=N(".drawer",{key:"drawer",style:"opacity: 0;height: 0;",oncreate:t=>{e.state.mouseIn=!1,t.dom.style.opacity="1",c()},onmouseover:t=>{e.state.mouseIn=!0,c(),t.redraw=!1},onmouseleave:t=>{e.state.mouseIn=!1,c(),t.redraw=!1},onupdate:c,onbeforeremove:e=>(e.dom.onmouseover=null,e.dom.onmouseleave=null,e.dom.style.opacity="0",e.dom.style.height="0",new Promise((e=>{setTimeout(e,500)})))},s,i.length?i:N(".queue",a))}return N("div.drawer-wrapper",r,N("div.notifications-wrapper",{key:"notifications",style:"position: relative;",onupdate:l,oncreate:l},o))}}),Lr=()=>({view:()=>window.username?N("div.user-menu",window.username,N("button",{onclick:e=>(e.target.disabled=!0,ir({method:"POST",url:"logout"}).then((()=>{location.hash="",location.reload()})).catch((t=>{e.target.disabled=!1,mt("error",t.message)})),!1)},"Cerrar sesion")):N("div.user-menu",N("a",{href:"#!/login?"+N.buildQueryString({continue:N.route.get()})},"Log in"))}),Mr=()=>({view:e=>{const t={[e.attrs.page]:"active"},n=[];return window.authorizer.hasAccess("presets",1)&&n.push(N("li",{class:t.presets},N("a",{href:"#!/admin/presets"},"Presets"))),window.authorizer.hasAccess("provisions",1)&&n.push(N("li",{class:t.provisions},N("a",{href:"#!/admin/provisions"},"Provisiones"))),window.authorizer.hasAccess("virtualParameters",1)&&n.push(N("li",{class:t.virtualParameters},N("a",{href:"#!/admin/virtualParameters"},"Parametros virtuales"))),window.authorizer.hasAccess("files",1)&&n.push(N("li",{class:t.files},N("a",{href:"#!/admin/files"},"Archivos"))),window.authorizer.hasAccess("config",1)&&n.push(N("li",{class:t.config},N("a",{href:"#!/admin/config"},"Configuracion"))),window.authorizer.hasAccess("permissions",1)&&n.push(N("li",{class:t.permissions},N("a",{href:"#!/admin/permissions"},"Permisos"))),window.authorizer.hasAccess("users",1)&&n.push(N("li",{class:t.users},N("a",{href:"#!/admin/users"},"Usuarios"))),N("nav#side-menu",N("ul",n))}});let Rr=null,Tr=null;function Ur(e,t=null){Rr=e,Tr=t}function Fr(e,t=!0){return e===Rr&&(!(!t&&Tr&&!Tr())&&(Rr=null,Tr=null,!0))}document.addEventListener("keydown",(e=>{Rr&&"Escape"===e.key&&Fr(Rr,!1)&&N.redraw()})),window.addEventListener("popstate",(()=>{Fr(Rr,!1)&&N.redraw()}));const Wr=new Map;const Br=()=>({view:()=>[...Wr.values()],onupdate:()=>{for(const e of Wr.keys()){document.querySelector(`[list='${e}']`)||Wr.delete(e)}}}),qr=["presets","provisions","virtualParameters","files","config","users","permissions"],Jr=()=>({view:e=>{let t,n;if(qr.includes(e.attrs.page)){n="admin";const r={};r.page=e.attrs.page,t=N(Mr,r)}const r={};return r.page=n||e.attrs.page,[N("#header",[N("div.logo",N("img",{src:"logo.svg"})),N(Lr),N(D,r),N(_r)]),N("#content-wrapper",t,N("#content",{class:`page-${e.attrs.page}`},[e.children])),Rr?N(".overlay-wrapper",{tabindex:0,onclick:()=>{Fr(Rr,!1)},style:"opacity: 0",oncreate:e=>{e.dom.focus(),e.dom.style.opacity="1"},onbeforeremove:e=>(e.dom.style.opacity="0",new Promise((e=>{setTimeout((()=>{e()}),500)})))},N(".overlay",{onclick:e=>{e.stopPropagation()}},Rr())):null,N(Br)]}});const Vr=Object.freeze({__proto__:null,init:async function(){return N.request({url:"init"})},component:e=>{let t=e.attrs;const n=new Set;for(const[e,r]of Object.entries(t))r&&n.add(e);return{view:()=>{document.title="Initialization wizard";const e=["users","presets","filters","device","index","overview"].map((e=>(t[e]||n.delete(e),N("input",{type:"checkbox",checked:n.has(e),disabled:!t[e],style:"display: inline; margin-right: 0.5em;",onclick:t=>{t.target.checked?n.add(e):n.delete(e)}}))));return N(".wizard-dialog",[N("h1","Initialization wizard"),N("p","This wizard will seed the database with a minimal initial configuration to serve as a starting point. Select what you want to initialize and click 'ABRACADABRA!'."),N("div",N("label",e[0],"Users, roles and permissions")),N("div",N("label",e[1],"Presets and provisions")),N("div",N("label",e[2],"Devices predefined search filters")),N("div",N("label",e[3],"Device details page")),N("div",N("label",e[4],"Devices listing page")),N("div",N("label",e[5],"Overview page")),N("button.primary",{style:"margin: 10px;",disabled:0===n.size,onclick:e=>{e.target.disabled=!0;const r={};for(const e of n)r[e]=!0;N.request({method:"POST",url:"init",body:r}).then((()=>{setTimeout((()=>{N.request({url:"init"}).then((n=>{e.target.disabled=!1,t=n,mt("success","Initialization complete",{"Open Sesame!":()=>{N.route.set("/login"),window.location.reload()}})})).catch((e=>{mt("error",e.message)}))}),3e3),r.users&&alert("An administrator user has been created for you. Use admin/admin to log in. Don't forget to change the default password.")})).catch((e=>{mt("error",e.message)}))}},"ABRACADABRA!")])}}}}),Kr={year:31104e6,month:2592e6,day:864e5,hour:36e5,minute:6e4,second:1e3};const Hr=dt(((e,t,n)=>{let r=n;e=ot(e,null,n,(e=>{if(!Array.isArray(e))return e;for(let n=1;n<e.length;++n)if(Array.isArray(e[n])&&"PARAM"===e[n][0]&&!Array.isArray(e[n][1])){let s=null;const o=t[e[n][1]];o&&o.value&&(s=o.value[0],r=Math.min(r,o.valueTimestamp)),(e=e.slice())[n]=s}return"FUNC"!==e[0]||"DATE_STRING"!==e[1]||Array.isArray(e[2])?e:new Date(e[2]).toLocaleString()}));let s=null,o=null;if(Array.isArray(e)){if("PARAM"===e[0]){const n=t[e[1]];n&&n.value&&(r=n.valueTimestamp,o=n.value[0],s=e[1],"xsd:dateTime"===n.value[1]&&"number"==typeof o&&(o=new Date(o).toLocaleString()))}}else o=e;return{value:o,timestamp:r,parameter:s}})),Qr=vt.ui.overview.charts,Yr=new Set(["true","True","TRUE","false","False","FALSE","null","Null","NULL"]);function Gr(e){return!/[^\t\n\x20-\x7e\x85\u{a0}-\u{d7ff}\u{e000}-\u{fffd}\u{10000}-\u{10ffff}]/u.test(e)}function Zr(e){return e&&Gr(e)?/^[\s-?:,[\]{}#&$!|>'"%@`]|: | #|[\n,[\]{}]|\s$/.test(e)?JSON.stringify(e):e:JSON.stringify(e)}function Xr(e,t,n="",r=""){if(null==e)return void t.push(`${n}null`);if("number"==typeof e||"boolean"==typeof e)return void t.push(`${n}${JSON.stringify(e)}`);if(e instanceof Date)return void t.push(`${n}${e.toJSON()}`);if("string"==typeof e)return void function(e,t,n,r){if(/^\s*$/.test(e)||Yr.has(e)||!Gr(e))return void t.push(n+JSON.stringify(e));r||(r="  ");const s=e.split("\n");if(s.length>1){let o="",i="-";if((s.find((e=>e))||"").startsWith(" ")&&(o=`${"  ".length}`),s[s.length-1]||(s.pop(),i=s[s.length-1]?"":"+"),/^\s+$/.test(s[s.length-1]))return void t.push(n+JSON.stringify(e));let a=!1;const l=s.map((e=>{const t=function(e){if(e.length<=80)return[e];if(e.startsWith(" "))return[e];const t=[];let n=0,r=0;for(let s=1;s<e.length-1;++s){if(" "!==e[s])continue;if(" "===e[s+1]){for(s+=2;" "===e[s];)++s;continue}if(s<=n+80){r=s;continue}const o=r>n?r:s;t.push(e.slice(n,o)),n=o+1,r=s}return r>n&&e.length>n+80&&(t.push(e.slice(n,r)),n=r+1),t.push(e.slice(n)),t}(e);return t.length>1&&(a=!0),t}));if(!a)return void t.push(`${n}|${o}${i}`,...s.map((e=>e?r+e:e)));t.push(`${n}>${o}${i}`),t.push(...l[0].map((e=>r+e)));for(let e=1;e<l.length;++e)l[e-1][0]&&!l[e-1][0].startsWith(" ")&&t.push(""),t.push(...l[e].map((e=>r+e)))}else/^[\s-?:,[\]{}#&$!|>'"%@`]|: | #|\s$/.test(e)||parseFloat(e)===+e?t.push(n+JSON.stringify(e)):t.push(n+e)}(e,t,n,r);if(Array.isArray(e)){if(!e.length)return void t.push(n+"[]");if(!n||n.endsWith("- ")){Xr(e[0],t,n+"- ",r+"  "),n=r+"- ",r+="  ";for(let s=1;s<e.length;++s)Xr(e[s],t,n,r)}else{t.push(n),n=r+"- ",r+="  ";for(let s=0;s<e.length;++s)Xr(e[s],t,n,r)}return}const s=Object.entries(e).filter((e=>void 0!==e[1]));if(s.length)if(!n||n.endsWith("- ")){Xr(s[0][1],t,n+`${Zr(s[0][0])}: `,r+"  "),n=r,r+="  ";for(let e=1;e<s.length;++e)Xr(s[e][1],t,n+`${Zr(s[e][0])}: `,r)}else{t.push(n),n=r,r+="  ";for(let e=0;e<s.length;++e)Xr(s[e][1],t,n+`${Zr(s[e][0])}: `,r)}else t.push(n+"{}")}function es(e){if(void 0===e)return;const t=[];return Xr(e,t),t.join("\n")+"\n"}const ts=dt(He);const ns=new WeakMap;const rs={parameter:()=>({view:e=>{const t=e.attrs.device,{value:n,timestamp:r,parameter:s}=Hr(e.attrs.parameter,e.attrs.device,nr);if(null==n)return null;let o;t[s]&&t[s].writable&&(o=is("button",{title:"Edit parameter value",onclick:()=>{var e;e={name:"setParameterValues",devices:[t["DeviceID.ID"].value[0]],parameterValues:[[s,t[s].value[0],t[s].value[1]]]},Ar.size+e.devices.length>100?mt("error","Demasiadas tareas en la cola"):Sr.add(e)}},br("edit")));const i=is("long-text",{text:`${n}`});return is("span",{class:"parameter-value",onmouseover:e=>{if(e.redraw=!1,e.target===i.dom){const t=Date.now(),n=new Date(r).toLocaleString();e.target.title=`${n} (${function(e){let t="",n=2;for(const[r,s]of Object.entries(Kr))if(e>=s){let o;if(n>1?(o=Math.floor(e/s),e-=o*s):o=Math.round(e/s),t+=o>1?`${o} ${r}s `:`${o} ${r} `,!--n)break}return t+"ago"}(t-r)})`}}},i,o)}}),"parameter-list":()=>({view:e=>{const t=e.attrs.device,n=Object.values(e.attrs.parameters).map((e=>{const n=is.context({device:t,parameter:e.parameter},e.type||"parameter",e);return is("tr",{oncreate:e=>{e.dom.style.display=n.dom?"":"none"},onupdate:e=>{e.dom.style.display=n.dom?"":"none"}},is("th",e.label),is("td",n))}));return is("loading",{queries:[e.attrs.deviceQuery]},is("table.parameter-list",n))}}),"parameter-table":()=>({oninit:e=>{const t=e.attrs.parameter;if(!Array.isArray(t)||"PARAM"!==t[0])throw new Error("Object must be a parameter path");e.state.object=t[1],e.state.parameters=Object.values(e.attrs.childParameters)},view:e=>{const t=e.attrs.device,n=yr(e.state.object,t),r=e.state.parameters;if("string"!=typeof n||!t[n])return null;const s=new Set,o=`${n}.`;for(const e in t)if(e.startsWith(o)){const t=e.indexOf(".",o.length);-1===t?s.add(e):s.add(e.slice(0,t))}const i=Object.values(r).map((e=>is("th",e.label))),a=is("thead",is("tr",i)),l=[];for(const n of s){let s=null==e.attrs.filter||e.attrs.filter;if(s=Je(s,(e=>Array.isArray(e)&&"PARAM"===e[0]?["PARAM",["||",n,".",e[1]]]:e)),!yr(s,t))continue;const o=r.map((e=>{const r=Je(e.parameter,(e=>Array.isArray(e)&&"PARAM"===e[0]?["PARAM",["||",n,".",e[1]]]:e));return is("td",is.context({device:t,parameter:r},e.type||"parameter",Object.assign({},e,{device:t,parameter:r,label:null})))}));!0===t[n].writable&&o.push(is("td",is("button",{title:"Delete this instance",onclick:()=>{Or({name:"deleteObject",device:t["DeviceID.ID"].value[0],objectName:n})}},br("delete-instance")))),l.push(is("tr",o))}let c;return l.length||l.push(is("tr.empty",is("td",{colspan:i.length},"No instances"))),!0===t[n].writable&&l.push(is("tr",is("td",{colspan:i.length}),is("td",is("button",{title:"Crear nueva instancia",onclick:()=>{Or({name:"addObject",device:t["DeviceID.ID"].value[0],objectName:n})}},br("add-instance"))))),e.attrs.label&&(c=is("h2",e.attrs.label)),[c,is("loading",{queries:[e.attrs.deviceQuery]},is("table.table",a,is("tbody",l)))]}}),"overview-dot":()=>({view:e=>{const t=e.attrs.device,n=Qr[e.attrs.chart];if(!n)return null;for(const e of Object.values(n.slices)){if(yr(e.filter,t)){const t=is("svg",{width:"1em",height:"1em",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"},is("circle",{cx:"0.5em",cy:"0.5em",r:"0.4em",fill:e.color}));return is("span.overview-dot",t,`${e.label}`)}}return null}}),container:()=>({view:e=>{if(e.attrs.filter&&!yr(e.attrs.filter,e.attrs.device))return null;const t=Object.values(e.attrs.components).map((e=>"object"!=typeof e?`${e}`:is(e.type,e)));return e.attrs.element?is(e.attrs.element,t):t}}),"summon-button":()=>({view:e=>{const t=e.attrs.device;return is("button.primary",{title:"Initiate session and refresh basic parameters",onclick:n=>{n.target.disabled=!0;Pr([{name:"getParameterValues",parameterNames:Object.values(e.attrs.parameters).map((e=>Array.isArray(e)&&"PARAM"===e[0]?yr(e[1],t):null)).filter((e=>!!e)),device:t["DeviceID.ID"].value[0]}],((e,t,n,r)=>{if(t)mt("error",`${e}: ${t.message}`);else{for(const e of r)"stale"===e.status&&kr(e);"OK"!==n?mt("error",`${e}: ${n}`):"stale"===r[0].status?mt("error",`${e}: No hay contacto desde el dispositivo`):"fault"===r[0].status?mt("error",`${e}: Fallo al refrescar`):mt("success",`${e}: Summoned`)}})).then((()=>{n.target.disabled=!1,dr(Date.now())})).catch((e=>{n.target.disabled=!1,mt("error",e.message)}))}},"Leer valores basicos")}}),"device-faults":()=>({view:e=>{const t=e.attrs.device["DeviceID.ID"].value[0],n=fr("faults",["AND",[">",["PARAM","_id"],`${t}:`],["<",["PARAM","_id"],`${t}:zzzz`]]),r=["Channel","Code","Message","Detail","Retries","Timestamp"].map((e=>is("th",e))),s=is("thead",is("tr",r)),o=[];for(const e of n.value)o.push([is("td",e.channel),is("td",e.code),is("td",is("long-text",{text:e.message})),is("td",is("long-text",{text:es(e.detail)})),is("td",e.retries),is("td",new Date(e.timestamp).toLocaleString()),is("td",is("button",{title:"Delete fault",onclick:t=>{t.redraw=!1,mr("faults",e._id).then((()=>{mt("success","Fallo eliminado"),dr(Date.now()),is.redraw()})).catch((e=>{mt("error",e.message),dr(Date.now())}))}},br("remove")))]);let i;return i=o.length?is("tbody",o.map((e=>is("tr",e)))):is("tbody",is("tr.empty",is("td",{colspan:r.length},"No faults"))),is("loading",{queries:[n]},is("table.table",s,i))}}),"all-parameters":()=>({view:e=>{const t=e.attrs.device,n=e.attrs.limit>0?e.attrs.limit:100,r=is("input",{type:"text",placeholder:"Search parameters",oninput:t=>{e.state.searchString=t.target.value,t.redraw=!1,clearTimeout(e.state.timeout),e.state.timeout=setTimeout(is.redraw,500)}}),s=/\.[0-9]+$/;let o;if(e.state.searchString){const t=e.state.searchString.split(" ").filter((e=>e));t.length&&(o=new RegExp(t.map((e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"))).join(".*"),"i"))}const i=[],a=function(e){if(ns.has(e))return ns.get(e);const t=[];for(const n of Object.keys(e)){let e=0;for(let t=n.lastIndexOf(".",n.length-2);t>=0;t=n.lastIndexOf(".",t-1))++e;for(;t.length<=e;)t.push([]);t[e].push(n)}return ns.set(e,t),t}(t);let l=0;for(const e of a){let r=0;for(const s of e){const e=t[s],a=e.value&&e.value[0]?`${s} ${e.value[0]}`:s;o&&!o.test(a)||(++r,l<n&&i.push(s))}l+=r}i.sort();const c=i.map((e=>{const n=t[e],r=[],o={key:e};return!1===n.object?r.push(is("parameter",Object.assign({device:t,parameter:ts(e)}))):n.object&&n.writable&&(s.test(e)?r.push(is("button",{title:"Delete this instance",onclick:()=>{Or({name:"deleteObject",device:t["DeviceID.ID"].value[0],objectName:e})}},br("delete-instance"))):r.push(is("button",{title:"Crear nueva instancia",onclick:()=>{Or({name:"addObject",device:t["DeviceID.ID"].value[0],objectName:e})}},br("add-instance")))),r.push(is("button",{title:"Refrescar arbol",onclick:()=>{Or({name:"getParameterValues",device:t["DeviceID.ID"].value[0],parameterNames:[e]})}},br("refresh"))),is("tr",o,is("td.left",is("long-text",{text:e})),is("td.right",r))}));return is("loading",{queries:[e.attrs.deviceQuery]},is(".all-parameters",is("a.download-csv",{href:`api/devices/${encodeURIComponent(t["DeviceID.ID"].value[0])}.csv`,download:"",style:"float: right;"},"Descargar"),r,is(".parameter-list",is("table",is("tbody",c)),is("m",`Displaying ${i.length} out of ${l} parameters.`))))}}),"device-actions":()=>({view:e=>{const t=e.attrs.device,n=[];return n.push(is("button.primary",{title:"Reiniciar dispositivo",onclick:()=>{Or({name:"reboot",device:t["DeviceID.ID"].value[0]})}},"Reiniciar")),n.push(is("button.critical",{title:"Realiza un factory reset del dispositivo",onclick:()=>{Or({name:"factoryReset",device:t["DeviceID.ID"].value[0]})}},"Factory reset")),n.push(is("button.critical",{title:"Envia un archivo de configuracion o firmware al dispositivo",onclick:()=>{Dr({name:"download",devices:[t["DeviceID.ID"].value[0]]})}},"Enviar archivo")),n.push(is("button.primary",{title:"Elimina el dispositivo del servidor ACS",onclick:()=>{if(!confirm("Esta seguro que desea eliminar este dispositivo?"))return;const e=t["DeviceID.ID"].value[0];mr("devices",e).then((()=>{mt("success",`${e}: Dispositivo eliminado`),is.route.set("/devices")})).catch((e=>{mt("error",e.message)}))}},"Eliminar")),is(".actions-bar",n)}}),tags:()=>({view:e=>{const t=e.attrs.device;let n=!0;null!=e.attrs.writable&&(n=e.attrs.writable);const r=[];for(const e of Object.keys(t))e.startsWith("Tags.")&&r.push((s=e.slice(5),decodeURIComponent(s.replace(/0x(?=[0-9A-Z]{2})/g,"%"))));var s;return r.sort(),n?is(".tags",r.map((e=>is("span.tag",e,is("button",{onclick:n=>{n.target.disabled=!0;const r=t["DeviceID.ID"].value[0];pr(r,{[e]:!1}).then((()=>{n.target.disabled=!1,mt("success",`${r}: Etiquetas actualizadas`),dr(Date.now())})).catch((e=>{n.target.disabled=!1,mt("error",`${r}: ${e.message}`)}))}},br("remove"))))),is("span.tag.writable",is.trust("&nbsp;"),is("button",{onclick:e=>{e.target.disabled=!0;const n=t["DeviceID.ID"].value[0],r=prompt("Introduzca la etiqueta que desea asignar:");r?pr(n,{[r]:!0}).then((()=>{e.target.disabled=!1,mt("success",`${n}: Etiquetas actualizadas`),dr(Date.now())})).catch((t=>{e.target.disabled=!1,mt("error",`${n}: ${t.message}`)})):e.target.disabled=!1}},br("add")))):is(".tags",r.map((e=>is("span.tag",e))))}}),ping:e=>{let t,n;const r=()=>{if(!n){const t=e.dom;return void(t&&(t.innerHTML=""))}let r="";(function(e){return ir({url:`api/ping/${encodeURIComponent(e)}`,background:!0})})(n).then((e=>{r=null!=e.avg?`${Math.trunc(e.avg)} ms`:"Unreachable"})).catch((()=>{r="Error!",clearInterval(t)})).finally((()=>{const t=e.dom;t&&(t.innerHTML=`Pinging ${n}: ${r}`)}))};return{onremove:()=>{clearInterval(t)},view:e=>{const s=e.attrs.device;let o,i=s["InternetGatewayDevice.ManagementServer.ConnectionRequestURL"];i||(i=s["Device.ManagementServer.ConnectionRequestURL"]);try{o=new URL(i.value[0]).hostname}catch(e){}return n!==o&&(n=o,clearInterval(t),n&&(r(),t=setInterval(r,3e3))),is("div",n?`Pinging ${n}:`:"")}}},"device-link":()=>({view:e=>{let t;e.attrs.device&&(t=e.attrs.device["DeviceID.ID"].value[0]);const n=Object.values(e.attrs.components).map((t=>{if("object"!=typeof t)return`${t}`;const n=Object.assign({},e.attrs,t);return is(n.type,n)}));return t?is("a",{href:`#!/devices/${encodeURIComponent(t)}`},n):n}}),"long-text":()=>({view:e=>{const t=e.attrs.text,n=e.attrs.element||"span";function r(e){e.dom.classList.add("long-text-overflowed"),e.dom.onclick=e=>{Ur((()=>N("textarea.long-text",{value:t,cols:80,rows:24,readonly:"",oncreate:e=>{e.dom.focus(),e.dom.select()}}))),e.stopPropagation(),N.redraw()}}return N(n,{oncreate:e=>{e.dom.clientWidth!==e.dom.scrollWidth&&r(e)},onupdate:e=>{e.dom.clientWidth===e.dom.scrollWidth?(e.dom.classList.remove("long-text-overflowed"),e.dom.onclick=null):r(e)},class:"long-text",title:t},t)}}),loading:()=>{let e,t,n=!1;function r(r){if(!n)return e&&e.parentElement.remove(),t&&t.classList.remove("loading"),e=null,void(t=null);if(t&&t!==r.dom&&t.classList.remove("loading"),t=r.dom,t.classList.add("loading"),!e){const t=document.createElement("div");t.style.position="relative",t.style.pointerEvents="none",e=document.createElement("div"),e.classList.add("loading-overlay"),e.style.position="absolute",t.appendChild(e)}const s=e.parentElement;s.parentElement!==t.parentElement&&t.parentNode.appendChild(s);const o=s.getBoundingClientRect(),i=t.getBoundingClientRect();e.style.width=`${t.scrollWidth}px`,e.style.height=`${t.scrollHeight}px`,e.style.left=i.left-o.left+"px",e.style.top=i.top-o.top+"px"}return{view:e=>{const t=e.attrs.queries;return n=t.some((e=>e.fulfilling)),e.children},oncreate:r,onupdate:r,onremove:()=>{e&&e.parentElement.remove(),t&&t.classList.remove("loading"),e=null,t=null}}}},ss=new WeakMap,os=new WeakMap,is=new Proxy(N,{apply:(e,t,n)=>{const r=n[0];return"string"!=typeof r?n[0]=cs(r):rs[r]&&(n[0]=cs(rs[r])),Reflect.apply(e,void 0,n)},get:(e,t)=>"context"===t?as:Reflect.get(e,t)});function as(e,...t){const n=Reflect.apply(is,void 0,t);return os.set(n,e),n}function ls(e,t){if(Array.isArray(e))for(const n of e)ls(n,t);else if(e&&"object"==typeof e&&e.tag){const n=Object.assign({},t,os.get(e));if("string"!=typeof e.tag&&(os.set(e,n),e.attrs=Object.assign({},n,e.attrs)),e.children&&e.children.length)for(const t of e.children)ls(t,n)}}function cs(e){let t=ss.get(e);if(!t){if("function"!=typeof e){t=Object.assign({},e);const n=e.view;t.view=function(e){const t=os.get(e)||{},r=Reflect.apply(n,this,[e]);return ls(r,t),r}}else{if(e.prototype&&e.prototype.view)throw new Error("Class components not supported");t=t=>{const n=e(t),r=n.view;return n.view=function(e){const t=os.get(e)||{};try{const n=Reflect.apply(r,this,[e]);return ls(n,t),n}catch(e){return N("p.error",{title:e.message},"Error!")}},n}}ss.set(e,t)}return t}const us=()=>({view:e=>{const t=e.attrs.onPasswordChange,n=!e.attrs.noAuth,r=e.attrs.username;r&&(e.state.username=r);const s=[is("p",is("label",{for:"username"},"Nombre de usuario"),is("input",{name:"username",type:"text",value:e.state.username,disabled:!!r,oninput:t=>{e.state.username=t.target.value},oncreate:e=>{e.dom.focus()}}))];let o={newPassword:"Nueva contrasea",confirmPassword:"Confirmar contrasea"};n&&(o=Object.assign({authPassword:"Su contrasea"},o));for(const[t,n]of Object.entries(o))s.push(is("p",is("label",{for:t},n),is("input",{name:t,type:"password",value:e.state[t],oninput:n=>{e.state[t]=n.target.value}})));const i=is("button.primary",{type:"submit"},"Cambiar contrasea");s.push(is(".actions-bar",i));const a=[is("h1","Cambiar contrasea"),is("form",{onsubmit:r=>{r.redraw=!1,r.preventDefault(),!e.state.username||!e.state.newPassword||n&&!e.state.authPassword?mt("error","Please fill all fields"):e.state.newPassword!==e.state.confirmPassword?mt("error","La contrasea de confirmacion no coincide con la nueva contrasea"):(i.dom.disabled=!0,wr(e.state.username,e.state.newPassword,e.state.authPassword).then((()=>{mt("success","Contrasea actualizada correctamente"),t&&t(),i.dom.disabled=!1})).catch((e=>{mt("error",e.message),i.dom.disabled=!1})))}},s)];return is("div.put-form",a)}});const fs=Object.freeze({__proto__:null,init:function(e){return Promise.resolve(e)},component:()=>({view:e=>(window.username&&is.route.set(e.attrs.continue||"/"),document.title="Login",[is("h1","Log in"),is("form",is("p",is("label",{for:"username"},"Nombre de usuario"),is("input",{name:"username",type:"text",value:e.state.username,oncreate:e=>{e.dom.focus()},oninput:t=>{e.state.username=t.target.value}})),is("p",is("label",{for:"password"},"Contrasea"),is("input",{name:"password",type:"password",value:e.state.password,oninput:t=>{e.state.password=t.target.value}})),is("p",is("button.primary",{type:"submit",onclick:t=>{var n,r;return t.target.disabled=!0,(n=e.state.username,r=e.state.password,ir({method:"POST",url:"login",background:!0,body:{username:n,password:r}})).then((()=>{location.reload()})).catch((e=>{mt("error",e.response||e.message),t.target.disabled=!1})),!1}},"Login"))),is("a",{onclick:()=>{const e=()=>{const t={onPasswordChange:()=>{Fr(e),is.redraw()}};return is(us,t)};Ur(e)}},"Cambiar contrasea")])})}),ds=dt(Qe);const hs=()=>({view:e=>function(e){const t=e.slices,n=Array.from(Object.values(e.slices)).reduce(((e,t)=>e+(t.count.value||0)),0),r=[],s=[],o=[];let i,a,l=0,c=100*Math.cos(2*Math.PI*l),u=100*Math.sin(2*Math.PI*l);for(const e of Object.values(t)){const t=n>0?(e.count.value||0)/n:0;if(r.push(is(".legend-line",[is("span.color",{style:`background-color: ${e.color} !important;`}),`${e.label}: `,is("a",{href:`#!/devices/?${is.buildQueryString({filter:ds(e.filter)})}`},e.count.value||0),` (${(100*t).toFixed(2)}%)`])),t>0){l+=t,i=100*Math.cos(2*Math.PI*l),a=100*Math.sin(2*Math.PI*l);const n=`M ${c} ${u} A 100 100 0 ${t>.5?1:0} 1 ${i} ${a} L 0 0 z`;c=i,u=a,s.push(is("path",{d:n,fill:e.color}));const r=50*Math.cos(2*Math.PI*(l-t/2)),f=50*Math.sin(2*Math.PI*(l-t/2));o.push(is("a",{"xlink:href":`#!/devices/?${is.buildQueryString({filter:ds(e.filter)})}`},[is("path",{d:n,"fill-opacity":0}),is("text",{x:r,y:f,"dominant-baseline":"middle","text-anchor":"middle"},`${(100*t).toFixed(2)}%`)]))}}return r.push(is("span.legend-total",`Total: ${n}`)),is("loading",{queries:Object.values(e.slices).map((e=>e.count))},is("div",{class:"pie-chart"},[is("svg",{viewBox:"-102 -102 204 204",width:"204px",height:"204px",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"},s.concat(o)),is(".legend",r)]))}(e.attrs.chart)}),ps=vt.ui.overview.groups||{},ms={};for(const e of Object.values(ps))for(const t of Object.values(e.charts))ms[t]=vt.ui.overview.charts[t];function gs(e){e=Object.assign({},e);for(let[t,n]of Object.entries(e)){e[t]=n=Object.assign({},n),n.slices=Object.assign({},n.slices);for(let[e,t]of Object.entries(n.slices)){const r=t.filter;n.slices[e]=t=Object.assign({},t),t.count=lr("devices",r)}}return e}const vs=Object.freeze({__proto__:null,init:function(){return window.authorizer.hasAccess("devices",1)?Promise.resolve({charts:gs(ms)}):Promise.reject(new Error("No esta autorizado a ver esta pagina"))},component:()=>({view:e=>{document.title="Overview";const t=[];for(const n of Object.values(ps)){n.label&&t.push(is("h1",n.label));const r=[];for(const t of Object.values(n.charts)){const n=e.attrs.charts[t],s=[];n.label&&s.push(is("h2",n.label));const o={};o.chart=n,s.push(is(hs,o)),r.push(is(".overview-chart",s))}t.push(is(".overview-chart-group",r))}return t}})});const ys=()=>{let e=new Set;return{view:t=>{const n=t.attrs.attributes,r=t.attrs.data,s=t.attrs.valueCallback,o=t.attrs.total,i=t.attrs.showMoreCallback,a=t.attrs.sortAttributes,l=t.attrs.onSortChange,c=t.attrs.downloadUrl,u=t.attrs.actionsCallback,f=t.attrs.recordActionsCallback,d=new Set;for(const t of r){const n=t._id||t["DeviceID.ID"].value[0];e.has(n)&&d.add(n)}return e=d,function(e,t,n,r,s,o,i,a,l,c,u){const f=t||[];let d=[];"function"==typeof c?(d=c(s),Array.isArray(d)||(d=[d])):Array.isArray(c)&&(d=c);const h=[];if(d.length){const e=is("input",{type:"checkbox",checked:f.length&&s.size===f.length,onchange:e=>{for(const t of f){const n=t._id||t["DeviceID.ID"].value[0];e.target.checked?s.add(n):s.delete(n)}},disabled:!n});h.push(is("th",e))}for(let t=0;t<e.length;t++){const n=e[t].label;if(!o.hasOwnProperty(t)){h.push(is("th",n));continue}let r=1,s=br("unsorted");o[t]>0?s=br("sorted-asc"):o[t]<0&&(s=br("sorted-dsc"));const a=is("button",{onclick:()=>(o[t]>0&&(r*=-1),i({[t]:r}))},s);h.push(is("th",[n,a]))}const p=[];for(const t of f){const n=t._id||t["DeviceID.ID"].value[0],r=[];if(d.length){const e=is("input",{type:"checkbox",checked:s.has(n),onchange:e=>{e.target.checked?s.add(n):s.delete(n)},onclick:e=>{e.stopPropagation(),e.redraw=!1}});r.push(is("td",e))}for(const n of e){const e={};let s;if("function"==typeof l)s=l(n,t);else if("code"===n.type){const r=t[n.id].split("\n",11);r.length>10&&(r[10]=[""]),null==e.title&&(e.title=r.join("\n")),s=r[0]||""}else s=t[n.id];r.push(is("td",e,s))}let o=[];"function"==typeof u?(o=u(t),Array.isArray(o)||(o=[o])):Array.isArray(u)&&(o=u);for(const e of o)r.push(is("td.table-row-links",e));p.push(is("tr",{onclick:e=>{["INPUT","BUTTON","A"].includes(e.target.nodeName)?e.redraw=!1:s.delete(n)||s.add(n)}},r))}p.length||p.push(is("tr.empty",is("td",{colspan:h.length},"No hay registros")));const m=[];null!=n?m.push(`${f.length}/${n}`):m.push(`${f.length}`),m.push(is("button",{title:"Show more records",onclick:r,disabled:!t.length||f.length>=Math.min(200,n)},"Mas")),a&&m.push(is("a.download-csv",{href:a,download:""},"Descargar"));const g=is("tfoot",is("tr",is("td",{colspan:h.length},m))),v=[is("table.table.highlight",is("thead",is("tr",h)),is("tbody",p),g)];return d.length&&v.push(is("div.actions-bar",d)),v}(n,r,o,i,e,a,l,c,s,u,f)}}};class ws{constructor(e,t){this.callback=t,this.element=null,this.hideTimeout=null,this.visible=!1,this.default=null,this.selection=null,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.display="block",this.container.style.opacity="0",this.container.className=e}attach(e){e.setAttribute("autocomplete","off"),e.addEventListener("focus",(()=>{this.element=e;const t=e.getBoundingClientRect();this.container.style.left=`${t.left+window.pageXOffset}px`,this.container.style.width=`${t.width}px`,this.container.style.top=`${t.bottom+window.pageYOffset}px`,this.update()})),e.addEventListener("blur",(()=>{this.element===e&&this.visible&&this.hide()})),e.addEventListener("keydown",(t=>{this.element===e&&("Escape"===t.key?this.visible&&this.hide():"Enter"===t.key?null!=this.default&&(e.value=this.default,t.preventDefault(),this.update()):"ArrowDown"===t.key?(t.preventDefault(),null==this.selection?this.selection=0:++this.selection,this.update()):"ArrowUp"===t.key&&(t.preventDefault(),--this.selection,this.update()))})),e.addEventListener("input",(()=>{this.element===e&&(this.selection=null,this.update())}))}hide(){this.container.style.opacity="0",this.visible=!1,this.default=null,this.selection=null,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout((()=>{for(this.hideTimeout=null;this.container.firstChild;)this.container.removeChild(this.container.firstChild);document.body.removeChild(this.container)}),500)}update(){const e=this.element;this.callback(e.value,(t=>{if(this.element!==e)return;if(this.default=null,!t.length)return void(this.visible&&this.hide());for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);let n;this.visible||(this.hideTimeout?(clearTimeout(this.hideTimeout),this.hideTimeout=null):(document.body.appendChild(this.container),window.getComputedStyle(this.container).opacity),this.container.style.opacity="1",this.visible=!0),null!=this.selection?(this.selection=(this.selection%t.length+t.length)%t.length,this.default=t[this.selection].value):this.default=t[0].value;for(const[r,s]of t.entries()){const t=document.createElement("div");s.tip&&(t.title=s.tip),t.classList.add("suggestion"),r===this.selection&&(t.classList.add("selected"),n=t);const o=document.createTextNode(s.value);t.appendChild(o),t.addEventListener("mousedown",(t=>{t.preventDefault(),e.value=s.value,this.element===e&&this.update()})),this.container.appendChild(t)}n&&(this.container.scrollTop=Math.min(this.container.scrollTop,n.offsetTop),this.container.scrollTop=Math.max(this.container.scrollTop,n.offsetTop+n.scrollHeight-this.container.clientHeight))}))}}const bs={devices:{},faults:{Device:{parameter:["PARAM","device"],type:"string"},Channel:{parameter:["PARAM","channel"],type:"string"},Code:{parameter:["PARAM","code"],type:"string"},Retries:{parameter:["PARAM","retries"],type:"number"},Timestamp:{parameter:["PARAM","timestamp"],type:"timestamp"}},presets:{ID:{parameter:["PARAM","_id"],type:"string"},Channel:{parameter:["PARAM","channel"],type:"string"},Weight:{parameter:["PARAM","weight"],type:"number"}},provisions:{ID:{parameter:["PARAM","_id"],type:"string"}},virtualParameters:{ID:{parameter:["PARAM","_id"],type:"string"}},files:{ID:{parameter:["PARAM","_id"],type:"string"},Type:{parameter:["PARAM","metadata.fileType"],type:"string"},OUI:{parameter:["PARAM","metadata.oui"],type:"string"},"Product class":{parameter:["PARAM","metadata.productClass"],type:"string"},Version:{parameter:["PARAM","metadata.version"],type:"string"}},permissions:{Role:{parameter:["PARAM","role"],type:"string"},Resource:{parameter:["PARAM","resource"],type:"string"},Access:{parameter:["PARAM","access"],type:"number"}},users:{Username:{parameter:["PARAM","_id"],type:"string"}}};for(const e of Object.values(vt.ui.filters))bs.devices[e.label]={parameter:e.parameter,type:(e.type||"").split(",").map((e=>e.trim()))};function As(e){return["IS NOT NULL",["PARAM",`Tags.${function(e){return encodeURIComponent(e).replace(/[!~*'()]/g,(e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())).replace(/0x(?=[0-9A-Z]{2})/g,"0%78").replace(/%/g,"0x")}(e)}`]]}function Ss(e,t){let n;if(bs[e]&&bs[e][t]){const r=bs[e][t],s="devices"===e?r.type:r.type.split(","),o=[];for(const e of s)switch(e.trim()){case"string":o.push("case insensitive string pattern");break;case"number":o.push("numeric value");break;case"timestamp":o.push("Unix timestamp or string in the form YYYY-MM-DDTHH:mm:ss.sssZ");break;case"mac":o.push("partial case insensitive MAC address");break;case"tag":o.push("case sensitive string")}o.length&&(n=`${t}: ${o.join(", ")}`)}return n}function xs(e,t,n){if(!bs[e])return null;const r=bs[e][t].type;n=n.trim();const s=["OR"];if(0===r.length||r.includes("number")){const r=function(e,t){let n="=";for(const e of["<>","=","<=","<",">=",">"])if(t.startsWith(e)){n=e,t=t.slice(e.length).trim();break}const r=parseInt(t);return r!==+t?null:[n,e,r]}(bs[e][t].parameter,n);r&&s.push(r)}if(0===r.length||r.includes("string")){const r=function(e,t){return["LIKE",["FUNC","LOWER",e],t.toLowerCase()]}(bs[e][t].parameter,n);r&&s.push(r)}if(0===r.length||r.includes("timestamp")){const r=function(e,t){let n="=";for(const e of["<>","=","<=","<",">=",">"])if(t.startsWith(e)){n=e,t=t.slice(e.length).trim();break}let r=parseInt(t);return r!==+t&&(r=Date.parse(t)),isNaN(r)?null:[n,e,r]}(bs[e][t].parameter,n);r&&s.push(r)}if(r.includes("mac")){const r=function(e,t){return(t=t.replace(/[^a-f0-9]/gi,"").toLowerCase())?12===t.length?["LIKE",["FUNC","LOWER",e],t.replace(/(..)(?!$)/g,"$1:")]:["OR",["LIKE",["FUNC","LOWER",e],`%${t.replace(/(..)(?!$)/g,"$1:")}%`],["LIKE",["FUNC","LOWER",e],`%${t.replace(/(.)(.)/g,"$1:$2")}%`]]:null}(bs[e][t].parameter,n);r&&s.push(r)}if(r.includes("tag")){const e=As(n);e&&s.push(e)}return s.length<=1?null:2===s.length?s[1]:s}const Os=Array.isArray;const ks=dt((e=>{const t=function(e){return bs[e]?Object.keys(bs[e]):[]}(e);return new ws("autocomplete",((n,r)=>{n=n.toLowerCase(),r(t.filter((e=>e.toLowerCase().includes(n))).map((t=>({value:`${t}: `,tip:Ss(e,t)}))))}))}));function Cs(e){e=Fn(e),Array.isArray(e)&&"CASE"===e[0]&&(e=(e=e.slice(1).filter((e=>Array.isArray(e)))).length>1?["AND",...e]:e[0]),Array.isArray(e)&&function(e){if(!Os(e)){if(!0===e)return{};throw new Error("Primitives are not valid queries")}(function e(t,n){const r=t[0];if("AND"===r&&2===(t=t.filter((e=>!0!==e))).length)return e(t[1],n);if("OR"===r&&2===(t=t.filter((e=>!1!==e))).length)return e(t[1],n);if(!n&&"AND"===r||n&&"OR"===r)return{$and:t.slice(1).map((t=>e(t,n)))};if(!n&&"OR"===r||n&&"AND"===r)return{$or:t.slice(1).map((t=>e(t,n)))};if("NOT"===r)return e(t[1],!n);if(Os(t[2]))throw new Error(`Invalid RHS operand of ${r} clause`);if("LIKE"===r||"NOT LIKE"===r){let e,s;if("NOT LIKE"===r&&(n=!n),!Array.isArray(t[1]))throw new Error(`Invalid LHS operand of ${r} clause`);if("FUNC"===t[1][0]&&"UPPER"===t[1][1]){if(t[2]!==t[2].toUpperCase())throw new Error(`Invalid RHS operand of ${r} clause`);e=t[1][2][1],s="i"}else if("FUNC"===t[1][0]&&"LOWER"===t[1][1]){if(t[2]!==t[2].toLowerCase())throw new Error(`Invalid RHS operand of ${r} clause`);e=t[1][2][1],s="i"}else{if("PARAM"!==t[1][0])throw new Error(`Invalid LHS operand of ${r} clause`);e=t[1][1],s=""}const o=et(t[2],t[3],s);return n?{[e]:{$nin:[o,null]}}:{[e]:o}}if("_tags"===r){let e=t[2];return n&&(e=!e),e?{_tags:t[1]}:{_tags:{$ne:t[1]}}}if(!Os(t[1])||"PARAM"!==t[1][0])throw new Error(`Invalid LHS operand of ${r} clause`);if("IS NULL"===r)return{[t[1][1]]:null};if("IS NOT NULL"===r)return{[t[1][1]]:{$ne:null}};if(Os(t[2])||null==t[2])throw new Error(`Invalid RHS operand of ${r} clause`);if("="===r){const e=t[1][1],r=t[2];return n?{[e]:{$nin:[r,null]}}:{[e]:r}}if("<>"===r){const e=t[1][1],r=t[2];return n?{[e]:r}:{[e]:{$nin:[r,null]}}}if(">"===r){const e=t[1][1],r=t[2];return n?{[e]:{$lte:r}}:{[e]:{$gt:r}}}if(">="===r){const e=t[1][1],r=t[2];return n?{[e]:{$lt:r}}:{[e]:{$gte:r}}}if("<"===r){const e=t[1][1],r=t[2];return n?{[e]:{$gte:r}}:{[e]:{$lt:r}}}if("<="===r){const e=t[1][1],r=t[2];return n?{[e]:{$gt:r}}:{[e]:{$lte:r}}}throw new Error(`Unrecognized operator ${r}`)})(e,!1)}(e)}function Es(e){return Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?`${e[2]}: ${e[3]}`:Qe(e)}const Ns=dt((e=>{if(!e)return[""];const t=[],n=He(e);if(Array.isArray(n)&&"AND"===n[0])for(const e of n.slice(1))t.push(Es(e));else t.push(Es(n));return t.push(""),t})),Ds=()=>({view:e=>{function t(){e.state.filterInvalid=0,e.state.filterList=e.state.filterList.filter((e=>e));let t=e.state.filterList.map(((t,n)=>{try{return function(e,t){let n;if(/^[\s0-9a-zA-Z]+:/.test(t)){const e=t.split(":",1)[0],r=t.slice(e.length+1).trim();n=["FUNC","Q",e.trim(),r]}else n=He(t);return Cs(Je(n,(t=>{if(Array.isArray(t)&&"FUNC"===t[0]){if("Q"===t[1])return xs(e,t[2],t[3]);if("NOW"===t[1])return Date.now()}return t}))),n}(e.attrs.resource,t)}catch(t){e.state.filterInvalid|=1<<n}return null}));e.state.filterList.push(""),e.state.filterInvalid||(delete e.state.filter,0===t.length?e.attrs.onChange(""):(t=t.length>1?["AND"].concat(t):t[0],e.attrs.onChange(Qe(t))))}return e.state.filterList&&e.attrs.filter===e.state.filter||(e.state.filterInvalid=0,e.state.filter=e.attrs.filter,e.state.filterList=Ns(e.attrs.filter)),N("div.filter",[N("b","Filtro")].concat(e.state.filterList.map(((n,r)=>N("input",{type:"text",class:""+(e.state.filterInvalid>>r&1?"error":""),value:n,onchange:n=>{e.state.filterList=e.state.filterList.slice(),e.state.filterList[r]=n.target.value.trim(),t()},oncreate:t=>{ks(e.attrs.resource).attach(t.dom)}})))))}}),Ps=vt.ui.pageSize||10,$s=dt(He),js=dt(JSON.parse),zs=dt((e=>{const t=function(e){const t=new Set;return Je(e,(e=>(Ye(e)&&"PARAM"===e[0]&&t.add(e[1]),e))),Array.from(t)}(e);if(1===t.length){const e=ot(t[0]);if("string"==typeof e)return e}return null})),Is=dt(((e,t)=>{const n={};for(const e of t)n[e.label]=Qe(e.parameter);return`api/devices.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(n)})}`})),_s=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("devices",e[2],e[3]):e))));function Ls(e){const t=[];return t.push(is("button.primary",{title:"Reinicia los dispositivos seleccionados",disabled:!e.size,onclick:()=>{Or(...[...e].map((e=>({name:"reboot",device:e}))))}},"Reiniciar")),t.push(is("button.critical",{title:"Realiza un factory reset a los dispositivos seleccionados",disabled:!e.size,onclick:()=>{Or(...[...e].map((e=>({name:"factoryReset",device:e}))))}},"Factory Reset")),t.push(is("button.critical",{title:"Envia un archivo de configuracion o firmware a los dispositivos seleccionados",disabled:!e.size,onclick:()=>{Dr({name:"download",devices:[...e]})}},"Enviar archivo")),t.push(is("button.primary",{title:"Elimina los dispositivos seleccionados del servidor ACS",disabled:!e.size,onclick:()=>{const t=Array.from(e);if(!confirm(`Esta seguro que desea eliminar ${t.length} dispositivos?`))return;let n=1;for(const e of t)++n,mr("devices",e).then((()=>{mt("success",`${e}: Eliminado`),0==--n&&dr(Date.now())})).catch((t=>{mt("error",`${e}: ${t.message}`),0==--n&&dr(Date.now())}));0==--n&&dr(Date.now())}},"Eliminar")),t.push(is("button.primary",{title:"Agretar etiqueta a los dispositivos seleccionados",disabled:!e.size,onclick:()=>{const t=Array.from(e),n=prompt(`Introduzca la etiqueta que desea asignar a ${t.length} dispositivos:`);if(!n)return;let r=1;for(const e of t)++r,pr(e,{[n]:!0}).then((()=>{mt("success",`${e}: Etiquetas actualizadas`),0==--r&&dr(Date.now())})).catch((t=>{mt("error",`${e}: ${t.message}`),0==--r&&dr(Date.now())}));0==--r&&dr(Date.now())}},"Etiquetar")),t.push(is("button.primary",{title:"Eliminar etiqueta de los dispositivos seleccionados",disabled:!e.size,onclick:()=>{const t=Array.from(e),n=prompt(`Introduzca la etiqueta que desea eliminar de ${t.length} dispositivos:`);if(!n)return;let r=1;for(const e of t)++r,pr(e,{[n]:!1}).then((()=>{mt("success",`${e}: Etiquetas actualizadas`),0==--r&&dr(Date.now())})).catch((t=>{mt("error",`${e}: ${t.message}`),0==--r&&dr(Date.now())}));0==--r&&dr(Date.now())}},"Eliminar etiqueta")),t}const Ms=Object.freeze({__proto__:null,init:function(e){return new Promise(((t,n)=>{if(!window.authorizer.hasAccess("devices",2))return void n(new Error("No esta autorizado a ver esta pagina"));const r=e.hasOwnProperty("filter")?""+e.filter:"",s=e.hasOwnProperty("sort")?""+e.sort:"",o=Object.values(vt.ui.index);o.length||o.push({label:"ID",parameter:["PARAM","DeviceID.ID"]}),t({filter:r,indexParameters:o,sort:s})}))},component:()=>({view:e=>{document.title="Devices";const t=e.attrs.indexParameters;const n=e.attrs.sort?js(e.attrs.sort):{},r={};for(let e=0;e<t.length;e++){const s=t[e];if(s.unsortable)continue;const o=zs(s.parameter);o&&(r[e]=n[o]||0)}let s=!e.attrs.filter||$s(e.attrs.filter);s=_s(s);const o=fr("devices",s,{limit:e.state.showCount||Ps,sort:n}),i=lr("devices",s),a=Is(s,t),l={};l.attributes=t,l.data=o.value,l.total=i.value,l.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Ps)+Ps,is.redraw()},l.sortAttributes=r,l.onSortChange=function(r){const s=Object.assign({},n);for(const[e,n]of Object.entries(r)){const r=zs(t[e].parameter);r&&(delete s[r],s[r]=n)}const o={sort:JSON.stringify(s)};e.attrs.filter&&(o.filter=e.attrs.filter),is.route.set("/devices",o)},l.downloadUrl=a,l.valueCallback=(e,t)=>is.context({device:t,parameter:e.parameter},e.type||"parameter",e),l.recordActionsCallback=e=>is("a",{href:`#!/devices/${encodeURIComponent(e["DeviceID.ID"].value[0])}`},"Ver"),window.authorizer.hasAccess("devices",3)&&(l.actionsCallback=Ls);const c={resource:"devices"};return c.filter=e.attrs.filter,c.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/devices",n)},[is("h1","Listado de dispositivos"),is(Ds,c),is("loading",{queries:[o,i]},is(ys,l))]}})});const Rs=Object.freeze({__proto__:null,init:function(e){return window.authorizer.hasAccess("devices",2)?Promise.resolve({deviceId:e.id,deviceFilter:["=",["PARAM","DeviceID.ID"],e.id]}):Promise.reject(new Error("No esta autorizado a ver esta pagina"))},component:()=>({view:e=>{document.title=`${e.attrs.deviceId} - Devices`;const t=fr("devices",e.attrs.deviceFilter);if(!t.value.length)return t.fulfilling?is("loading",{queries:[t]},is("div",{style:"height: 100px;"})):is("p.error",`No such device ${e.attrs.deviceId}`);const n=vt.ui.device,r=[];for(const e of Object.values(n))r.push(is.context({device:t.value[0],deviceQuery:t},e.type,e));return[is("h1",e.attrs.deviceId),r]}})}),Ts=()=>({view:function(e){return document.title="Error!",is("p.error",e.attrs.error)}}),Us=vt.ui.pageSize||10,Fs=dt(He),Ws=dt(JSON.parse),Bs=[{id:"device",label:"Dispositivo"},{id:"channel",label:"Canal"},{id:"code",label:"Codigo"},{id:"message",label:"Mensaje"},{id:"detail",label:"Detalle"},{id:"retries",label:"Intentos"},{id:"timestamp",label:"Fecha y hora"}],qs=dt((e=>{const t={};for(const e of Bs)t[e.label]="timestamp"===e.id?`DATE_STRING(${e.id})`:e.id;return`api/faults.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`})),Js=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("faults",e[2],e[3]):e))));const Vs=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("faults",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Faults";const t=e.attrs.sort?Ws(e.attrs.sort):{},n={};for(let e=0;e<Bs.length;e++){const r=Bs[e];"detail"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||Fs(e.attrs.filter);r=Js(r);const s=fr("faults",r,{limit:e.state.showCount||Us,sort:t}),o=lr("faults",r),i=qs(r),a={};a.attributes=Bs,a.data=s.value,a.valueCallback=(e,t)=>{if("device"===e.id){const e=`#!/devices/${encodeURIComponent(t.device)}`;return is("a",{href:e},t.device)}return"message"===e.id?is("long-text",{text:t.message}):"detail"===e.id?is("long-text",{text:es(t.detail)}):"timestamp"===e.id?new Date(t.timestamp).toLocaleString():t[e.id]},a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Us)+Us,is.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[Bs[e].id],r[Bs[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/faults",s)},a.downloadUrl=i,window.authorizer.hasAccess("faults",3)&&(a.actionsCallback=e=>is("button.primary",{disabled:0===e.size,title:"Eliminar fallos seleccionados",onclick:t=>{t.redraw=!1,t.target.disabled=!0,confirm(`Esta seguro que desea eliminar ${e.size} fallos?`)&&Promise.all(Array.from(e).map((e=>mr("faults",e)))).then((e=>{mt("success",`${e.length} fallos eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())}))}},"Eliminar"));const l={resource:"faults"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/faults",n)},[is("h1","Listado de errores"),is(Ds,l),is("loading",{queries:[s,o]},is(ys,a))]}})});let Ks,Hs,Qs;function Ys(){Qs||(Qs=mt("error","Error loading JS resource, please reload the page",{Recargar:()=>{window.location.reload()}}))}function Gs(){return Ks?Promise.resolve():new Promise(((e,t)=>{const n=[import("./codemirror-7d985c7d.js").then((function(e){return e.c})),import("./codemirror-7d985c7d.js").then((function(e){return e.j})),import("./codemirror-7d985c7d.js").then((function(e){return e.y}))];Promise.all(n).then((t=>{Ks=t[0].default,e()})).catch((e=>{Ys(),t(e)}))}))}const Zs=()=>({view:e=>is("textarea",{name:e.attrs.id,value:e.attrs.value,oncreate:t=>{const n=Ks.fromTextArea(t.dom,{mode:e.attrs.mode,lineNumbers:!0,readOnly:e.attrs.readOnly,extraKeys:{"Ctrl-Enter":()=>{e.attrs.onSubmit&&e.attrs.onSubmit(t.dom)},"Cmd-Enter":()=>{e.attrs.onSubmit&&e.attrs.onSubmit(t.dom)}}});e.attrs.onChange&&n.on("change",(t=>{e.attrs.onChange(t.getValue())})),e.attrs.focus&&n.focus(),e.attrs.onReady&&e.attrs.onReady(n)}})}),Xs={presets:"preset",provisions:"provision",virtualParameters:"parametro virtual",files:"archivo",users:"usuario",permissions:"permiso"};function eo(e,t,n){if("combo"===t.type){let r="",s=t.options;null!=e.object[t.id]&&(s.includes(e.object[t.id])||(s=s.concat([e.object[t.id]])),r=e.object[t.id]);const o=[is("option",{value:""},"")];for(const e of s)o.push(is("option",{value:e},e));return is("select",{name:t.id,value:r,oncreate:n?e=>{e.dom.focus()}:null,onchange:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1}},o)}if("multi"===t.type){const r=Array.from(new Set(t.options.concat(e.object[t.id]||[]))),s=new Set(e.object[t.id]),o=r.map((r=>{const i=`${t.id}-${r}`;return is("tr",[is("td",is("input",{type:"checkbox",id:i,value:r,oncreate:e=>{n&&!o.length&&e.dom.focus(),s.has(r)&&(e.dom.checked=!0)},onchange:n=>{n.target.checked?s.add(r):s.delete(r),e.object[t.id]=Array.from(s),e.modified=!0,n.redraw=!1}})),is("td",r)])}));return is("table",o)}if("code"===t.type){const n={id:t.id,value:e.object[t.id],mode:"javascript",onSubmit:e=>{e.form.querySelector("button[type=submit]").click()},onChange:n=>{e.object[t.id]=n,e.modified=!0}};return is(Zs,n)}if("file"===t.type)return is("input",{type:"file",name:t.id,oncreate:n?e=>{e.dom.focus()}:null,onchange:n=>{e.object[t.id]=n.target.files,e.modified=!0,n.redraw=!1}});if("textarea"===t.type)return is("textarea",{name:t.id,value:e.object[t.id],readonly:"_id"===t.id&&!e.isNew,cols:t.cols||80,rows:t.rows||4,style:"resize: none;",oncreate:n?e=>{const t=e.dom;t.focus(),t.setSelectionRange(t.value.length,t.value.length)}:null,oninput:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1},onkeypress:e=>{if(e.redraw=!1,13===e.which&&!e.shiftKey){return e.target.form.querySelector("button[type=submit]").click(),!1}return!0}});let r=null;return t.options&&(r=function(e){const t="datalist"+e.reduce(((e,t)=>e^function(e){let t=0;for(let n=0;n<e.length;++n)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}(t)),0);if(!Wr.has(t)){const n=N("datalist",{id:t},e.map((e=>N("option",{value:e}))));Wr.set(t,n)}return t}(t.options)),is("input",{type:"password"===t.type?"password":"text",name:t.id,list:r,autocomplete:r?"off":null,disabled:"_id"===t.id&&!e.isNew,value:e.object[t.id],oncreate:n?e=>{e.dom.focus()}:null,oninput:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1}})}const to=()=>({view:e=>{const t=e.attrs.actionHandler,n=e.attrs.attributes,r=e.attrs.resource,s=e.attrs.base||{};e.state.current||(e.state.current={isNew:!s._id,object:Object.assign({},s),modified:!1});const o=e.state.current,i=[];let a=!1;for(const e of n){let t=!1;a||!o.isNew&&"_id"===e.id||(t=a=!0),i.push(is("p",is("label",{for:e.id},e.label||e.id),is("br"),eo(o,e,t)))}const l=is("button.primary",{type:"submit"},"Guardar"),c=[l];o.isNew||c.push(is("button.primary",{type:"button",title:`Delete ${Xs[r]||r}`,onclick:e=>{e.redraw=!1,e.target.disabled=!0,t("delete",o.object).then((()=>{e.target.disabled=!1}))}},"Eliminar")),i.push(is(".actions-bar",c));const u=[is("h1",`${o.isNew?"Nuevo":"Editando"} ${Xs[r]||r}`),is("form",{onsubmit:e=>{e.redraw=!1,e.preventDefault(),l.dom.disabled=!0,t("save",o.object).then((()=>{l.dom.disabled=!1}))}},i)];return is("div.put-form",u)}}),no=vt.ui.pageSize||10,ro=dt(He),so=dt(JSON.parse),oo=[{id:"_id",label:"Nombre"},{id:"channel",label:"Canal"},{id:"weight",label:"Peso"},{id:"schedule",label:"Programado"},{id:"events",label:"Eventos"},{id:"precondition",label:"Precondicion",type:"textarea"},{id:"provision",label:"Provision",type:"combo"},{id:"provisionArgs",label:"Argumentos",type:"textarea"}],io=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("presets",e[2],e[3]):e))));function ao(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id;delete o._id;const t={};if(e||(t._id="El ID no puede estar vacio"),o.provision||(t.provision="No hay provision seleccionado"),Object.keys(t).length)return void r(t);if(o.precondition)try{o.precondition=Qe(ro(o.precondition))}catch(e){return void r({precondition:"La precondicion debe ser una expresion valida"})}vr("presets",e).then((t=>t&&n?(dr(Date.now()),void r({_id:"El preset ya existe"})):t||n?void gr("presets",e,o).then((()=>{mt("success","Preset "+(t?"actualizado":"creado")),dr(Date.now()),r(null)})).catch(s):(dr(Date.now()),void r({_id:"El preset no existe"})))).catch(s)}else"delete"===e?mr("presets",o._id).then((()=>{mt("success","Preset eliminado"),dr(Date.now()),r(null)})).catch((e=>{s(e),dr(Date.now())})):s(new Error("Accion no definida"))}))}const lo={resource:"presets",attributes:oo},co=dt((e=>{const t={};for(const e of oo)t[e.label]=e.id;return`api/presets.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`}));const uo=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("presets",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Presets";const t=e.attrs.sort?so(e.attrs.sort):{},n={};for(let e=0;e<oo.length;e++){const r=oo[e];"events"!==r.id&&"precondition"!==r.id&&"provision"!==r.id&&"provisionArgs"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||ro(e.attrs.filter);r=io(r);const s=fr("presets",r,{limit:e.state.showCount||no,sort:t}),o=lr("presets",r),i=new Set,a=new Set(["refresh","value","tag","reboot","reset","download","instances"]),l=fr("provisions",!0);if(l.fulfilled)for(const e of l.value)i.add(e._id),a.add(e._id);oo.find((e=>"provision"===e.id)).options=Array.from(a);const c=co(r),u={};u.attributes=oo,u.data=s.value,u.total=o.value,u.showMoreCallback=function(){e.state.showCount=(e.state.showCount||no)+no,is.redraw()},u.sortAttributes=n,u.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[oo[e].id],r[oo[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/admin/presets",s)},u.downloadUrl=c,u.valueCallback=(e,t)=>{if("precondition"===e.id){let e="#!/devices";return t.precondition.length&&(e+=`?${is.buildQueryString({filter:t.precondition})}`),is("a",{href:e,title:t.precondition},t.precondition)}return"provision"===e.id&&i.has(t[e.id])?is("a",{href:`#!/admin/provisions?${is.buildQueryString({filter:`Q("ID", "${t.provision}")`})}`},t.provision):t[e.id]},u.recordActionsCallback=e=>[is("a",{onclick:()=>{let t=null;const n=is(to,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{ao(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)mt("error",e);else Fr(t);r()})).catch((e=>{mt("error",e.message),r()}))}))},lo));t=()=>e.provision?n:is("div",{style:"margin:20px"},"This UI only supports presets with a single 'provision' configuraiton. If this preset was originally created from the old UI (genieacs-gui), you must edit it there."),Ur(t,(()=>!n.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Ver")],window.authorizer.hasAccess("presets",3)&&(u.actionsCallback=e=>[is("button.primary",{title:"Crear nuevo preset",onclick:()=>{let e=null;const t=is(to,Object.assign({actionHandler:(t,n)=>new Promise((r=>{ao(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)mt("error",e);else Fr(e);r()})).catch((e=>{mt("error",e.message),r()}))}))},lo));e=()=>t,Ur(e,(()=>!t.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nuevo"),is("button.primary",{title:"Eliminar presets seleccionados",disabled:!e.size,onclick:t=>{confirm(`Eliminando ${e.size} presets. Esta seguro?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>mr("presets",e)))).then((e=>{mt("success",`${e.length} presets eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())})))}},"Eliminar")]);const f={resource:"presets"};return f.filter=e.attrs.filter,f.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/admin/presets",n)},[is("h1","Listado de presets"),is(Ds,f),is("loading",{queries:[s,o]},is(ys,u))]}})}),fo=vt.ui.pageSize||10,ho=dt(He),po=dt(JSON.parse),mo=[{id:"_id",label:"Nombre"},{id:"script",label:"Codigo",type:"code"}],go=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("provisions",e[2],e[3]):e))));function vo(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id;if(delete o._id,!e)return void r({_id:"El ID no puede estar vacio"});vr("provisions",e).then((t=>t&&n?(dr(Date.now()),void r({_id:"El provision ya existe"})):t||n?void gr("provisions",e,o).then((()=>{mt("success","Provision "+(t?"actualizado":"creado")),dr(Date.now()),r(null)})).catch((e=>{400===e.code&&e.response?s(new Error(e.response)):s(e)})):(dr(Date.now()),void r({_id:"Provision does not exist"})))).catch(s)}else"delete"===e?mr("provisions",o._id).then((()=>{mt("success","Provision eliminado"),dr(Date.now()),r(null)})).catch((e=>{dr(Date.now()),s(e)})):s(new Error("Accion no definida"))}))}const yo={resource:"provisions",attributes:mo},wo=dt((e=>{const t={};for(const e of mo)t[e.label]=e.id;return`api/provisions.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`}));const bo=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("provisions",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{Gs().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Provisiones";const t=e.attrs.sort?po(e.attrs.sort):{},n={};for(let e=0;e<mo.length;e++)n[e]=t[mo[e].id]||0;let r=!e.attrs.filter||ho(e.attrs.filter);r=go(r);const s=fr("provisions",r,{limit:e.state.showCount||fo,sort:t}),o=lr("provisions",r),i=wo(r),a={};a.attributes=mo,a.data=s.value,a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||fo)+fo,is.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[mo[e].id],r[mo[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/admin/provisions",s)},a.downloadUrl=i,a.recordActionsCallback=e=>[is("a",{onclick:()=>{let t=null;const n=is(to,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{vo(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)mt("error",e);else Fr(t);r()})).catch((e=>{mt("error",e.message),r()}))}))},yo));t=()=>n,Ur(t,(()=>!n.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Ver")],window.authorizer.hasAccess("provisions",3)&&(a.actionsCallback=e=>[is("button.primary",{title:"Crear nuevo provision",onclick:()=>{let e=null;const t=is(to,Object.assign({actionHandler:(t,n)=>new Promise((r=>{vo(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)mt("error",e);else Fr(e);r()})).catch((e=>{mt("error",e.message),r()}))}))},yo));e=()=>t,Ur(e,(()=>!t.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nuevo"),is("button.primary",{title:"Eliminar provisions seleccionados",disabled:!e.size,onclick:t=>{confirm(`Eliminando ${e.size} provisions. Esta seguro?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>mr("provisions",e)))).then((e=>{mt("success",`${e.length} provisiones eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())})))}},"Eliminar")]);const l={resource:"provisions"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/admin/provisions",n)},[is("h1","Listado de provisiones"),is(Ds,l),is("loading",{queries:[s,o]},is(ys,a))]}})}),Ao=vt.ui.pageSize||10,So=dt(He),xo=dt(JSON.parse),Oo=[{id:"_id",label:"Nombre"},{id:"script",label:"Codigo",type:"code"}],ko=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("virtualParameters",e[2],e[3]):e))));function Co(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id;if(delete o._id,!e)return void r({_id:"El ID no puede estar vacio"});vr("virtualParameters",e).then((t=>t&&n?(dr(Date.now()),void r({_id:"El parametro virtual ya existe"})):t||n?void gr("virtualParameters",e,o).then((()=>{mt("success","Virtual parameter "+(t?"actualizado":"creado")),dr(Date.now()),r(null)})).catch((e=>{400===e.code&&e.response?s(new Error(e.response)):s(e)})):(dr(Date.now()),void r({_id:"Virtual parameter does not exist"})))).catch(s)}else"delete"===e?mr("virtualParameters",o._id).then((()=>{mt("success","Parametro virtual eliminado"),dr(Date.now()),r(null)})).catch((e=>{dr(Date.now()),s(e)})):s(new Error("Accion no definida"))}))}const Eo={resource:"virtualParameters",attributes:Oo},No=dt((e=>{const t={};for(const e of Oo)t[e.label]=e.id;return`api/virtualParameters.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`}));const Do=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("virtualParameters",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{Gs().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Parametros Virtuales";const t=e.attrs.sort?xo(e.attrs.sort):{},n={};for(let e=0;e<Oo.length;e++)n[e]=t[Oo[e].id]||0;let r=!e.attrs.filter||So(e.attrs.filter);r=ko(r);const s=fr("virtualParameters",r,{limit:e.state.showCount||Ao,sort:t}),o=lr("virtualParameters",r),i=No(r),a={};a.attributes=Oo,a.data=s.value,a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Ao)+Ao,is.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[Oo[e].id],r[Oo[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/admin/virtualParameters",s)},a.downloadUrl=i,a.recordActionsCallback=e=>[is("a",{onclick:()=>{let t=null;const n=is(to,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{Co(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)mt("error",e);else Fr(t);r()})).catch((e=>{mt("error",e.message),r()}))}))},Eo));t=()=>n,Ur(t,(()=>!n.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Ver")],window.authorizer.hasAccess("virtualParameters",3)&&(a.actionsCallback=e=>[is("button.primary",{title:"Crear nuevo parametro virtual",onclick:()=>{let e=null;const t=is(to,Object.assign({actionHandler:(t,n)=>new Promise((r=>{Co(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)mt("error",e);else Fr(e);r()})).catch((e=>{mt("error",e.message),r()}))}))},Eo));e=()=>t,Ur(e,(()=>!t.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nuevo"),is("button.primary",{title:"Eliminar parametros virtuales seleccionados",disabled:!e.size,onclick:t=>{confirm(`Eliminando ${e.size} parametros virtuales. Esta seguro?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>mr("virtualParameters",e)))).then((e=>{mt("success",`${e.length} parametros virtuales eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())})))}},"Eliminar")]);const l={resource:"virtualParameters"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/admin/virtualParameters",n)},[is("h1","Listado de parametros virtuales"),is(Ds,l),is("loading",{queries:[s,o]},is(ys,a))]}})}),Po=vt.ui.pageSize||10,$o=dt(He),jo=dt(JSON.parse),zo=[{id:"_id",label:"Nombre"},{id:"metadata.fileType",label:"Tipo",options:["1 Firmware Upgrade Image","2 Web Content","3 Vendor Configuration File","4 Tone File","5 Ringer File"]},{id:"metadata.oui",label:"OUI"},{id:"metadata.productClass",label:"Modelo"},{id:"metadata.version",label:"Version"}],Io={resource:"files",attributes:zo.slice(1).concat([{id:"file",label:"Archivo",type:"file"}])},_o=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("files",e[2],e[3]):e))));const Lo=dt((e=>{const t={};for(const e of zo)t[e.label]=e.id;return`api/files.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`}));const Mo=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("files",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Archivos";const t=e.attrs.sort?jo(e.attrs.sort):{},n={};for(let e=0;e<zo.length;e++)n[e]=t[zo[e].id]||0;let r=!e.attrs.filter||$o(e.attrs.filter);r=_o(r);const s=fr("files",r,{limit:e.state.showCount||Po,sort:t}),o=lr("files",r),i=Lo(r),a={};a.attributes=zo,a.data=s.value,a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Po)+Po,is.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[zo[e].id],r[zo[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/admin/files",s)},a.downloadUrl=i,a.recordActionsCallback=e=>[is("a",{href:"api/blob/files/"+e._id},"Descargar")],window.authorizer.hasAccess("files",3)&&(a.actionsCallback=e=>[is("button.primary",{title:"Crear nuevo archivo",onclick:()=>{let e=null;const t=is(to,Object.assign({actionHandler:(t,n)=>new Promise((r=>{(function(e,t){return new Promise(((n,r)=>{const s=Object.assign({},t);if("save"===e){const e=s.file?s.file[0]:null;if(delete s.file,!e)return void n({file:"File not selected"});const t=e.name;vr("files",t).then((o=>{if(o)return dr(Date.now()),void n({file:"El archivo ya existe"});ir({method:"PUT",headers:Object.assign({"Content-Type":"application/octet-stream",Accept:"application/octet-stream"},s),url:`api/files/${encodeURIComponent(t)}`,serialize:e=>e,body:e}).then((()=>{mt("success","File "+(o?"actualizado":"creado")),dr(Date.now()),n(null)})).catch(r)})).catch(r)}else r(new Error("Accion no definida"))}))})(t,n).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)mt("error",e);else Fr(e);r()})).catch((e=>{mt("error",e.message),r()}))}))},Io));e=()=>t,Ur(e,(()=>!t.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nuevo"),is("button.primary",{title:"Eliminar archivos seleccionados",disabled:!e.size,onclick:t=>{confirm(`Eliminando ${e.size} archivos. Esta seguro?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>mr("files",e)))).then((e=>{mt("success",`${e.length} archivos eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())})))}},"Eliminar")]);const l={resource:"files"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/admin/files",n)},[is("h1","Listado de archivos"),is(Ds,l),is("loading",{queries:[s,o]},is(ys,a))]}})});function Ro(e){let t=1;if("object"!=typeof e)return t;if(Array.isArray(e)){for(const n of e)t+=Ro(n);return t}const n=Object.entries(e).map((([e,t])=>[e,Ro(t)]));n.sort(((e,t)=>e[1]!==t[1]?e[1]-t[1]:t[0]>e[0]?-1:1));for(const[r,s]of n){t+=s;const n=e[r];delete e[r],e[r]=n}return t}function To(e){e.sort(((e,t)=>e._id>t._id?1:e._id<t._id?-1:0));const t={};for(const n of e){const e=n._id.split(".");let r=t;for(;e.length>1;){const t=e.shift();"object"!=typeof r[t]&&(r[t]={}),r=r[t]}r[e[0]]=n.value}const n=function(e){if(null==e||"object"!=typeof e)return e;if(Object.keys(e).length<=300){let t=[];for(const n of Object.keys(e)){const e=Math.floor(+n);if(!(e>=0&&e<300&&String(e)===n)){t=[];break}{const n=Math.floor(e/30);t[n]||(t[n]=0),t[n]|=1<<e%30}}let n=0;for(;t.length&&1073741823===(n=t.shift()););if(n&&(~n&n+1)===n+1){const t=[];for(let n=0;n<Object.keys(e).length;n++)t[n]=e[n];e=t}}for(const[t,r]of Object.entries(e))e[t]=n(r);return e},r=n(t);return Ro(r),r}function Uo(e,t){return new Promise(((n,r)=>{try{let s=Hs.parse(t,{schema:"failsafe"});if(s){const t={};let n=t;e.forEach(((t,r)=>{r<e.length-1?(n[t]={},n=n[t]):n[t]=s})),s=function(e){const t={},n=(e,r)=>{for(const[s,o]of Object.entries(e)){const e=r?`${r}.${s}`:s;void 0!==o&&(null===o||"object"!=typeof o?t[e]=o:n(o,e))}};return null!==e&&"object"==typeof e&&n(e,""),t}(t)}else s={};for(const e of Object.values(s))He(e);(function(e="%"){const t=Qe(["LIKE",["PARAM","_id"],e]);return ir({method:"GET",url:`api/config/?${N.buildQueryString({filter:t})}`,background:!0})})(`${e.join(".")}.%`).then((e=>{const t={};for(const n of e)t[n._id]=n.value;const o=function(e,t){const n={add:[],remove:[]};for(const[r,s]of Object.entries(t))e[r]&&e[r]===s||n.add.push({_id:r,value:s});for(const r of Object.keys(e))t[r]||n.remove.push(r);return n}(t,s);if(!o.add.length&&!o.remove.length)return void n(null);const i=[];for(const e of o.add)i.push(gr("config",e._id,e));for(const e of o.remove)i.push(mr("config",e));Promise.all(i).then((()=>{n(null)})).catch(r)})).catch(r)}catch(e){n({config:e.message})}}))}const Fo=()=>({view:e=>{const t=e.attrs.prefix.split("."),n=e.attrs.name,r=e.attrs.data;let s;if(""===t[t.length-1]&&t.pop(),r.length){s=To(r);for(const e of t)s=s[e]}const o=s&&Object.values(s).length?Hs.stringify(s,{schema:"failsafe"}):"",i=is(Zs,{id:`${n}-ui-config`,value:o,mode:"yaml",focus:!0,onSubmit:e=>{e.form.querySelector("button[type=submit]").click()},onChange:t=>{e.state.updatedYaml=t,e.state.modified=!0}}),a=is("button.primary",{type:"submit"},"Guardar");return is("div.put-form",[is("h1",`Editando ${n}`),is("form",{onsubmit:n=>{n.redraw=!1,n.preventDefault(),null==e.state.updatedYaml&&(e.state.updatedYaml=o),Uo(t,e.state.updatedYaml).then(e.attrs.onUpdate).catch(e.attrs.onError)}},[i,is(".actions-bar",[a])])])}});function Wo(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){let e=o._id||"";delete o._id;const t=/^[0-9a-zA-Z_.-]+$/;if(e=e.trim(),!e.match(t))return void r({_id:"Invalid ID"});try{o.value=Qe(He(o.value||""))}catch(e){return void r({value:"El valor de configuracion debe ser una expresion valida"})}vr("config",e).then((t=>t&&n?(dr(Date.now()),void r({_id:"La configuracion ya existe"})):t||n?void gr("config",e,o).then((()=>{mt("success","Config "+(t?"actualizado":"creado")),dr(Date.now()),r(null)})).catch(s):(dr(Date.now()),void r({_id:"La configuracion no existe"})))).catch(s)}else"delete"===e?mr("config",o._id).then((()=>{mt("success","Configuracion eliminada"),dr(Date.now()),r(null)})).catch((e=>{dr(Date.now()),s(e)})):s(new Error("Accion no definida"))}))}const Bo={resource:"config",attributes:[{id:"_id",label:"Clave"},{id:"value",label:"Valor",type:"textarea"}]};function qo(e,t){const n=e.value.sort(((e,t)=>e._id<t._id?-1:1));let r;if(t){const e=t.split(" ").filter((e=>e));e.length&&(r=new RegExp(e.map((e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"))).join(".*"),"i"))}const s=[];for(const e of n){const t={};!r||r.test(e._id)||r.test(e.value)||(t.style="display: none;");const n=is("button",{title:"Editar valor de configuracion",onclick:()=>{let t=null;const n=is(to,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{Wo(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)mt("error",e);else Fr(t);r(null)})).catch((e=>{mt("error",e.message),r(null)}))}))},Bo));t=()=>n,Ur(t,(()=>!n.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},br("edit")),o=is("button",{title:"Eliminar configuracion",onclick:()=>{confirm(`Eliminando configuracion ${e._id}. Esta seguro?`)&&Wo("delete",e).catch((e=>{throw e}))}},br("remove"));s.push(is("tr",t,is("td.left",is("long-text",{text:e._id})),is("td.right",is("span",[is("long-text",{text:`${e.value}`}),n,o]))))}return s.length||s.push(is("tr.empty",is("td",{colspan:2},"No config"))),is("table",is("tbody",s))}const Jo=Object.freeze({__proto__:null,init:function(){return window.authorizer.hasAccess("config",2)?new Promise(((e,t)=>{Promise.all([Gs(),Hs?Promise.resolve():new Promise(((e,t)=>{import("./yaml-2a7d75e0.js").then((function(e){return e.i})).then((t=>{Hs=t,e()})).catch((e=>{Ys(),t(e)}))}))]).then((()=>{e({})})).catch(t)})):Promise.reject(new Error("No esta autorizado a ver esta pagina"))},component:()=>({view:e=>{document.title="Configuracion";const t=is("input",{type:"text",placeholder:"Buscar configuracion",oninput:t=>{e.state.searchString=t.target.value,t.redraw=!1,clearTimeout(e.state.timeout),e.state.timeout=setTimeout(is.redraw,250)}}),n=fr("config",!0);let r;const s=[];if(window.authorizer.hasAccess("config",3)){r=is("button.primary",{title:"Crear nueva configuracion",onclick:()=>{let e=null;const t=is(to,Object.assign({actionHandler:(t,n)=>new Promise((r=>{Wo(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)mt("error",e);else Fr(e);r(null)})).catch((e=>{mt("error",e.message),r()}))}))},Bo));e=()=>t,Ur(e,(()=>!t.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nueva config");const e=[{name:"pagina de resumen",prefix:"ui.overview.groups.",data:[]},{name:"pagina de graficos",prefix:"ui.overview.charts.",data:[]},{name:"filtros",prefix:"ui.filters.",data:[]},{name:"pagina principal",prefix:"ui.index.",data:[]},{name:"pagina de dispositivos",prefix:"ui.device.",data:[]}];if(n.fulfilled)for(const t of n.value)for(const n of e)if(t._id.startsWith(n.prefix)){n.data.push(t);break}for(const t of e){const e={prefix:t.prefix,name:t.name,data:t.data};s.push(is("button",{onclick:()=>{let n=null;const r=is(Fo,Object.assign({onUpdate:e=>{const r=e?Object.values(e):[];if(r.length)for(const e of r)mt("error",e);else mt("success",`${t.name.replace(/^[a-z]/,t.name[0].toUpperCase())} config updated`),Fr(n);dr(Date.now())},onError:e=>{mt("error",e.message),dr(Date.now()),Fr(n)}},e));n=()=>r,Ur(n,(()=>!r.state.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},`Editar ${t.name}`))}}return[is("h1","Listado de configuracion"),is("loading",{queries:[n]},is(".all-parameters",t,is(".parameter-list",{style:"height: 400px"},qo(n,e.state.searchString)),is(".actions-bar",[r].concat(s))))]}})}),Vo=vt.ui.pageSize||10,Ko=dt(He),Ho=dt(JSON.parse),Qo=[{id:"role",label:"Rol"},{id:"resource",label:"Recurso",type:"combo",options:["config","devices","faults","files","permissions","users","presets","provisions","virtualParameters"]},{id:"filter",label:"Filtro",type:"textarea"},{id:"access",label:"Acceso",type:"combo",options:["1: count","2: read","3: write"]},{id:"validate",label:"Validar",type:"textarea"}],Yo=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("permissions",e[2],e[3]):e))));function Go(e,t){return new Promise(((n,r)=>{const s=Object.assign({},t);if("save"===e){if(!s.role)return void n({role:"Role can not be empty"});if(!s.resource)return void n({resource:"Resource can not be empty"});if(!s.access)return void n({access:"Access can not be empty"});if("3: write"===s.access)s.access=3;else if("2: read"===s.access)s.access=2;else{if("1: count"!==s.access)return void n({access:"Invalid access level"});s.access=1}if(s.filter)try{s.filter=Qe(Ko(s.filter))}catch(e){return void n({filter:"Filter must be valid expression"})}if(s.validate)try{s.validate=Qe(Ko(s.validate))}catch(e){return void n({validate:"Validate must be valid expression"})}const e=`${s.role}:${s.resource}:${s.access}`;vr("permissions",e).then((t=>{if(t)return dr(Date.now()),void n({_id:"El permiso ya existe"});gr("permissions",e,s).then((()=>{mt("success","Permiso creado"),dr(Date.now()),n(null)})).catch(r)})).catch(r)}else"delete"===e?mr("permissions",s._id).then((()=>{mt("success","Permiso eliminado"),dr(Date.now()),n(null)})).catch((e=>{dr(Date.now()),r(e)})):r(new Error("Accion no definida"))}))}const Zo={resource:"permissions",attributes:Qo},Xo=dt((e=>{const t={};for(const e of Qo)t[e.label]=e.id;return`api/permissions.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`}));const ei=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("permissions",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Permissions";const t=e.attrs.sort?Ho(e.attrs.sort):{},n={};for(let e=0;e<Qo.length;e++){const r=Qo[e];"filter"!==r.id&&"validate"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||Ko(e.attrs.filter);r=Yo(r);const s=fr("permissions",r,{limit:e.state.showCount||Vo,sort:t}),o=lr("permissions",r),i=Xo(r),a={};a.attributes=Qo,a.data=s.value,a.total=o.value,a.valueCallback=(e,t)=>{if("access"===e.id){const e=t.access;return 1===e?"1: count":2===e?"2: read":3===e?"3: write":e}return t[e.id]},a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Vo)+Vo,is.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[Qo[e].id],r[Qo[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/admin/permissions",s)},a.downloadUrl=i,window.authorizer.hasAccess("permissions",3)&&(a.recordActionsCallback=e=>[is("button",{title:"Eliminar permiso",onclick:()=>{confirm(`Eliminando permiso ${e._id}. Esta seguro?`)&&Go("delete",e).catch((e=>{mt("error",e.message)}))}},br("remove"))],a.actionsCallback=e=>[is("button.primary",{title:"Crear nuevo permiso",onclick:()=>{let e=null;const t=is(to,Object.assign({actionHandler:(t,n)=>new Promise((r=>{Go(t,n).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)mt("error",e);else Fr(e);r()})).catch((e=>{mt("error",e.message),r()}))}))},Zo));e=()=>t,Ur(e,(()=>!t.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nuevo"),is("button.primary",{title:"Eliminar permisos seleccionados",disabled:!e.size,onclick:t=>{confirm(`Eliminando ${e._id} permisos. Esta seguro?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>mr("permissions",e)))).then((e=>{mt("success",`${e.length} permisos eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())})))}},"Eliminar")]);const l={resource:"permissions"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/admin/permissions",n)},[is("h1","Listado de permisos"),is(Ds,l),is("loading",{queries:[s,o]},is(ys,a))]}})}),ti=vt.ui.pageSize||10,ni=dt(He),ri=dt(JSON.parse),si=[{id:"_id",label:"Nombre de usuario"},{id:"roles",label:"Roles",type:"multi",options:[]}],oi=dt((e=>Je(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?xs("users",e[2],e[3]):e))));function ii(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id,t=o.password,i=o.confirm;if(delete o._id,delete o.password,delete o.confirm,!e)return void r({_id:"El ID no puede estar vacio"});if(n){if(!t)return void r({password:"La contrasea no puede estar vacia"});if(t!==i)return void r({confirm:"La contrasea de confirmacion no coincide con la contrasea"})}if(!Array.isArray(o.roles)||!o.roles.length)return void r({roles:"Role(s) must be selected"});o.roles=o.roles.join(","),vr("users",e).then((i=>i&&n?(dr(Date.now()),void r({_id:"El usuario ya existe"})):i||n?void gr("users",e,o).then((()=>{n?wr(e,t).then((()=>{mt("success","User created"),dr(Date.now()),r(null)})).catch(s):(mt("success","Usuario actualizado"),dr(Date.now()),r(null))})).catch(s):(dr(Date.now()),void r({_id:"User does not exist"})))).catch(s)}else"delete"===e?mr("users",o._id).then((()=>{mt("success","Usuario eliminado"),dr(Date.now()),r(null)})).catch((e=>{dr(Date.now()),s(e)})):s(new Error("Accion no definida"))}))}const ai=dt((e=>{const t={};for(const e of si)t[e.label]=e.id;return`api/users.csv?${is.buildQueryString({filter:Qe(e),columns:JSON.stringify(t)})}`}));const li=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("users",2))return Promise.reject(new Error("No esta autorizado a ver esta pagina"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Users";const t=e.attrs.sort?ri(e.attrs.sort):{},n={};for(let e=0;e<si.length;e++){"roles"!==si[e].id&&(n[e]=t[si[e].id]||0)}let r=!e.attrs.filter||ni(e.attrs.filter);r=oi(r);const s=fr("users",r,{limit:e.state.showCount||ti,sort:t}),o=lr("users",r),i=fr("permissions",!0);if(i.fulfilled)for(const e of si)"roles"===e.id&&(e.options=[...new Set(i.value.map((e=>e.role)))]);const a=ai(r),l=window.authorizer.hasAccess("users",3),c={};if(c.attributes=si,c.data=s.value,c.total=o.value,c.showMoreCallback=function(){e.state.showCount=(e.state.showCount||ti)+ti,is.redraw()},c.sortAttributes=n,c.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[si[e].id],r[si[e].id]=t;const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),is.route.set("/admin/users",s)},c.downloadUrl=a,c.recordActionsCallback=e=>[is("a",{onclick:()=>{let t=null;const n=is(to,Object.assign({base:{_id:e._id,roles:e.roles.split(",")},actionHandler:(e,n)=>new Promise((r=>{ii(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)mt("error",e);else Fr(t);r()})).catch((e=>{mt("error",e.message),r()}))}))},{resource:"users",attributes:si}));t=()=>{const r=[n];if(l){r.push(is("hr"));const n={noAuth:!0,username:e._id,onPasswordChange:()=>{Fr(t),is.redraw()}};r.push(is(us,n))}return r},Ur(t,(()=>!n.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Ver")],l){const e={resource:"users",attributes:[si[0],{id:"password",label:"Contrasea",type:"password"},{id:"confirm",label:"Confirmar contrasea",type:"password"},si[1]]};c.actionsCallback=t=>[is("button.primary",{title:"Crear nuevo usuario",onclick:()=>{let t=null;const n=is(to,Object.assign({actionHandler:(e,n)=>new Promise((r=>{ii(e,n,!0).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)mt("error",e);else Fr(t);r()})).catch((e=>{mt("error",e.message),r()}))}))},e));t=()=>n,Ur(t,(()=>!n.state.current.modified||confirm("Tiene cambios sin guardar. Desea cerrar?")))}},"Nuevo"),is("button.primary",{title:"Eliminar usuarios seleccionados",disabled:!t.size,onclick:e=>{confirm(`Eliminando ${t.size} usuarios. Esta seguro?`)&&(e.redraw=!1,e.target.disabled=!0,Promise.all(Array.from(t).map((e=>mr("users",e)))).then((e=>{mt("success",`${e.length} usuarios eliminados`),dr(Date.now())})).catch((e=>{mt("error",e.message),dr(Date.now())})))}},"Eliminar")]}const u={resource:"users"};return u.filter=e.attrs.filter,u.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),is.route.set("/admin/users",n)},[is("h1","Listado de usuarios"),is(Ds,u),is("loading",{queries:[s,o]},is(ys,c))]}})});window.authorizer=new class{constructor(e){this.permissionSets=e,this.validatorCache=new WeakMap,this.hasAccessCache=new Map,this.getFilterCache=new Map}hasAccess(e,t){const n=`${e}-${t}`;if(this.hasAccessCache.has(n))return this.hasAccessCache.get(n);let r=!1;for(const n of this.permissionSets)for(const s of n)if(s[e]&&s[e].access>=t){r=!0;break}return this.hasAccessCache.set(n,r),r}getFilter(e,t){const n=`${e}-${t}`;if(this.getFilterCache.has(n))return this.getFilterCache.get(n);let r=null;for(const n of this.permissionSets)for(const s of n)s[e]&&s[e].access>=t&&(r=at(r,s[e].filter));return this.getFilterCache.set(n,r),r}getValidator(e,t){if(this.validatorCache.has(t))return this.validatorCache.get(t);const n=[];for(const t of this.permissionSets)for(const r of t)r[e]&&r[e].access>=3&&r[e].validate&&n.push(r[e].validate);const r=(r,s,o)=>{if(!n.length)return!1;const i={mutationType:r,mutation:s,resourceType:e,object:t,options:o},a=ot(n.length>1?["OR",n]:n[0],(e=>{const t=e.split(".",1)[0];e=e.slice(t.length+1);let n=null;if(["mutation","options"].includes(t)){n=i[t];for(const t of e.split("."))if(n=null!=n&&"object"!=typeof n?null:n[t],null==n)break}else i[t]&&(n=e?i[t][e]:i[t]);return n}),Date.now());return!Array.isArray(a)&&!!a};return this.validatorCache.set(t,r),r}getPermissionSets(){return this.permissionSets}}(window.permissionSets);const ci=["presets","provisions","virtualParameters","files","config","users","permissions"];let ui;function fi(e,t){const n={render:()=>{const n=Date.now();let r;r=ui&&ui.error?N(Ts,ui):N(cs(t.component),ui);const s={};return s.page=e,s.oncreate=s.onupdate=()=>{!function(e){const t=[];for(const[n,r]of Object.entries(sr))for(const[s,o]of r.count)if(rr.accessed.get(o)>=e){if(!(rr.fulfilling.has(o)||nr<=rr.fulfilled.get(o))){rr.fulfilling.add(o);let e=rr.filter.get(o);e=ar(e),t.push(ir({method:"HEAD",url:`api/${n}/?`+N.buildQueryString({filter:Gn(e)}),extract:e=>{if(403===e.status)throw new Error("No est autorizado");if(!e.status)throw new Error("El servidor esta inalcanzable");if(200!==e.status)throw new Error(`Codigo de estado de respuesta no esperado ${e.status}`);return+e.getResponseHeader("x-total-count")},background:!1}).then((e=>{rr.value.set(o,e),rr.fulfilled.set(o,nr),rr.fulfilling.delete(o)})))}}else r.count.delete(s);const n={};for(const[r,s]of Object.entries(sr))for(const[o,i]of s.fetch)if(rr.accessed.get(i)>=e){if(!(rr.fulfilling.has(i)||nr<=rr.fulfilled.get(i))){rr.fulfilling.add(i),n[r]=n[r]||[],n[r].push(i);const e=rr.limit.get(i),s=rr.sort.get(i);if(e){let n=rr.filter.get(i);n=ar(n),t.push(ir({method:"GET",url:`api/${r}/?`+N.buildQueryString({filter:Gn(n),limit:1,skip:e-1,sort:JSON.stringify(s),projection:Object.keys(s).join(",")}),background:!0}).then((e=>{if(e.length){const t=Object.keys(s).reduce(((t,n)=>(null!=e[0][n]&&("object"==typeof e[0][n]?null!=e[0][n].value&&(t[n]=e[0][n].value[0]):t[n]=e[0][n]),t)),{});rr.bookmark.set(i,t)}else rr.bookmark.delete(i)})))}}}else s.fetch.delete(o);Promise.all(t).then((()=>{let e=!1;const t=[];for(const[r,s]of Object.entries(n)){let n=null;for(const e of s){let t=rr.filter.get(e);t=Zn(t,null,nr);const r=rr.bookmark.get(e),s=rr.sort.get(e);r&&(t=cr(t,s,r)),n=at(n,t)}const[o,i]=Qn(sr[r].combinedFilter,n);if(!i){for(const t of s){let n=rr.filter.get(t);n=Zn(n,null,nr);const s=rr.limit.get(t),o=rr.bookmark.get(t),i=rr.sort.get(t);o&&(n=cr(n,i,o)),rr.value.set(t,ur(r,n,i,s)),rr.fulfilled.set(t,nr),rr.fulfilling.delete(t),e=!0}continue}let a=new Set;sr[r].combinedFilter||(a=new Set(sr[r].objects.keys()));const l=i;sr[r].combinedFilter=o,t.push(ir({method:"GET",url:`api/${r}/?`+N.buildQueryString({filter:Gn(l)}),background:!1}).then((e=>{for(const t of e){const e="devices"===r?t["DeviceID.ID"].value[0]:t._id;sr[r].objects.set(e,t),a.delete(e)}for(const e of a){const t=sr[r].objects.get(e);ot(l,t,nr)&&sr[r].objects.delete(e)}for(const e of s){let t=rr.filter.get(e);t=ar(t);const n=rr.limit.get(e),s=rr.bookmark.get(e),o=rr.sort.get(e);s&&(t=cr(t,o,s)),rr.value.set(e,ur(r,t,o,n)),rr.fulfilled.set(e,nr),rr.fulfilling.delete(e)}})))}return e&&N.redraw(),Promise.all(t)})).catch((e=>{mt("error",e.message)}))}(n)},N(Jr,s,r)},onmatch:null};return n.onmatch=(e,n)=>(dr(Date.now()),t.init?new Promise((r=>{t.init(e).then((e=>{e?(ui=e,r()):N.route.set("/")})).catch((e=>{!window.username&&e.message.indexOf("authorized")>=0&&(mt("error",e.message),N.route.set("/login",{continue:n})),ui={error:e.message},r()}))})):(ui=null,null)),n}N.route(document.body,"/overview",{"/wizard":fi("wizard",Vr),"/login":fi("login",fs),"/overview":fi("overview",vs),"/devices":fi("devices",Ms),"/devices/:id":fi("devices",Rs),"/faults":fi("faults",Vs),"/admin":{onmatch:()=>{for(const e of ci)if(window.authorizer.hasAccess(e,2))return N.route.set(`/admin/${e}`),null;return null}},"/admin/presets":fi("presets",uo),"/admin/provisions":fi("provisions",bo),"/admin/virtualParameters":fi("virtualParameters",Do),"/admin/files":fi("files",Mo),"/admin/config":fi("config",Jo),"/admin/users":fi("users",li),"/admin/permissions":fi("permissions",ei)});export{f as a,d as c};
//# sourceMappingURL=app.js.map
